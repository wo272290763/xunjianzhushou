<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巡检助手 - 专业设备巡检管理工具</title>
    
    <!-- 基础描述 -->
    <meta name="description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta name="keywords" content="设备巡检,巡检管理,设备管理,巡检工具">
    
    <!-- 标准OG标签 - 适配Facebook、LinkedIn等 -->
    <meta property="og:title" content="巡检助手 - 专业设备巡检管理工具" />
    <meta property="og:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作" />
    <meta property="og:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg" />
    <meta property="og:image:url" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg" />
    <meta property="og:image:secure_url" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg" />
    <meta property="og:url" content="https://wo272290763.github.io/xunjianzhushou/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="巡检助手" />
    <meta property="og:locale" content="zh_CN" />

    <!-- 图片尺寸声明（适配微信） -->
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/jpeg" />

    <!-- 腾讯系专用标签（QQ/微信） -->
    <meta itemprop="name" content="巡检助手 - 专业设备巡检管理工具">
    <meta itemprop="description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta itemprop="image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">

    <!-- 微信专用补充标签 -->
    <meta property="wechat:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta property="wechat:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta property="wechat:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">
    <meta property="wechat:page_type" content="article">
    <meta property="wechat:site_name" content="巡检助手">

    <!-- 微博专用标签 -->
    <meta property="weibo:webpage" content="article">
    <meta name="weibo:card" content="summary_large_image">
    <meta property="weibo:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta property="weibo:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告">
    <meta property="weibo:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">

    <!-- 百度/头条系标签 -->
    <meta name="baidu:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta name="baidu:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta name="baidu:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="巡检助手 - 设备巡检管理工具">
    <meta name="twitter:description" content="便捷管理设备巡检任务，记录设备状态，生成巡检报告">
    <meta name="twitter:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">
    <meta name="twitter:site" content="@yourtwitterhandle">
    
    <!-- 额外的微信兼容标签 -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用可靠的Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 引入jsQR库用于二维码扫描 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        normal: '#10B981',
                        abnormal: '#EF4444',
                        pending: '#9CA3AF',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                        button: '#4F46E5'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .device-card-shadow {
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .condition-item {
                @apply transition-all duration-300 ease-in-out rounded-lg cursor-pointer;
            }

            .btn-hover-effect {
                @apply transition-all duration-200 transform hover:scale-105 active:scale-95;
            }

            .text-balance {
                text-wrap: balance;
            }

            .hidden {
                display: none;
            }
            
            .preset-btn {
                @apply px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors;
            }
            
            .record-date {
                @apply text-lg font-bold text-gray-700 pb-2 mb-3 border-b border-gray-200 flex items-center justify-between cursor-pointer;
            }
            
            .record-date i {
                @apply transition-transform duration-300;
            }
            
            .icon-btn {
                @apply p-2 rounded-lg bg-white/80 hover:bg-white text-dark transition-colors flex items-center justify-center;
                min-width: 40px;
                min-height: 40px;
            }
            
            .edit-modal-container {
                @apply max-h-[60vh] overflow-y-auto;
            }
            
            /* 添加滚动条样式 */
            .modal-scroll-container {
                @apply max-h-[70vh] overflow-y-auto pr-2;
            }
            
            /* 自定义滚动条 */
            .modal-scroll-container::-webkit-scrollbar {
                width: 6px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 10px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-thumb:hover {
                background: #a1a1a1;
            }
            
            /* 底部导航栏样式 */
            .bottom-nav {
                @apply fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200;
                height: 60px;
                z-index: 40;
            }
            
            .nav-btn {
                @apply flex flex-col items-center justify-center h-full text-xs;
            }
            
            .nav-btn.active {
                @apply text-primary;
            }
            
            .nav-btn i {
                @apply text-xl mb-1;
            }
            
            /* 修复所有按钮尺寸问题 */
            .fixed-size-btn {
                min-width: 40px;
                min-height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            /* 新的迷你卡片进度条样式 */
            .mini-progress-overlay {
                @apply absolute inset-0 z-0 rounded-lg;
                background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.25) var(--progress), transparent var(--progress), transparent 100%);
                transition: background 0.5s ease;
            }
            
            .mini-card-content {
                @apply relative z-10;
            }

            /* 深色模式适配 */
            @media (prefers-color-scheme: dark) {
                .mini-progress-overlay {
                    background: linear-gradient(90deg, rgba(59, 130, 246, 0.4) 0%, rgba(59, 130, 246, 0.4) var(--progress), transparent var(--progress), transparent 100%);
                }
            }
            
            .profile-card-btn {
                @apply w-full py-3 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2;
            }
            
            /* 日期进度条样式 */
            .date-progress-bar {
                @apply w-full bg-gray-200 rounded-full h-1.5 mb-3;
            }
            
            .date-progress-fill {
                @apply bg-primary h-1.5 rounded-full;
            }
            
            /* 搜索栏样式 */
            .search-container {
                @apply bg-white rounded-lg shadow-sm p-3 mb-4 transition-all duration-300;
            }
            
            .search-input {
                @apply w-full px-4 py-2 pl-10 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all;
            }
            
            .search-icon {
                @apply absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400;
            }
            
            .no-results {
                @apply text-center py-8 text-gray-500;
            }
            
            /* 确保所有图标可见 */
            .fa {
                display: inline-block !important;
                font-style: normal !important;
                font-variant: normal !important;
                text-rendering: auto !important;
                -webkit-font-smoothing: antialiased !important;
            }
            
            /* 设备信息网格布局 */
            .device-info-grid {
                @apply grid grid-cols-2 gap-x-2 gap-y-1 text-xs;
            }
            
            .device-info-label {
                @apply text-gray-500;
            }
            
            .device-info-value {
                @apply text-gray-800;
            }

            /* 为展开的卡片添加边框 */
            .expanded-card {
                border: 2px solid rgba(59, 130, 246, 0.5);
            }

            /* 深色模式下调整边框颜色 */
            @media (prefers-color-scheme: dark) {
                .expanded-card {
                    border: 2px solid rgba(96, 165, 250, 0.7);
                }
            }
            
            /* 新增：加载指示器 */
            .loading-spinner {
                @apply inline-block w-4 h-4 border-2 border-solid border-current border-r-transparent rounded-full animate-spin;
            }
            
            /* 新增：长按反馈样式 */
            .condition-item.long-press-active {
                @apply bg-blue-100 border-blue-300;
            }
            
            /* 新增：兼容性样式 */
            .backdrop-blur-support {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            /* 新增：触摸友好的按钮 */
            .touch-button {
                @apply min-h-[44px] min-w-[44px] flex items-center justify-center;
            }
            
            /* 新增：错误提示样式 */
            .error-message {
                @apply text-red-500 text-sm mt-1;
            }
            
            /* 新增：成功提示样式 */
            .success-message {
                @apply text-green-500 text-sm mt-1;
            }
            
            /* 新增：状态指示器 */
            .status-indicator {
                @apply w-2.5 h-2.5 rounded-full mr-1;
            }
            
            .status-pending {
                @apply bg-pending;
            }
            
            .status-normal {
                @apply bg-normal;
            }
            
            .status-abnormal {
                @apply bg-abnormal;
            }

            /* 新增：操作反馈样式 */
            .operation-feedback {
                @apply fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300;
            }
            
            /* 新增：卡片滚动优化 */
            .device-card-scrollable {
                @apply overflow-y-auto;
                max-height: 300px;
            }
            
            /* 新增：预设项目管理样式 */
            .preset-condition-item {
                @apply flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg mb-2;
            }
            
            .preset-condition-text {
                @apply flex-1 text-gray-800;
            }
            
            .preset-condition-actions {
                @apply flex space-x-2;
            }
            
            /* 修复：设备卡片高度自适应，防止被拉伸 */
            .device-card {
                @apply self-start;
            }
            
            /* 新增：设备标题区域 - 用于区分点击区域 */
            .device-header-info {
                @apply flex-1 min-w-0 cursor-pointer;
            }
            
            /* 新增：滑动检测相关样式 */
            .device-card.touch-scrolling {
                @apply transition-none;
            }
            
            /* 新增：图片和定位功能样式 */
            .media-management-bar {
                @apply flex justify-start items-center space-x-4 mt-2 mb-3;
            }
            
            .media-btn {
                @apply flex flex-col items-center justify-center text-gray-600 hover:text-primary transition-colors;
            }
            
            .media-btn i {
                @apply text-lg mb-1;
            }
            
            .media-btn span {
                @apply text-xs;
            }
            
            .location-display {
                @apply text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded;
            }
            
            .device-images-container {
                @apply grid grid-cols-3 gap-2 mt-2;
            }
            
            .device-image-item {
                @apply relative aspect-square rounded overflow-hidden cursor-pointer;
            }
            
            .device-image {
                @apply w-full h-full object-cover;
            }
            
            /* 修复：设备卡片中的图片不显示删除按钮 */
            .device-card .delete-image-btn {
                display: none !important;
            }
            
            /* 图片管理页面中的删除按钮仍然显示 */
            .image-management-modal .delete-image-btn {
                @apply absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs transition-opacity;
                opacity: 1 !important;
            }
            
            .image-management-modal .device-image-item:hover .delete-image-btn {
                @apply opacity-100;
            }
            
            /* 二维码扫描相关样式 */
            .qr-scanner-container {
                @apply relative;
            }
            
            .qr-video {
                @apply w-full h-auto rounded-lg;
            }
            
            .qr-canvas {
                @apply absolute top-0 left-0 w-full h-full;
            }
            
            .qr-overlay {
                @apply absolute top-0 left-0 w-full h-full flex items-center justify-center;
            }
            
            .qr-frame {
                @apply w-48 h-48 border-2 border-primary rounded-lg relative;
            }
            
            .qr-frame::before, .qr-frame::after {
                content: '';
                @apply absolute w-6 h-6 border-primary;
            }
            
            .qr-frame::before {
                @apply top-0 left-0 border-t-2 border-l-2 rounded-tl;
            }
            
            .qr-frame::after {
                @apply bottom-0 right-0 border-b-2 border-r-2 rounded-br;
            }
            
            .qr-result {
                @apply mt-4 p-3 bg-white rounded-lg shadow;
            }
            
            /* 新增：坐标显示样式 */
            .coordinates-container {
                @apply flex items-center space-x-4 mt-2 mb-3;
            }
            
            .coordinates-display {
                @apply text-xs bg-gray-100 px-2 py-1 rounded;
            }
            
            .current-coordinates {
                @apply text-xs px-2 py-1 rounded;
            }
            
            .coordinates-match {
                @apply text-green-600;
            }
            
            .coordinates-mismatch {
                @apply text-red-600;
            }
            
            .coordinates-normal {
                @apply text-gray-600;
            }
            
            .coordinates-label {
                @apply text-xs font-medium mb-1;
            }
            
            /* 新增：巡检记录页面设备框样式 */
            .record-device-box {
                @apply bg-white border border-gray-200 rounded-lg p-2 mb-2;
            }
            
            .record-device-header {
                @apply flex justify-between items-center mb-1;
            }
            
            .record-device-info {
                @apply flex-1;
            }
            
            .record-device-name {
                @apply font-semibold text-gray-900 text-sm;
            }
            
            .record-device-location {
                @apply text-xs text-gray-600 mt-0.5;
            }
            
            .record-device-time {
                @apply text-xs text-gray-500 whitespace-nowrap ml-2;
            }
            
            .record-conditions-row {
                @apply flex flex-wrap gap-1 mt-2;
            }
            
            /* 新增：巡检记录进度条样式 */
            .record-progress-container {
                @apply flex items-center justify-between mb-2;
            }
            
            .record-progress-bar {
                @apply flex-1 bg-gray-200 rounded-full h-1.5 mr-2;
            }
            
            .record-progress-fill {
                @apply bg-primary h-1.5 rounded-full;
            }
            
            .record-progress-text {
                @apply text-xs text-gray-600 whitespace-nowrap;
            }
            
            /* 新增：错误日志相关样式 */
            .error-log-container {
                @apply max-h-60 overflow-y-auto bg-gray-50 rounded-lg p-3 text-xs;
            }
            
            .error-log-item {
                @apply mb-2 pb-2 border-b border-gray-200 last:border-b-0;
            }
            
            .error-log-time {
                @apply text-gray-500 text-xs;
            }
            
            .error-log-message {
                @apply text-red-600 mt-1;
            }

            /* 新增：滑动触发异常状态的样式 */
            .condition-item.swipe-left-active {
                @apply bg-red-100 border-red-300 transform -translate-x-2;
            }
            
            .condition-item.swipe-right-active {
                @apply bg-red-100 border-red-300 transform translate-x-2;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans pb-16">
    <!-- 加载指示器 -->
    <div id="loading-indicator" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-gray-700">加载中...</span>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-4">
        <!-- 顶部标题栏 -->
        <header class="mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-dark flex items-center">
                        <i class="fa-solid fa-clipboard-check text-primary mr-2"></i>
                        巡检助手
                    </h1>
                </div>
                <div class="flex space-x-2" id="top-right-buttons">
                    <button id="add-device-btn" class="icon-btn fixed-size-btn touch-button" title="添加设备">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button id="confirm-all-btn" class="icon-btn fixed-size-btn touch-button" title="确认所有">
                        <i class="fa-solid fa-check"></i>
                    </button>
                    <button id="refresh-all-btn" class="icon-btn fixed-size-btn touch-button" title="刷新所有">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main>
            <!-- 设备列表页面 -->
            <div id="device-list-page">
                <!-- 搜索栏 -->
                <div class="search-container">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="搜索设备名称、编号或位置">
                        <button id="qr-scan-btn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary touch-button">
                            <i class="fa-solid fa-qrcode"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 空状态提示 -->
                <div id="empty-state" class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <i class="fa-solid fa-clipboard-list text-3xl text-gray-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">暂无巡检设备</h2>
                    <p class="text-gray-500 mb-6">点击上方"+"按钮开始创建巡检任务</p>
                    <button id="empty-add-btn"
                        class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-lg font-medium btn-hover-effect touch-button">
                        <i class="fa-solid fa-plus mr-1"></i>添加第一个设备
                    </button>
                </div>

                <!-- 设备列表容器 -->
                <div id="devices-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- 设备卡片由JS动态生成 -->
                </div>
            </div>

            <!-- 巡检记录页面 -->
            <div id="inspection-records-page" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">巡检记录</h2>
                    <button id="toggle-all-records" class="text-sm text-primary hover:text-primary/80 touch-button">
                        <i class="fa-solid fa-angle-double-down mr-1"></i>展开/收起所有
                    </button>
                </div>
                <div id="inspection-records">
                    <!-- 巡检记录由JS动态生成 -->
                </div>
            </div>

            <!-- 数据管理页面 -->
            <div id="data-management-page" class="hidden">
                <div class="text-center py-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <i class="fa-solid fa-database text-3xl text-gray-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">数据管理</h2>
                </div>
                
                <!-- 警告提示 -->
                <div class="max-w-md mx-auto bg-yellow-50 border border-yellow-200 rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex items-start">
                        <i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-0.5 mr-3"></i>
                        <div class="text-left">
                            <h3 class="font-semibold text-yellow-800 mb-1">重要提醒</h3>
                            <p class="text-yellow-700 text-sm">此页面涉及设备和记录数据，请谨慎操作！</p>
                        </div>
                    </div>
                </div>
                
                <div class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6 mb-8">
                    <!-- 数据操作按钮 -->
                    <div class="space-y-4">
                        <button id="data-export-btn" class="profile-card-btn bg-blue-500 text-white touch-button">
                            <i class="fa-solid fa-download"></i>
                            导出数据
                        </button>
                        <button id="data-import-btn" class="profile-card-btn bg-blue-500 text-white touch-button">
                            <i class="fa-solid fa-upload"></i>
                            导入数据
                        </button>
                        <button id="preset-conditions-btn" class="profile-card-btn bg-green-500 text-white touch-button">
                            <i class="fa-solid fa-list-check"></i>
                            预设巡检项目
                        </button>
                        <button id="view-error-log-btn" class="profile-card-btn bg-orange-500 text-white touch-button">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            查看错误日志
                        </button>
                        <!-- 新增：定位偏离范围设置 -->
                        <div class="bg-purple-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">定位偏离范围设置</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="location-deviation-range" min="1" max="1000" 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                    placeholder="输入偏离范围（米）">
                                <span class="text-sm text-gray-600 whitespace-nowrap">米</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">设置坐标匹配的允许偏离范围</p>
                            <button id="save-deviation-range-btn" class="w-full mt-2 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 btn-hover-effect touch-button">
                                <i class="fa-solid fa-save mr-1"></i>保存设置
                            </button>
                        </div>
                        <button id="data-delete-all-btn" class="profile-card-btn bg-red-500 text-white touch-button">
                            <i class="fa-solid fa-trash"></i>
                            删除所有设备
                        </button>
                        <button id="data-reset-app-btn" class="profile-card-btn bg-red-600 text-white touch-button">
                            <i class="fa-solid fa-broom"></i>
                            重置软件
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="max-w-6xl mx-auto h-full flex justify-around">
            <button id="nav-device-list" class="nav-btn active touch-button" data-page="device-list-page">
                <i class="fa-solid fa-list"></i>
                <span>设备列表</span>
            </button>
            <button id="nav-records" class="nav-btn touch-button" data-page="inspection-records-page">
                <i class="fa-solid fa-history"></i>
                <span>巡检记录</span>
            </button>
            <button id="nav-data-management" class="nav-btn touch-button" data-page="data-management-page">
                <i class="fa-solid fa-database"></i>
                <span>数据管理</span>
            </button>
        </div>
    </div>

    <!-- 添加设备模态框 -->
    <div id="add-device-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">添加巡检设备</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <form id="add-device-form" onsubmit="return false;">
                        <div class="mb-4">
                            <label for="device-name" class="block text-sm font-medium text-gray-700 mb-1">设备名称 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="device-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入设备名称" required>
                            <div id="device-name-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="device-category" class="block text-sm font-medium text-gray-700 mb-1">类别</label>
                            <select id="device-category"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                <option value="">请选择类别</option>
                                <option value="A类">A类</option>
                                <option value="B类">B类</option>
                                <option value="C类">C类</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="device-location" class="block text-sm font-medium text-gray-700 mb-1">安装地点 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="device-location"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入安装地点" required>
                            <div id="device-location-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">安装坐标</label>
                            <div class="flex space-x-2">
                                <input type="text" id="device-install-latitude"
                                    class="w-2/5 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                    placeholder="纬度">
                                <input type="text" id="device-install-longitude"
                                    class="w-2/5 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                    placeholder="经度">
                                <button type="button" id="get-current-location-btn" class="w-1/5 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">
                                    <i class="fa-solid fa-location-dot"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">安装坐标用于定位比对，非必填项</p>
                        </div>
                        <div class="mb-4">
                            <label for="device-model" class="block text-sm font-medium text-gray-700 mb-1">规格型号</label>
                            <input type="text" id="device-model"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入规格型号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="device-manufacturer" class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="device-manufacturer"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入生产厂家（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="device-serial-number" class="block text-sm font-medium text-gray-700 mb-1">出厂编号</label>
                            <input type="text" id="device-serial-number"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入出厂编号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="inspection-cycle" class="block text-sm font-medium text-gray-700 mb-1">检定周期（月）</label>
                            <input type="number" id="inspection-cycle" min="1" max="60"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入检定周期（月）">
                        </div>
                        <div class="mb-4">
                            <label for="device-range" class="block text-sm font-medium text-gray-700 mb-1">测量范围</label>
                            <input type="text" id="device-range"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入测量范围（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="last-inspection-date" class="block text-sm font-medium text-gray-700 mb-1">上次检定日期</label>
                            <input type="date" id="last-inspection-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">巡检项目 <span
                                    class="text-red-500">*</span></label>
                            <div id="conditions-container">
                                <div class="condition-item mb-3 flex items-center">
                                    <input type="text"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                        required>
                                    <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                                        <i class="fa-solid fa-minus-circle"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 预设项目快速添加 -->
                            <div class="mt-2 mb-3">
                                <p class="text-xs text-gray-500 mb-2">点击添加预设项目：</p>
                                <div id="preset-conditions-buttons" class="flex flex-wrap gap-2">
                                    <!-- 预设项目按钮由JS动态生成 -->
                                </div>
                            </div>
                            
                            <button type="button" id="add-condition-btn"
                                class="mt-2 text-primary hover:text-primary/80 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-plus-circle mr-1"></i> 添加自定义项目
                            </button>
                            <p class="text-xs text-gray-500 mt-2">可添加1-5个巡检项目</p>
                            <div id="conditions-error" class="error-message hidden"></div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="cancel-add-device"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                            <button type="button" id="submit-add-device"
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 异常备注模态框 -->
    <div id="remark-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="remark-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">异常备注</h3>
                    <button id="close-remark-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <form id="remark-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="condition-name" class="block text-sm font-medium text-gray-700 mb-1">巡检项目</label>
                        <input type="text" id="condition-name"
                            class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg" readonly>
                    </div>
                    <div class="mb-6">
                        <label for="remark-content" class="block text-sm font-medium text-gray-700 mb-1">异常描述 <span
                                class="text-red-500">*</span></label>
                        <textarea id="remark-content" rows="4"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                            placeholder="请描述异常情况" required></textarea>
                        <div id="remark-content-error" class="error-message hidden"></div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancel-remark"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                        <button type="button" id="submit-remark"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑设备模态框 -->
    <div id="edit-device-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="edit-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">编辑巡检设备</h3>
                    <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <form id="edit-device-form" onsubmit="return false;">
                        <input type="hidden" id="edit-device-index">
                        <div class="mb-4">
                            <label for="edit-device-name" class="block text-sm font-medium text-gray-700 mb-1">设备名称 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="edit-device-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入设备名称" required>
                            <div id="edit-device-name-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-category" class="block text-sm font-medium text-gray-700 mb-1">类别</label>
                            <select id="edit-device-category"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                <option value="">请选择类别</option>
                                <option value="A类">A类</option>
                                <option value="B类">B类</option>
                                <option value="C类">C类</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-location" class="block text-sm font-medium text-gray-700 mb-1">安装地点 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="edit-device-location"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入安装地点" required>
                            <div id="edit-device-location-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">安装坐标</label>
                            <div class="flex space-x-2">
                                <input type="text" id="edit-device-install-latitude"
                                    class="w-2/5 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                    placeholder="纬度">
                                <input type="text" id="edit-device-install-longitude"
                                    class="w-2/5 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                    placeholder="经度">
                                <button type="button" id="edit-get-current-location-btn" class="w-1/5 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">
                                    <i class="fa-solid fa-location-dot"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">安装坐标用于定位比对，非必填项</p>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-model" class="block text-sm font-medium text-gray-700 mb-1">规格型号</label>
                            <input type="text" id="edit-device-model"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入规格型号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-manufacturer" class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="edit-device-manufacturer"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入生产厂家（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-serial-number" class="block text-sm font-medium text-gray-700 mb-1">出厂编号</label>
                            <input type="text" id="edit-device-serial-number"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入出厂编号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-inspection-cycle" class="block text-sm font-medium text-gray-700 mb-1">检定周期（月）</label>
                            <input type="number" id="edit-inspection-cycle" min="1" max="60"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入检定周期（月）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-range" class="block text-sm font-medium text-gray-700 mb-1">测量范围</label>
                            <input type="text" id="edit-device-range"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入测量范围（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-last-inspection-date" class="block text-sm font-medium text-gray-700 mb-1">上次检定日期</label>
                            <input type="date" id="edit-last-inspection-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">巡检项目 <span
                                    class="text-red-500">*</span></label>
                            <div id="edit-conditions-container"></div>
                            
                            <!-- 预设项目快速添加 -->
                            <div class="mt-2 mb-3">
                                <p class="text-xs text-gray-500 mb-2">点击添加预设项目：</p>
                                <div id="edit-preset-conditions-buttons" class="flex flex-wrap gap-2">
                                    <!-- 预设项目按钮由JS动态生成 -->
                                </div>
                            </div>
                            
                            <button type="button" id="edit-add-condition-btn"
                                class="mt-2 text-primary hover:text-primary/80 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-plus-circle mr-1"></i> 添加自定义项目
                            </button>
                            <p class="text-xs text-gray-500 mt-2">可添加1-5个巡检项目</p>
                            <div id="edit-conditions-error" class="error-message hidden"></div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="delete-device-btn"
                                class="px-4 py-2 border border-red-500 text-red-500 rounded-lg mr-3 hover:bg-red-50 btn-hover-effect touch-button">删除设备</button>
                            <button type="button" id="cancel-edit-device"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                            <button type="button" id="submit-edit-device"
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预设巡检项目管理模态框 -->
    <div id="preset-conditions-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="preset-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">预设巡检项目管理</h3>
                    <button id="close-preset-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">预设项目列表</label>
                            <button id="add-preset-condition-btn" class="text-primary hover:text-primary/80 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-plus-circle mr-1"></i> 添加项目
                            </button>
                        </div>
                        <div id="preset-conditions-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- 预设项目列表由JS动态生成 -->
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancel-preset"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                        <button type="button" id="save-preset-conditions"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 二维码扫描模态框 -->
    <div id="qr-scan-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="qr-scan-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">扫描二维码</h3>
                    <button id="close-qr-scan-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="qr-scanner-container">
                    <video id="qr-video" class="qr-video" playsinline></video>
                    <canvas id="qr-canvas" class="qr-canvas hidden"></canvas>
                    <div class="qr-overlay">
                        <div class="qr-frame"></div>
                    </div>
                </div>
                <div id="qr-result" class="qr-result hidden">
                    <p class="text-sm">扫描结果: <span id="qr-result-text"></span></p>
                </div>
                <div class="flex justify-between mt-4">
                    <button id="switch-camera-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 btn-hover-effect touch-button">
                        <i class="fa-solid fa-camera-rotate mr-1"></i> 切换摄像头
                    </button>
                    <button id="upload-qr-image-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">
                        <i class="fa-solid fa-image mr-1"></i> 上传图片
                    </button>
                </div>
                <input type="file" id="qr-image-input" accept="image/*" class="hidden">
            </div>
        </div>
    </div>
    
    <!-- 图片管理模态框 -->
    <div id="image-management-modal" class="image-management-modal fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="image-management-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">设备图片管理</h3>
                    <button id="close-image-management-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <div class="flex space-x-2 mb-3">
                        <button id="add-image-from-gallery" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 btn-hover-effect touch-button">
                            <i class="fa-solid fa-image mr-1"></i> 从相册选择
                        </button>
                        <button id="take-photo-btn" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 btn-hover-effect touch-button">
                            <i class="fa-solid fa-camera mr-1"></i> 拍照
                        </button>
                    </div>
                    <input type="file" id="image-file-input" accept="image/*" multiple class="hidden">
                </div>
                <div class="device-images-container" id="device-images-list">
                    <!-- 设备图片由JS动态生成 -->
                </div>
                <div class="flex justify-end mt-4">
                    <button id="close-image-management" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">完成</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 拍照模态框 -->
    <div id="camera-modal" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-50 hidden">
        <div class="relative w-full max-w-md">
            <video id="camera-preview" class="w-full h-auto" autoplay playsinline></video>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center space-x-4">
                <button id="capture-btn" class="bg-white rounded-full p-4 touch-button">
                    <i class="fa-solid fa-camera text-2xl text-gray-800"></i>
                </button>
                <button id="close-camera" class="bg-white rounded-full p-4 touch-button">
                    <i class="fa-solid fa-times text-2xl text-gray-800"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 图片预览模态框 -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-full">
            <button id="close-image-preview" class="absolute top-4 right-4 text-white text-2xl z-10 touch-button">
                <i class="fa-solid fa-times"></i>
            </button>
            <img id="preview-image" class="max-w-full max-h-full object-contain" src="" alt="预览图片">
        </div>
    </div>
    
    <!-- 错误日志模态框 -->
    <div id="error-log-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="error-log-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">错误日志</h3>
                    <button id="close-error-log-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-medium text-gray-700">错误记录</label>
                            <button id="clear-error-log-btn" class="text-red-500 hover:text-red-700 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-trash mr-1"></i> 清空日志
                            </button>
                        </div>
                        <div id="error-log-list" class="error-log-container">
                            <!-- 错误日志由JS动态生成 -->
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button id="close-error-log" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 文件导入输入 -->
    <input type="file" id="file-import" accept=".txt" class="hidden">

    <script>
        // 存储所有设备数据
        let devices = [];
        let presetConditions = ['外观', '检定标签', '显示情况', '接地', '上限标识']; // 默认预设项目
        let currentDeviceId = null;
        let currentConditionIndex = null;
        let expandedDates = {}; // 存储展开状态的日期
        let expandedCardIndex = -1; // 当前展开的卡片索引，-1表示没有展开
        let searchTerm = ''; // 搜索关键词
        let searchTimeout = null; // 搜索防抖定时器
        let renderTimeout = null; // 渲染防抖定时器
        
        // 滑动检测相关变量 - 修复误触问题
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isScrolling = false;
        let isHorizontalSwipe = false; // 新增：标记是否为水平滑动
        let touchStartTime = 0;
        const SWIPE_THRESHOLD = 30; // 水平滑动阈值
        const TAP_THRESHOLD = 200; // 点击时间阈值，超过这个时间认为是长按
        const VERTICAL_SCROLL_THRESHOLD = 10; // 垂直滚动阈值
        const CLICK_THRESHOLD = 5; // 点击移动阈值，小于这个值认为是点击
        let lastSwipeTime = 0; // 记录最后一次滑动结束的时间

        // 二维码扫描相关变量
        let qrStream = null;
        let currentFacingMode = 'environment'; // 默认使用后置摄像头
        let qrScanning = false;

        // 图片管理相关变量
        let currentImageDeviceIndex = -1;
        let currentCameraStream = null;

        // 错误日志
        let errorLogs = [];

        // 新增：定位偏离范围变量（默认15米）
        let locationDeviationRange = 15;

        // DOM元素
        let devicesContainer, emptyState, addDeviceBtn, emptyAddBtn, addDeviceModal, modalContent;
        let closeModal, addDeviceForm, conditionsContainer, addConditionBtn, cancelAddDevice;
        let remarkModal, remarkModalContent, closeRemarkModal, remarkForm, conditionNameInput;
        let remarkContentInput, cancelRemark;
        let submitAddDeviceBtn, submitRemarkBtn;
        let refreshAllBtn, editDeviceModal, editModalContent, closeEditModal, editDeviceForm;
        let editDeviceIndexInput, editDeviceNameInput, editDeviceCategoryInput, editDeviceLocationInput;
        let editDeviceModelInput, editDeviceManufacturerInput, editDeviceSerialNumberInput;
        let editDeviceRangeInput, editInspectionCycleInput, editLastInspectionDateInput;
        let editConditionsContainer, editAddConditionBtn, deleteDeviceBtn, cancelEditDevice;
        let submitEditDeviceBtn;
        let inspectionRecordsContainer, toggleAllRecordsBtn;
        let fileImportInput;
        let navDeviceListBtn, navRecordsBtn, navDataManagementBtn;
        let deviceListPage, inspectionRecordsPage, dataManagementPage;
        let dataExportBtn, dataImportBtn, presetConditionsBtn, dataDeleteAllBtn, dataResetAppBtn;
        let topRightButtons; // 新增：顶部右侧按钮容器
        let searchInput; // 新增：搜索输入框
        let confirmAllBtn; // 新增：确认所有按钮
        let loadingIndicator; // 新增：加载指示器
        let presetConditionsModal, presetModalContent, closePresetModal, presetConditionsList;
        let addPresetConditionBtn, savePresetConditionsBtn, cancelPresetBtn;
        let presetConditionsButtons, editPresetConditionsButtons; // 预设项目按钮容器
        let qrScanBtn, qrScanModal, qrScanModalContent, closeQrScanModal, qrVideo, qrCanvas;
        let qrResult, qrResultText, switchCameraBtn, uploadQrImageBtn, qrImageInput;
        let imageManagementModal, imageManagementModalContent, closeImageManagementModal;
        let addImageFromGallery, takePhotoBtn, imageFileInput, deviceImagesList;
        let closeImageManagement, imagePreviewModal, closeImagePreview, previewImage;
        let cameraModal, cameraPreview, captureBtn, closeCamera; // 新增拍照模态框元素
        let viewErrorLogBtn, errorLogModal, errorLogModalContent, closeErrorLogModal, errorLogList, clearErrorLogBtn, closeErrorLog; // 错误日志相关元素
        
        // 新增：坐标相关DOM元素
        let deviceInstallLatitudeInput, deviceInstallLongitudeInput, getCurrentLocationBtn;
        let editDeviceInstallLatitudeInput, editDeviceInstallLongitudeInput, editGetCurrentLocationBtn;
        
        // 新增：定位偏离范围相关DOM元素
        let locationDeviationRangeInput, saveDeviationRangeBtn;

        // ========== 性能优化改进 ==========
        // 优化渲染性能
        const PerformanceManager = {
            // 增加防抖时间，减少渲染频率
            debounce(func, wait = 150, immediate = false) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        timeout = null;
                        if (!immediate) func(...args);
                    };
                    const callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func(...args);
                };
            },

            // 节流函数
            throttle(func, limit = 100) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },

            // 优化图片处理
            optimizeImage(imageData, maxWidth = 800) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 计算缩放比例
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = imageData;
                });
            }
        };

        // ========== 日期工具 ==========
        const DateUtils = {
            // 安全的日期计算
            addMonthsToDate(dateStr, months) {
                if (!dateStr || !this.isValidDate(dateStr)) return '日期无效';
                
                const date = new Date(dateStr);
                const originalDate = date.getDate();
                
                date.setMonth(date.getMonth() + months);
                
                // 处理月份溢出（如1月31日+1个月）
                if (date.getDate() !== originalDate) {
                    // 如果日期变了，说明是无效日期，设置为上月最后一天
                    date.setDate(0);
                }
                
                return this.formatDate(date);
            },

            // 安全的日期格式化
            formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) {
                    console.warn('无效的日期对象:', date);
                    return '0000-00-00';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            // 验证日期字符串
            isValidDate(dateStr) {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                return date instanceof Date && !isNaN(date) && dateStr.match(/^\d{4}-\d{2}-\d{2}$/);
            },

            // 获取下一个检定日期
            getNextInspectionDate(lastInspectionDate, inspectionCycle) {
                if (!this.isValidDate(lastInspectionDate)) {
                    console.warn('无效的上次检定日期:', lastInspectionDate);
                    return '日期无效';
                }
                
                try {
                    return this.addMonthsToDate(lastInspectionDate, inspectionCycle);
                } catch (error) {
                    console.error('计算下次检定日期失败:', error);
                    return '计算失败';
                }
            },

            // 检查是否在指定天数内
            isWithinDays(dateStr, days) {
                if (!this.isValidDate(dateStr)) return false;
                
                const targetDate = new Date(dateStr);
                const now = new Date();
                const diffTime = targetDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= days && diffDays >= 0;
            }
        };

        // ========== 坐标工具 ==========
        const CoordinateUtils = {
            // 计算两点之间的距离（米）- 使用Haversine公式
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // 地球半径（米）
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            },

            // 验证坐标格式
            isValidCoordinate(lat, lon) {
                return lat && lon && 
                       !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon)) &&
                       Math.abs(parseFloat(lat)) <= 90 && 
                       Math.abs(parseFloat(lon)) <= 180;
            },

            // 格式化坐标显示
            formatCoordinate(coord, precision = 6) {
                if (!coord || isNaN(parseFloat(coord))) return '--';
                return parseFloat(coord).toFixed(precision);
            }
        };

        // ========== 状态管理器 ==========
        const StatusManager = {
            // 统一获取设备状态 - 修复：正确计算进度
            getDeviceStatus(device) {
                const today = getCurrentDate();
                let normalCount = 0;
                let abnormalCount = 0;
                let lastInspectionTime = null;

                device.conditions.forEach(condition => {
                    // 检查当天是否有巡检记录 - 修复：同时检查当前状态和历史记录
                    const isToday = condition.inspectionTime && condition.inspectionTime.startsWith(today);
                    const hasHistoryToday = condition.history && condition.history.some(h => h.date === today);
                    
                    if (isToday || hasHistoryToday) {
                        if (condition.status === 'normal') normalCount++;
                        if (condition.status === 'abnormal') abnormalCount++;
                    }

                    // 更新最后巡检时间 - 修复时间显示问题
                    if (condition.inspectionTime) {
                        const conditionTime = new Date(condition.inspectionTime);
                        if (!lastInspectionTime || conditionTime > lastInspectionTime) {
                            lastInspectionTime = conditionTime;
                        }
                    }
                    
                    // 同时检查历史记录中的时间
                    if (condition.history && condition.history.length > 0) {
                        condition.history.forEach(record => {
                            if (record.inspectionTime) {
                                const recordTime = new Date(record.inspectionTime);
                                if (!lastInspectionTime || recordTime > lastInspectionTime) {
                                    lastInspectionTime = recordTime;
                                }
                            }
                        });
                    }
                });

                const totalCount = device.conditions.length;
                const pendingCount = totalCount - normalCount - abnormalCount;
                const progress = totalCount > 0 ? Math.round((normalCount + abnormalCount) / totalCount * 100) : 0;

                return {
                    normal: normalCount,
                    abnormal: abnormalCount,
                    pending: pendingCount,
                    total: totalCount,
                    progress: progress,
                    lastInspectionTime: lastInspectionTime,
                    isFullyCompleted: (normalCount + abnormalCount) === totalCount
                };
            },

            // 统一获取条件显示状态 - 修复历史记录显示问题
            getConditionDisplay(condition, date = null) {
                const today = getCurrentDate();
                const targetDate = date || today;
                
                // 检查是否有历史记录
                let historyRecord = null;
                if (condition.history && condition.history.length > 0) {
                    historyRecord = condition.history.find(h => h.date === targetDate);
                }
                
                let displayStatus, timeDisplay, isToday;
                
                if (historyRecord) {
                    // 有历史记录，使用历史记录的状态
                    displayStatus = historyRecord.status;
                    timeDisplay = historyRecord.inspectionTime ? historyRecord.inspectionTime.split(' ')[1]?.substr(0, 5) : '';
                    isToday = targetDate === today;
                } else {
                    // 没有历史记录，检查当前状态
                    const isTodayInspection = condition.inspectionTime && condition.inspectionTime.startsWith(today);
                    displayStatus = isTodayInspection ? condition.status : 'pending';
                    timeDisplay = isTodayInspection ? (condition.inspectionTime.split(' ')[1]?.substr(0, 5) || '') : '';
                    isToday = targetDate === today;
                }

                const statusConfig = {
                    normal: {
                        statusClass: 'status-normal',
                        className: 'bg-green-50',
                        borderColor: 'border-green-100',
                        textColor: 'text-green-800'
                    },
                    abnormal: {
                        statusClass: 'status-abnormal',
                        className: 'bg-red-50',
                        borderColor: 'border-red-100',
                        textColor: 'text-red-800'
                    },
                    pending: {
                        statusClass: 'status-pending',
                        className: 'bg-gray-50',
                        borderColor: 'border-gray-100',
                        textColor: 'text-gray-800'
                    }
                };

                const config = statusConfig[displayStatus];

                return {
                    status: displayStatus,
                    ...config,
                    timeDisplay: timeDisplay,
                    isToday: isToday,
                    historyRecord: historyRecord
                };
            },

            // 统一获取最后巡检信息 - 修复时间显示问题
            getLastInspectionDisplay(device) {
                const today = getCurrentDate();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = DateUtils.formatDate(yesterday);
                
                const status = this.getDeviceStatus(device);
                
                if (!status.lastInspectionTime) {
                    return {
                        date: '暂无',
                        time: '巡检',
                        colorClass: 'text-red-600'
                    };
                }

                const lastTime = status.lastInspectionTime;
                const isToday = lastTime.toDateString() === new Date().toDateString();
                const isYesterday = lastTime.toDateString() === yesterday.toDateString();
                
                const month = String(lastTime.getMonth() + 1).padStart(2, '0');
                const day = String(lastTime.getDate()).padStart(2, '0');
                const hours = String(lastTime.getHours()).padStart(2, '0');
                const minutes = String(lastTime.getMinutes()).padStart(2, '0');

                let dateDisplay, colorClass;
                
                if (isToday) {
                    dateDisplay = '今日';
                    colorClass = 'text-green-600';
                } else if (isYesterday) {
                    dateDisplay = '昨日';
                    colorClass = 'text-orange-600';
                } else {
                    dateDisplay = `${month}.${day}`;
                    colorClass = 'text-blue-600';
                }

                return {
                    date: dateDisplay,
                    time: `${hours}:${minutes}`,
                    colorClass: colorClass
                };
            }
        };

        // ========== 错误日志管理器 ==========
        const ErrorLogger = {
            // 记录错误
            logError(message, error = null) {
                const timestamp = new Date().toISOString();
                const errorEntry = {
                    timestamp: timestamp,
                    message: message,
                    error: error ? error.toString() : null,
                    stack: error && error.stack ? error.stack : null
                };
                
                errorLogs.push(errorEntry);
                
                // 保存到本地存储
                this.saveErrorLogs();
                
                console.error('错误记录:', errorEntry);
            },
            
            // 保存错误日志到本地存储
            saveErrorLogs() {
                try {
                    localStorage.setItem('error_logs', JSON.stringify(errorLogs));
                } catch (error) {
                    console.error('保存错误日志失败:', error);
                }
            },
            
            // 加载错误日志
            loadErrorLogs() {
                try {
                    const savedLogs = localStorage.getItem('error_logs');
                    if (savedLogs) {
                        errorLogs = JSON.parse(savedLogs);
                    }
                } catch (error) {
                    console.error('加载错误日志失败:', error);
                    errorLogs = [];
                }
            },
            
            // 清空错误日志
            clearErrorLogs() {
                errorLogs = [];
                this.saveErrorLogs();
            },
            
            // 获取错误日志
            getErrorLogs() {
                return errorLogs.slice().reverse(); // 返回倒序排列的日志
            }
        };

        // ========== 数据管理器 ==========
        const DataManager = {
            // 改进的加载函数
            loadDevices() {
                try {
                    const savedDevices = localStorage.getItem('inspection_devices');
                    if (savedDevices) {
                        const parsedDevices = JSON.parse(savedDevices);
                        // 数据迁移和兼容性处理
                        devices = this.migrateDeviceData(parsedDevices);
                        console.log(`从本地存储加载了 ${devices.length} 个设备`);
                    } else {
                        console.log('本地存储中没有设备数据');
                        devices = [];
                    }
                    
                    // 加载预设项目
                    this.loadPresetConditions();
                    
                    // 加载错误日志
                    ErrorLogger.loadErrorLogs();
                    
                    // 加载定位偏离范围设置
                    this.loadLocationDeviationRange();
                } catch (error) {
                    console.error('加载设备数据失败:', error);
                    ErrorLogger.logError('加载设备数据失败', error);
                    // 尝试恢复数据
                    devices = this.tryRecoverData();
                }
            },
            
            // 加载预设巡检项目
            loadPresetConditions() {
                try {
                    const savedPresets = localStorage.getItem('preset_conditions');
                    if (savedPresets) {
                        presetConditions = JSON.parse(savedPresets);
                        console.log(`从本地存储加载了 ${presetConditions.length} 个预设项目`);
                    } else {
                        // 使用默认预设项目
                        presetConditions = ['外观', '检定标签', '显示情况', '接地', '上限标识'];
                        this.savePresetConditions();
                    }
                } catch (error) {
                    console.error('加载预设项目失败:', error);
                    ErrorLogger.logError('加载预设项目失败', error);
                    presetConditions = ['外观', '检定标签', '显示情况', '接地', '上限标识'];
                }
            },
            
            // 保存预设巡检项目
            savePresetConditions() {
                try {
                    localStorage.setItem('preset_conditions', JSON.stringify(presetConditions));
                    console.log(`已保存 ${presetConditions.length} 个预设项目到本地存储`);
                } catch (error) {
                    console.error('保存预设项目失败:', error);
                    ErrorLogger.logError('保存预设项目失败', error);
                    throw error;
                }
            },
            
            // 加载定位偏离范围设置
            loadLocationDeviationRange() {
                try {
                    const savedRange = localStorage.getItem('location_deviation_range');
                    if (savedRange) {
                        locationDeviationRange = parseInt(savedRange);
                        console.log(`从本地存储加载了定位偏离范围: ${locationDeviationRange}米`);
                    } else {
                        // 使用默认值15米
                        locationDeviationRange = 15;
                        this.saveLocationDeviationRange();
                    }
                } catch (error) {
                    console.error('加载定位偏离范围失败:', error);
                    ErrorLogger.logError('加载定位偏离范围失败', error);
                    locationDeviationRange = 15;
                }
            },
            
            // 保存定位偏离范围设置
            saveLocationDeviationRange() {
                try {
                    localStorage.setItem('location_deviation_range', locationDeviationRange.toString());
                    console.log(`已保存定位偏离范围: ${locationDeviationRange}米到本地存储`);
                } catch (error) {
                    console.error('保存定位偏离范围失败:', error);
                    ErrorLogger.logError('保存定位偏离范围失败', error);
                    throw error;
                }
            },

            // 数据迁移：确保新版本兼容旧数据
            migrateDeviceData(parsedDevices) {
                return parsedDevices.map(device => {
                    // 确保所有必要字段都存在
                    return {
                        id: device.id || this.generateDeviceId(device),
                        name: device.name || '未命名设备',
                        category: device.category || '未分类',
                        location: device.location || '未知位置',
                        installCoordinates: device.installCoordinates || { // 新增安装坐标字段
                            latitude: '',
                            longitude: ''
                        },
                        model: device.model || '',
                        manufacturer: device.manufacturer || '',
                        serialNumber: device.serialNumber || '',
                        range: device.range || '',
                        lastInspectionDate: device.lastInspectionDate || new Date().toISOString().split('T')[0],
                        inspectionCycle: device.inspectionCycle || 12,
                        conditions: (device.conditions || []).map(condition => ({
                            id: condition.id || this.generateConditionId(condition),
                            name: condition.name || '未命名项目',
                            status: condition.status || 'pending',
                            remark: condition.remark || '',
                            inspectionTime: condition.inspectionTime || '',
                            history: condition.history || []
                        })),
                        images: device.images || [], // 新增图片字段
                        locationData: device.locationData || null, // 新增定位数据字段
                        createdAt: device.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                });
            },

            // 生成设备ID
            generateDeviceId(device) {
                return `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            },

            // 生成条件ID
            generateConditionId(condition) {
                return `condition_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            },

            // 数据恢复尝试
            tryRecoverData() {
                try {
                    // 尝试从备份恢复
                    const backup = localStorage.getItem('inspection_devices_backup');
                    if (backup) {
                        return JSON.parse(backup);
                    }
                } catch (e) {
                    console.error('恢复备份失败:', e);
                    ErrorLogger.logError('恢复备份失败', e);
                }
                return [];
            },

            // 创建数据备份
            createBackup() {
                try {
                    localStorage.setItem('inspection_devices_backup', JSON.stringify(devices));
                    console.log('数据备份已创建');
                } catch (error) {
                    console.error('创建备份失败:', error);
                    ErrorLogger.logError('创建备份失败', error);
                }
            },

            // 统一更新条件状态 - 修复点击问题
            updateCondition(deviceIndex, conditionIndex, status, remark = '') {
                const condition = devices[deviceIndex].conditions[conditionIndex];
                const oldStatus = condition.status;
                const today = getCurrentDate();
                
                // 修复：确保状态正确更新
                condition.status = status;
                condition.remark = remark;
                
                // 只有在状态变化时更新时间戳
                if (status !== 'pending' && oldStatus !== status) {
                    condition.inspectionTime = getCurrentDateTime();
                    
                    // 保存到历史记录
                    this.saveToHistory(condition, today);
                } else if (status === 'pending') {
                    condition.inspectionTime = '';
                    condition.remark = '';
                    // 从历史记录中移除今天的记录
                    if (condition.history) {
                        condition.history = condition.history.filter(record => record.date !== today);
                    }
                }

                console.log(`更新条件状态: 设备=${deviceIndex}, 条件=${conditionIndex}, 状态=${status}`);
                
                // 自动保存
                this.saveDevices();
                return true;
            },

            // 保存到历史记录 - 修复历史记录保存
            saveToHistory(condition, date = null) {
                const today = date || getCurrentDate();
                if (!condition.history) condition.history = [];
                
                // 检查是否已有今天的历史记录
                const existingIndex = condition.history.findIndex(h => h.date === today);
                const historyRecord = {
                    date: today,
                    status: condition.status,
                    remark: condition.remark,
                    inspectionTime: condition.inspectionTime
                };

                if (existingIndex !== -1) {
                    condition.history[existingIndex] = historyRecord;
                } else {
                    condition.history.push(historyRecord);
                }
            },

            // 统一保存设备数据
            saveDevices() {
                try {
                    localStorage.setItem('inspection_devices', JSON.stringify(devices));
                    console.log(`已保存 ${devices.length} 个设备到本地存储`);
                } catch (error) {
                    console.error('保存设备数据失败:', error);
                    ErrorLogger.logError('保存设备数据失败', error);
                    if (error.name === 'QuotaExceededError') {
                        this.cleanupOldData();
                    }
                    throw error;
                }
            },

            // 清理旧数据
            cleanupOldData() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                devices.forEach(device => {
                    device.conditions.forEach(condition => {
                        if (condition.history) {
                            condition.history = condition.history.filter(record => 
                                new Date(record.date) >= thirtyDaysAgo
                            );
                        }
                    });
                });
                
                this.saveDevices();
                console.log('已清理30天前的历史数据');
            },
            
            // 添加设备图片
            async addDeviceImage(deviceIndex, imageData) {
                if (!devices[deviceIndex].images) {
                    devices[deviceIndex].images = [];
                }
                
                // 优化图片大小
                const optimizedImageData = await PerformanceManager.optimizeImage(imageData);
                
                const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                devices[deviceIndex].images.push({
                    id: imageId,
                    data: optimizedImageData,
                    timestamp: new Date().toISOString()
                });
                
                this.saveDevices();
                return imageId;
            },
            
            // 删除设备图片
            removeDeviceImage(deviceIndex, imageId) {
                if (!devices[deviceIndex].images) return false;
                
                devices[deviceIndex].images = devices[deviceIndex].images.filter(img => img.id !== imageId);
                this.saveDevices();
                return true;
            },
            
            // 更新设备定位数据
            updateDeviceLocation(deviceIndex, locationData) {
                devices[deviceIndex].locationData = locationData;
                this.saveDevices();
                return true;
            },
            
            // 更新设备安装坐标
            updateDeviceInstallCoordinates(deviceIndex, latitude, longitude) {
                devices[deviceIndex].installCoordinates = {
                    latitude: latitude,
                    longitude: longitude
                };
                this.saveDevices();
                return true;
            }
        };

        // ========== 事件管理器 ==========
        const EventManager = {
            init() {
                this.setupDeviceEvents();
                this.setupModalEvents();
                this.setupNavigationEvents();
                this.setupGlobalEvents();
                this.setupQREvents();
                this.setupImageEvents();
                this.setupCoordinateEvents();
                this.setupErrorLogEvents();
                this.setupDeviationRangeEvents();
            },

            // 设置全局事件
            setupGlobalEvents() {
                // 页面可见性变化时保存数据
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        DataManager.createBackup();
                    }
                });

                // 页面卸载前保存数据
                window.addEventListener('beforeunload', () => {
                    DataManager.createBackup();
                });

                // 错误监控
                window.addEventListener('error', (e) => {
                    console.error('全局错误:', e.error);
                    ErrorLogger.logError('全局JavaScript错误', e.error);
                });

                // Promise rejection 监控
                window.addEventListener('unhandledrejection', (e) => {
                    console.error('未处理的Promise拒绝:', e.reason);
                    ErrorLogger.logError('未处理的Promise拒绝', e.reason);
                });
            },

            // 设备相关事件委托 - 修复点击问题
            setupDeviceEvents() {
                // 设备容器事件委托 - 修复：使用性能优化的节流处理
                const throttledClickHandler = PerformanceManager.throttle((e) => {
                    this.handleDeviceContainerClick(e);
                });

                devicesContainer.addEventListener('click', throttledClickHandler);
                devicesContainer.addEventListener('touchend', throttledClickHandler);

                // 设备容器滑动事件 - 修改：改进滑动检测逻辑
                devicesContainer.addEventListener('touchstart', (e) => {
                    this.handleTouchStart(e);
                }, { passive: true });
                
                devicesContainer.addEventListener('touchmove', (e) => {
                    this.handleTouchMove(e);
                }, { passive: true });
                
                devicesContainer.addEventListener('touchend', (e) => {
                    this.handleTouchEnd(e);
                }, { passive: true });
            },
            
            // 触摸开始处理 - 修复滑动检测
            handleTouchStart(e) {
                const conditionItem = e.target.closest('.condition-item');
                const deviceCard = e.target.closest('.device-card-shadow');
                
                if (!deviceCard) return;
                
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
                isScrolling = false;
                isHorizontalSwipe = false;
                
                // 记录当前触摸的元素
                if (conditionItem) {
                    conditionItem.dataset.touchStartX = touchStartX;
                    conditionItem.dataset.touchStartY = touchStartY;
                }
            },
            
            // 触摸移动处理 - 检测是否在滑动
            handleTouchMove(e) {
                if (!touchStartX || !touchStartY) return;
                
                const touch = e.touches[0];
                const deltaX = Math.abs(touch.clientX - touchStartX);
                const deltaY = Math.abs(touch.clientY - touchStartY);
                
                // 如果垂直移动距离超过阈值，认为是垂直滚动
                if (deltaY > VERTICAL_SCROLL_THRESHOLD) {
                    isScrolling = true;
                    lastSwipeTime = Date.now();
                }
                
                // 如果水平移动距离超过阈值，认为是水平滑动
                if (deltaX > SWIPE_THRESHOLD && deltaX > deltaY) {
                    isScrolling = true;
                    isHorizontalSwipe = true;
                    lastSwipeTime = Date.now();
                }
            },
            
            // 触摸结束处理 - 修复：正确重置状态并处理水平滑动
            handleTouchEnd(e) {
                const touch = e.changedTouches[0];
                touchEndX = touch.clientX;
                touchEndY = touch.clientY;
                
                const deltaX = Math.abs(touchEndX - touchStartX);
                const deltaY = Math.abs(touchEndY - touchStartY);
                const touchDuration = Date.now() - touchStartTime;
                
                // 检查是否为水平滑动
                if (isHorizontalSwipe && deltaX > SWIPE_THRESHOLD && deltaX > deltaY) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const conditionItem = e.target.closest('.condition-item');
                    if (conditionItem) {
                        const deviceIndex = this.getDeviceIndex(conditionItem);
                        const conditionIndex = parseInt(conditionItem.dataset.index);
                        
                        if (!isNaN(deviceIndex) && !isNaN(conditionIndex)) {
                            // 设置状态为异常并打开备注模态框
                            DataManager.updateCondition(deviceIndex, conditionIndex, 'abnormal');
                            currentDeviceId = deviceIndex;
                            currentConditionIndex = conditionIndex;
                            openRemarkModal(devices[deviceIndex].conditions[conditionIndex].name);
                            this.refreshUI();
                        }
                    }
                }
                
                // 重置触摸状态
                touchStartX = 0;
                touchStartY = 0;
                touchEndX = 0;
                touchEndY = 0;
                isScrolling = false;
                isHorizontalSwipe = false;
            },

            // 处理设备容器点击 - 修复点击问题
            handleDeviceContainerClick(e) {
                const target = e.target;
                
                // 修复：如果是滑动，不触发任何点击事件
                if (isScrolling || Date.now() - lastSwipeTime < 100) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                // 修复：阻止默认行为，确保移动端点击能正确触发
                e.preventDefault();
                
                // 条件项点击 - 修复点击状态更新问题
                const conditionItem = target.closest('.condition-item');
                if (conditionItem) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(conditionItem);
                    const conditionIndex = parseInt(conditionItem.dataset.index);
                    if (!isNaN(deviceIndex) && !isNaN(conditionIndex)) {
                        // 修复：点击时切换状态
                        const currentStatus = devices[deviceIndex].conditions[conditionIndex].status;
                        const today = getCurrentDate();
                        const isTodayInspection = devices[deviceIndex].conditions[conditionIndex].inspectionTime && 
                                                devices[deviceIndex].conditions[conditionIndex].inspectionTime.startsWith(today);
                        
                        let newStatus;
                        if (currentStatus === 'normal') {
                            // 如果已经是正常状态，则重置为待巡检
                            newStatus = 'pending';
                        } else if (currentStatus === 'abnormal') {
                            // 如果是异常状态，则重置为待巡检
                            newStatus = 'pending';
                        } else {
                            // 否则设置为正常
                            newStatus = 'normal';
                        }
                        
                        DataManager.updateCondition(deviceIndex, conditionIndex, newStatus);
                        this.refreshUI();
                    }
                    return;
                }

                // 刷新按钮
                const refreshBtn = target.closest('.refresh-device');
                if (refreshBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(refreshBtn);
                    if (!isNaN(deviceIndex)) {
                        this.refreshSingleDevice(deviceIndex);
                    }
                    return;
                }

                // 编辑按钮
                const editBtn = target.closest('.edit-device');
                if (editBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(editBtn);
                    if (!isNaN(deviceIndex)) {
                        openEditDeviceModal(deviceIndex);
                    }
                    return;
                }
                
                // 图片管理按钮
                const imageBtn = target.closest('.image-management-btn');
                if (imageBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(imageBtn);
                    if (!isNaN(deviceIndex)) {
                        openImageManagementModal(deviceIndex);
                    }
                    return;
                }
                
                // 定位按钮
                const locationBtn = target.closest('.location-btn');
                if (locationBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(locationBtn);
                    if (!isNaN(deviceIndex)) {
                        getCurrentLocation(deviceIndex);
                    }
                    return;
                }
                
                // 图片预览
                const deviceImage = target.closest('.device-image');
                if (deviceImage) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(deviceImage);
                    const imageId = deviceImage.dataset.imageId;
                    if (!isNaN(deviceIndex) && imageId) {
                        openImagePreview(deviceIndex, imageId);
                    }
                    return;
                }

                // 卡片点击（展开/折叠）- 修复：只在点击设备标题信息区域且不是滑动时触发
                const deviceHeaderInfo = target.closest('.device-header-info');
                if (deviceHeaderInfo && !conditionItem && !refreshBtn && !editBtn && !imageBtn && !locationBtn && !deviceImage && !isScrolling) {
                    const deviceCard = deviceHeaderInfo.closest('.device-card-shadow');
                    if (deviceCard) {
                        const deviceIndex = this.getDeviceIndex(deviceCard);
                        this.toggleDeviceCard(deviceCard, deviceIndex);
                    }
                }
            },

            // 辅助方法
            getDeviceIndex(element) {
                const card = element.closest('.device-card-shadow');
                if (!card) return -1;
                
                // 使用 data-device-index 属性
                const index = parseInt(card.dataset.deviceIndex);
                return isNaN(index) ? -1 : index;
            },

            toggleDeviceCard(card, index) {
                if (index !== expandedCardIndex) {
                    // 收起所有卡片
                    const allCards = devicesContainer.querySelectorAll('.device-card-shadow');
                    allCards.forEach((c, i) => {
                        if (i !== index) this.setCardExpanded(c, false);
                    });
                    
                    // 展开当前卡片
                    this.setCardExpanded(card, true);
                    expandedCardIndex = index;
                } else {
                    // 点击已展开的卡片，收起它
                    this.setCardExpanded(card, false);
                    expandedCardIndex = -1;
                }
            },

            setCardExpanded(card, isExpanded) {
                const progressOverlay = card.querySelector('.mini-progress-overlay');
                const miniInspectionInfo = card.querySelector('.mini-inspection-info');
                const expandedContent = card.querySelector('.expanded-content');
                
                if (isExpanded) {
                    progressOverlay.classList.add('hidden');
                    if (miniInspectionInfo) miniInspectionInfo.classList.add('hidden');
                    expandedContent.classList.remove('hidden');
                    card.classList.add('expanded-card');
                    
                    // 修复：添加可滚动类
                    const conditionsContainer = card.querySelector('.conditions-container');
                    if (conditionsContainer) {
                        conditionsContainer.classList.add('device-card-scrollable');
                    }
                } else {
                    progressOverlay.classList.remove('hidden');
                    if (miniInspectionInfo) miniInspectionInfo.classList.remove('hidden');
                    expandedContent.classList.add('hidden');
                    card.classList.remove('expanded-card');
                    
                    // 修复：移除可滚动类
                    const conditionsContainer = card.querySelector('.conditions-container');
                    if (conditionsContainer) {
                        conditionsContainer.classList.remove('device-card-scrollable');
                    }
                }
            },

            refreshSingleDevice(index) {
                const today = getCurrentDate();
                devices[index].conditions.forEach((condition, condIndex) => {
                    if (condition.inspectionTime && condition.inspectionTime.startsWith(today)) {
                        DataManager.updateCondition(index, condIndex, 'pending', '');
                    }
                });
                this.refreshUI();
                showSuccess('设备巡检状态已刷新');
            },

            refreshUI() {
                renderDevices();
                renderInspectionRecords();
            },

            setupModalEvents() {
                // 模态框预设按钮事件 - 使用一次性绑定
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('preset-btn')) {
                        const condition = e.target.getAttribute('data-condition');
                        const isEditModal = e.target.closest('#edit-device-modal');
                        
                        if (isEditModal) {
                            editAddPresetCondition(condition);
                        } else {
                            addPresetCondition(condition);
                        }
                    }
                });
            },

            setupNavigationEvents() {
                // 导航按钮事件
                navDeviceListBtn.addEventListener('click', () => switchPage('device-list-page'));
                navRecordsBtn.addEventListener('click', () => switchPage('inspection-records-page'));
                navDataManagementBtn.addEventListener('click', () => {
                    // 数据管理页面进入时的二次确认
                    UXManager.showConfirm(
                        '此页面涉及设备和记录数据，请谨慎操作！确定要继续吗？', 
                        '数据管理警告'
                    ).then(confirmed => {
                        if (confirmed) {
                            switchPage('data-management-page');
                            // 加载当前偏离范围设置到输入框
                            locationDeviationRangeInput.value = locationDeviationRange;
                        }
                    });
                });
                
                // 搜索事件 - 增加防抖时间
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchTerm = e.target.value.toLowerCase();
                        renderDevices();
                    }, 300);
                });
                
                // 预设项目管理按钮事件
                presetConditionsBtn.addEventListener('click', openPresetConditionsModal);
            },
            
            // 设置二维码扫描事件
            setupQREvents() {
                qrScanBtn.addEventListener('click', openQRScanModal);
                closeQrScanModal.addEventListener('click', closeQRScanModal);
                switchCameraBtn.addEventListener('click', switchCamera);
                uploadQrImageBtn.addEventListener('click', () => qrImageInput.click());
                qrImageInput.addEventListener('change', handleQRImageUpload);
            },
            
            // 设置图片管理事件
            setupImageEvents() {
                closeImageManagementModal.addEventListener('click', closeImageManagementModalFunc);
                addImageFromGallery.addEventListener('click', () => imageFileInput.click());
                takePhotoBtn.addEventListener('click', takePhoto);
                imageFileInput.addEventListener('change', handleImageFileSelect);
                closeImageManagement.addEventListener('click', closeImageManagementModalFunc);
                closeImagePreview.addEventListener('click', closeImagePreviewModal);
                
                // 拍照模态框事件
                closeCamera.addEventListener('click', closeCameraModal);
                captureBtn.addEventListener('click', capturePhoto);
            },
            
            // 设置坐标相关事件
            setupCoordinateEvents() {
                getCurrentLocationBtn.addEventListener('click', handleGetCurrentLocation);
                editGetCurrentLocationBtn.addEventListener('click', handleEditGetCurrentLocation);
            },
            
            // 设置错误日志事件
            setupErrorLogEvents() {
                viewErrorLogBtn.addEventListener('click', openErrorLogModal);
                closeErrorLogModal.addEventListener('click', closeErrorLogModalFunc);
                closeErrorLog.addEventListener('click', closeErrorLogModalFunc);
                clearErrorLogBtn.addEventListener('click', clearErrorLog);
            },
            
            // 设置定位偏离范围事件
            setupDeviationRangeEvents() {
                saveDeviationRangeBtn.addEventListener('click', saveLocationDeviationRange);
            }
        };

        // ========== 用户体验管理器 ==========
        const UXManager = {
            // 显示操作反馈
            showOperationFeedback(message, type = 'success') {
                // 移除现有的反馈
                const existingFeedback = document.querySelector('.operation-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                const feedback = document.createElement('div');
                feedback.className = `operation-feedback ${
                    type === 'success' ? 'bg-green-500 text-white' : 
                    type === 'error' ? 'bg-red-500 text-white' : 
                    'bg-blue-500 text-white'
                }`;
                feedback.textContent = message;
                
                document.body.appendChild(feedback);
                
                // 自动隐藏
                setTimeout(() => {
                    feedback.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (feedback.parentNode) {
                            feedback.parentNode.removeChild(feedback);
                        }
                    }, 300);
                }, 3000);
            },

            // 确认对话框
            async showConfirm(message, title = '确认操作') {
                return new Promise((resolve) => {
                    // 创建模态框
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 p-6">
                            <h3 class="text-xl font-bold text-dark mb-4">${title}</h3>
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors cancel-btn">取消</button>
                                <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors confirm-btn">确认</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // 事件处理
                    modal.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(false);
                    });
                    
                    modal.querySelector('.confirm-btn').addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(true);
                    });
                    
                    // ESC键关闭
                    const handleKeydown = (e) => {
                        if (e.key === 'Escape') {
                            document.body.removeChild(modal);
                            document.removeEventListener('keydown', handleKeydown);
                            resolve(false);
                        }
                    };
                    document.addEventListener('keydown', handleKeydown);
                });
            },

            // 加载状态管理
            setLoadingState(isLoading, message = '加载中...') {
                if (isLoading) {
                    showLoading(message);
                } else {
                    hideLoading();
                }
            },

            // 离线状态检测
            initOfflineDetection() {
                window.addEventListener('online', () => {
                    this.showOperationFeedback('网络连接已恢复', 'success');
                });

                window.addEventListener('offline', () => {
                    this.showOperationFeedback('网络连接已断开，请检查网络', 'error');
                });
            }
        };

        // ========== 初始化函数 ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，初始化应用');

            // 获取DOM元素
            devicesContainer = document.getElementById('devices-container');
            emptyState = document.getElementById('empty-state');
            addDeviceBtn = document.getElementById('add-device-btn');
            emptyAddBtn = document.getElementById('empty-add-btn');
            addDeviceModal = document.getElementById('add-device-modal');
            modalContent = document.getElementById('modal-content');
            closeModal = document.getElementById('close-modal');
            addDeviceForm = document.getElementById('add-device-form');
            conditionsContainer = document.getElementById('conditions-container');
            addConditionBtn = document.getElementById('add-condition-btn');
            cancelAddDevice = document.getElementById('cancel-add-device');
            remarkModal = document.getElementById('remark-modal');
            remarkModalContent = document.getElementById('remark-modal-content');
            closeRemarkModal = document.getElementById('close-remark-modal');
            remarkForm = document.getElementById('remark-form');
            conditionNameInput = document.getElementById('condition-name');
            remarkContentInput = document.getElementById('remark-content');
            cancelRemark = document.getElementById('cancel-remark');
            submitAddDeviceBtn = document.getElementById('submit-add-device');
            submitRemarkBtn = document.getElementById('submit-remark');
            refreshAllBtn = document.getElementById('refresh-all-btn');
            editDeviceModal = document.getElementById('edit-device-modal');
            editModalContent = document.getElementById('edit-modal-content');
            closeEditModal = document.getElementById('close-edit-modal');
            editDeviceForm = document.getElementById('edit-device-form');
            editDeviceIndexInput = document.getElementById('edit-device-index');
            editDeviceNameInput = document.getElementById('edit-device-name');
            editDeviceCategoryInput = document.getElementById('edit-device-category');
            editDeviceLocationInput = document.getElementById('edit-device-location');
            editDeviceModelInput = document.getElementById('edit-device-model');
            editDeviceManufacturerInput = document.getElementById('edit-device-manufacturer');
            editDeviceSerialNumberInput = document.getElementById('edit-device-serial-number');
            editDeviceRangeInput = document.getElementById('edit-device-range');
            editInspectionCycleInput = document.getElementById('edit-inspection-cycle');
            editLastInspectionDateInput = document.getElementById('edit-last-inspection-date');
            editConditionsContainer = document.getElementById('edit-conditions-container');
            editAddConditionBtn = document.getElementById('edit-add-condition-btn');
            deleteDeviceBtn = document.getElementById('delete-device-btn');
            cancelEditDevice = document.getElementById('cancel-edit-device');
            submitEditDeviceBtn = document.getElementById('submit-edit-device');
            inspectionRecordsContainer = document.getElementById('inspection-records');
            toggleAllRecordsBtn = document.getElementById('toggle-all-records');
            fileImportInput = document.getElementById('file-import');
            loadingIndicator = document.getElementById('loading-indicator');
            
            // 新增的导航元素
            navDeviceListBtn = document.getElementById('nav-device-list');
            navRecordsBtn = document.getElementById('nav-records');
            navDataManagementBtn = document.getElementById('nav-data-management');
            deviceListPage = document.getElementById('device-list-page');
            inspectionRecordsPage = document.getElementById('inspection-records-page');
            dataManagementPage = document.getElementById('data-management-page');
            
            // 数据管理按钮
            dataExportBtn = document.getElementById('data-export-btn');
            dataImportBtn = document.getElementById('data-import-btn');
            presetConditionsBtn = document.getElementById('preset-conditions-btn');
            dataDeleteAllBtn = document.getElementById('data-delete-all-btn');
            dataResetAppBtn = document.getElementById('data-reset-app-btn');
            
            // 顶部右侧按钮容器
            topRightButtons = document.getElementById('top-right-buttons');
            
            // 搜索输入框
            searchInput = document.getElementById('search-input');
            
            // 确认所有按钮
            confirmAllBtn = document.getElementById('confirm-all-btn');
            
            // 预设项目按钮容器
            presetConditionsButtons = document.getElementById('preset-conditions-buttons');
            editPresetConditionsButtons = document.getElementById('edit-preset-conditions-buttons');
            
            // 预设项目管理模态框元素
            presetConditionsModal = document.getElementById('preset-conditions-modal');
            presetModalContent = document.getElementById('preset-modal-content');
            closePresetModal = document.getElementById('close-preset-modal');
            presetConditionsList = document.getElementById('preset-conditions-list');
            addPresetConditionBtn = document.getElementById('add-preset-condition-btn');
            savePresetConditionsBtn = document.getElementById('save-preset-conditions');
            cancelPresetBtn = document.getElementById('cancel-preset');
            
            // 二维码扫描相关元素
            qrScanBtn = document.getElementById('qr-scan-btn');
            qrScanModal = document.getElementById('qr-scan-modal');
            qrScanModalContent = document.getElementById('qr-scan-modal-content');
            closeQrScanModal = document.getElementById('close-qr-scan-modal');
            qrVideo = document.getElementById('qr-video');
            qrCanvas = document.getElementById('qr-canvas');
            qrResult = document.getElementById('qr-result');
            qrResultText = document.getElementById('qr-result-text');
            switchCameraBtn = document.getElementById('switch-camera-btn');
            uploadQrImageBtn = document.getElementById('upload-qr-image-btn');
            qrImageInput = document.getElementById('qr-image-input');
            
            // 图片管理相关元素
            imageManagementModal = document.getElementById('image-management-modal');
            imageManagementModalContent = document.getElementById('image-management-modal-content');
            closeImageManagementModal = document.getElementById('close-image-management-modal');
            addImageFromGallery = document.getElementById('add-image-from-gallery');
            takePhotoBtn = document.getElementById('take-photo-btn');
            imageFileInput = document.getElementById('image-file-input');
            deviceImagesList = document.getElementById('device-images-list');
            closeImageManagement = document.getElementById('close-image-management');
            imagePreviewModal = document.getElementById('image-preview-modal');
            closeImagePreview = document.getElementById('close-image-preview');
            previewImage = document.getElementById('preview-image');
            
            // 拍照模态框元素
            cameraModal = document.getElementById('camera-modal');
            cameraPreview = document.getElementById('camera-preview');
            captureBtn = document.getElementById('capture-btn');
            closeCamera = document.getElementById('close-camera');
            
            // 错误日志相关元素
            viewErrorLogBtn = document.getElementById('view-error-log-btn');
            errorLogModal = document.getElementById('error-log-modal');
            errorLogModalContent = document.getElementById('error-log-modal-content');
            closeErrorLogModal = document.getElementById('close-error-log-modal');
            errorLogList = document.getElementById('error-log-list');
            clearErrorLogBtn = document.getElementById('clear-error-log-btn');
            closeErrorLog = document.getElementById('close-error-log');
            
            // 新增：坐标相关DOM元素
            deviceInstallLatitudeInput = document.getElementById('device-install-latitude');
            deviceInstallLongitudeInput = document.getElementById('device-install-longitude');
            getCurrentLocationBtn = document.getElementById('get-current-location-btn');
            editDeviceInstallLatitudeInput = document.getElementById('edit-device-install-latitude');
            editDeviceInstallLongitudeInput = document.getElementById('edit-device-install-longitude');
            editGetCurrentLocationBtn = document.getElementById('edit-get-current-location-btn');
            
            // 新增：定位偏离范围相关DOM元素
            locationDeviationRangeInput = document.getElementById('location-deviation-range');
            saveDeviationRangeBtn = document.getElementById('save-deviation-range-btn');

            // 初始化管理器
            EventManager.init();
            UXManager.initOfflineDetection();

            // 从本地存储加载数据
            DataManager.loadDevices();
            
            // 检查是否需要每日重置
            checkAndResetDaily();
            
            renderDevices();
            renderInspectionRecords();
            renderPresetConditionButtons();

            // 事件监听
            addDeviceBtn.addEventListener('click', openAddDeviceModal);
            emptyAddBtn.addEventListener('click', openAddDeviceModal);
            closeModal.addEventListener('click', closeAddDeviceModal);
            cancelAddDevice.addEventListener('click', closeAddDeviceModal);
            submitAddDeviceBtn.addEventListener('click', handleAddDevice);
            addConditionBtn.addEventListener('click', addConditionField);

            closeRemarkModal.addEventListener('click', closeRemarkModalFunc);
            cancelRemark.addEventListener('click', closeRemarkModalFunc);
            submitRemarkBtn.addEventListener('click', handleRemarkSubmit);

            refreshAllBtn.addEventListener('click', function() {
                UXManager.showConfirm('确定要刷新所有设备的巡检状态吗？', '刷新所有设备').then(confirmed => {
                    if (confirmed) {
                        refreshAllDevices();
                    }
                });
            });
            
            // 确认所有按钮事件
            confirmAllBtn.addEventListener('click', function() {
                UXManager.showConfirm('确定要将当天所有设备的所有巡检项目状态全部更改为已巡检吗？', '确认所有设备').then(confirmed => {
                    if (confirmed) {
                        confirmAllDevices();
                    }
                });
            });

            closeEditModal.addEventListener('click', closeEditDeviceModal);
            cancelEditDevice.addEventListener('click', closeEditDeviceModal);
            deleteDeviceBtn.addEventListener('click', handleDeleteDevice);
            submitEditDeviceBtn.addEventListener('click', handleEditDevice);
            editAddConditionBtn.addEventListener('click', editAddConditionField);

            // 导入导出事件
            dataExportBtn.addEventListener('click', exportDevices);
            dataImportBtn.addEventListener('click', function() {
                fileImportInput.click();
            });
            
            // 删除所有设备事件
            dataDeleteAllBtn.addEventListener('click', deleteAllDevices);
            
            // 重置软件事件
            dataResetAppBtn.addEventListener('click', resetApp);
            
            fileImportInput.addEventListener('change', handleFileImport);
            
            // 记录折叠事件
            toggleAllRecordsBtn.addEventListener('click', toggleAllRecords);
            
            // 预设项目管理事件
            closePresetModal.addEventListener('click', closePresetConditionsModal);
            cancelPresetBtn.addEventListener('click', closePresetConditionsModal);
            addPresetConditionBtn.addEventListener('click', addPresetConditionItem);
            savePresetConditionsBtn.addEventListener('click', savePresetConditions);

            console.log('应用初始化完成，所有事件监听器已绑定');
        });

        // ========== 核心功能函数 ==========

        // 切换页面
        function switchPage(pageId) {
            // 隐藏所有页面
            deviceListPage.classList.add('hidden');
            inspectionRecordsPage.classList.add('hidden');
            dataManagementPage.classList.add('hidden');
            
            // 显示选中的页面
            document.getElementById(pageId).classList.remove('hidden');
            
            // 更新导航按钮状态
            navDeviceListBtn.classList.remove('active');
            navRecordsBtn.classList.remove('active');
            navDataManagementBtn.classList.remove('active');
            
            if (pageId === 'device-list-page') {
                navDeviceListBtn.classList.add('active');
                // 在设备列表页面显示顶部按钮
                topRightButtons.classList.remove('hidden');
            } else if (pageId === 'inspection-records-page') {
                navRecordsBtn.classList.add('active');
                // 在巡检记录页面隐藏顶部按钮
                topRightButtons.classList.add('hidden');
            } else if (pageId === 'data-management-page') {
                navDataManagementBtn.classList.add('active');
                // 在数据管理页面隐藏顶部按钮
                topRightButtons.classList.add('hidden');
            }
        }

        // 检查并执行每日重置 - 修复：确保正确重置状态但不影响当天进度
        function checkAndResetDaily() {
            var today = getCurrentDate();
            var lastResetDate = localStorage.getItem('lastResetDate');
            
            // 如果是新的一天，重置所有设备状态
            if (lastResetDate !== today) {
                console.log('新的一天，重置所有设备状态');
                devices.forEach(function(device) {
                    device.conditions.forEach(function(condition) {
                        // 确保正确保存历史记录
                        if (!condition.history) {
                            condition.history = [];
                        }
                        
                        // 检查昨天是否有巡检记录需要保存
                        var yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        var yesterdayStr = DateUtils.formatDate(yesterday);
                        
                        // 如果昨天有巡检记录且状态不是待巡检，保存到历史记录
                        if (condition.inspectionTime && condition.inspectionTime.startsWith(yesterdayStr) && condition.status !== 'pending') {
                            var historyRecord = {
                                date: yesterdayStr,
                                status: condition.status,
                                remark: condition.remark,
                                inspectionTime: condition.inspectionTime
                            };
                            
                            // 检查是否已经存在昨天的历史记录
                            var existingIndex = condition.history.findIndex(function(h) { return h.date === yesterdayStr; });
                            if (existingIndex !== -1) {
                                // 更新现有记录
                                condition.history[existingIndex] = historyRecord;
                            } else {
                                // 添加新记录
                                condition.history.push(historyRecord);
                            }
                        }
                        
                        // 重置当前状态为待巡检 - 但保留当天的记录
                        // 只有当天的记录才重置，避免影响已完成的巡检
                        if (condition.inspectionTime && condition.inspectionTime.startsWith(today)) {
                            condition.status = 'pending';
                            condition.remark = '';
                            condition.inspectionTime = '';
                        }
                    });
                });
                
                // 保存重置后的状态和新的重置日期
                DataManager.saveDevices();
                localStorage.setItem('lastResetDate', today);
                
                console.log('每日重置完成');
            }
        }

        // 渲染所有设备（支持搜索）- 增加防抖时间
        const renderDevices = PerformanceManager.debounce(function() {
            console.log('开始渲染设备列表，共有 ' + devices.length + ' 个设备');
            
            // 过滤设备
            var filteredDevices = devices;
            if (searchTerm) {
                filteredDevices = devices.filter(function(device) { 
                    return device.name.toLowerCase().includes(searchTerm) || 
                        (device.serialNumber && device.serialNumber.toLowerCase().includes(searchTerm)) ||
                        (device.location && device.location.toLowerCase().includes(searchTerm));
                });
            }
            
            if (filteredDevices.length === 0) {
                if (searchTerm) {
                    devicesContainer.innerHTML = '<div class="no-results">未找到匹配的设备</div>';
                } else {
                    emptyState.classList.remove('hidden');
                    devicesContainer.classList.add('hidden');
                }
                console.log('设备列表为空，显示空状态');
                return;
            }

            emptyState.classList.add('hidden');
            devicesContainer.classList.remove('hidden');
            devicesContainer.innerHTML = '';

            filteredDevices.forEach(function(device, index) {
                // 获取原始设备索引（因为过滤后的索引可能不同）
                var originalIndex = devices.findIndex(function(d) { 
                    return d.id === device.id;
                });
                
                var deviceCard = createDeviceCard(device, originalIndex);
                devicesContainer.appendChild(deviceCard);
                
                // 默认折叠所有卡片，除了当前展开的卡片
                if (originalIndex !== expandedCardIndex) {
                    EventManager.setCardExpanded(deviceCard, false);
                } else {
                    // 确保展开的卡片也应用样式
                    EventManager.setCardExpanded(deviceCard, true);
                }
            });

            console.log('设备列表渲染完成');
        }, 150);

        // 创建设备卡片 - 修复：添加self-start类防止卡片被拉伸
        function createDeviceCard(device, index) {
            const status = StatusManager.getDeviceStatus(device);
            const lastInspection = StatusManager.getLastInspectionDisplay(device);
            const nextInspectionDate = DateUtils.getNextInspectionDate(device.lastInspectionDate, device.inspectionCycle);
            const isNearInspection = DateUtils.isWithinDays(nextInspectionDate, 10);

            // 计算坐标匹配状态 - 修复：使用可调节的偏离范围
            let coordinatesMatchStatus = 'normal';
            let distance = null;
            
            if (device.locationData && device.installCoordinates && 
                device.installCoordinates.latitude && device.installCoordinates.longitude) {
                
                const installLat = parseFloat(device.installCoordinates.latitude);
                const installLng = parseFloat(device.installCoordinates.longitude);
                const currentLat = device.locationData.latitude;
                const currentLng = device.locationData.longitude;
                
                if (CoordinateUtils.isValidCoordinate(installLat, installLng) && 
                    CoordinateUtils.isValidCoordinate(currentLat, currentLng)) {
                    
                    distance = CoordinateUtils.calculateDistance(
                        installLat, installLng, 
                        currentLat, currentLng
                    );
                    
                    // 使用可调节的偏离范围
                    if (distance <= locationDeviationRange) {
                        coordinatesMatchStatus = 'match';
                    } else {
                        coordinatesMatchStatus = 'mismatch';
                    }
                }
            }

            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg overflow-hidden device-card-shadow hover:shadow-md transition-all duration-300 relative device-card self-start';
            card.dataset.deviceIndex = index;

            const inspectionInfo = `
                <span class="text-xs text-gray-600">上次检定: ${device.lastInspectionDate}</span><br>
                <span class="text-xs text-gray-600">周期: ${device.inspectionCycle} 月</span><br>
                <span class="text-xs ${isNearInspection ? 'text-red-500' : 'text-gray-600'}">下次检定: ${nextInspectionDate} ${isNearInspection ? '<i class="fa-solid fa-triangle-exclamation mr-1"></i>' : ''}</span>
            `;

            const miniInspectionInfo = isNearInspection ? `<span class="text-xs text-red-500">下次检定: ${nextInspectionDate} <i class="fa-solid fa-triangle-exclamation mr-1"></i></span>` : '';

            // 新的卡片结构 - 修复：添加device-header-info类到标题区域
            card.innerHTML = `
                <!-- 蓝色进度遮罩层 - 只在折叠时显示 -->
                <div class="mini-progress-overlay" style="--progress: ${status.progress}%"></div>
                
                <div class="mini-card-content p-1">
                    <!-- 迷你卡片内容 - 始终显示 -->
                    <div class="flex justify-between items-start mb-0">
                        <div class="device-header-info">
                            <h3 class="text-base font-bold text-dark truncate">${device.name}</h3>
                            <p class="text-gray-500 text-xs device-code">${device.location}</p>
                        </div>
                        <div class="flex items-center space-x-1 ml-2 flex-shrink-0">
                            <!-- 上次巡检时间 -->
                            <div class="text-right ${lastInspection.colorClass} whitespace-nowrap mr-1">
                                <div class="text-xs leading-none">${lastInspection.time}</div>
                                <div class="text-xs leading-none">${lastInspection.date}</div>
                            </div>
                            <button class="refresh-device text-dark bg-white/80 hover:bg-white rounded-full p-1 transition-colors fixed-size-btn touch-button" title="刷新设备状态">
                                <i class="fa-solid fa-rotate text-xs"></i>
                            </button>
                            <button class="edit-device text-dark bg-white/80 hover:bg-white rounded-full p-1 transition-colors fixed-size-btn touch-button" title="编辑设备信息">
                                <i class="fa-solid fa-pen text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 检定日期提醒 - 只在折叠时显示 -->
                    <div class="mini-inspection-info ${isNearInspection ? '' : 'hidden'}">
                        ${miniInspectionInfo}
                    </div>
                    
                    <!-- 展开卡片内容 - 只在展开时显示 -->
                    <div class="expanded-content hidden">
                        <!-- 设备基本信息网格 -->
                        <div class="device-info-grid mb-2">
                            <div class="device-info-label">类别:</div>
                            <div class="device-info-value">${device.category}</div>
                            
                            <div class="device-info-label">出厂编号:</div>
                            <div class="device-info-value">${device.serialNumber || '无'}</div>
                            
                            <div class="device-info-label">规格型号:</div>
                            <div class="device-info-value">${device.model || '无'}</div>
                            
                            <div class="device-info-label">生产厂家:</div>
                            <div class="device-info-value">${device.manufacturer || '无'}</div>
                            
                            <div class="device-info-label">测量范围:</div>
                            <div class="device-info-value">${device.range || '无'}</div>
                        </div>
                        
                        <div class="mb-2 progress-container">
                            <div class="flex justify-between text-xs mb-0.5 progress-text">
                                <span class="text-gray-600">巡检进度</span>
                                <span class="font-medium">${status.progress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="bg-primary h-1.5 rounded-full" style="width: ${status.progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between space-x-1 mb-2 status-container">
                            <div class="bg-green-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-normal"></div>
                                <span class="text-xs text-gray-700">${status.normal}</span>
                            </div>
                            <div class="bg-red-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-abnormal"></div>
                                <span class="text-xs text-gray-700">${status.abnormal}</span>
                            </div>
                            <div class="bg-gray-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-pending"></div>
                                <span class="text-xs text-gray-700">${status.pending}</span>
                            </div>
                        </div>

                        <div class="mb-2 inspection-info">
                            ${inspectionInfo}
                        </div>
                        
                        <!-- 新增：坐标显示区域 -->
                        <div class="coordinates-container">
                            <!-- 图片图标 -->
                            <button class="media-btn image-management-btn touch-button" title="管理图片">
                                <i class="fa-solid fa-images"></i>
                            </button>
                            
                            <!-- 定位图标 -->
                            <button class="media-btn location-btn touch-button" title="获取当前位置">
                                <i class="fa-solid fa-location-dot"></i>
                            </button>
                            
                            <!-- 当前坐标数据 -->
                            <div class="current-coordinates ${coordinatesMatchStatus === 'match' ? 'coordinates-match' : coordinatesMatchStatus === 'mismatch' ? 'coordinates-mismatch' : 'coordinates-normal'}">
                                ${device.locationData ? 
                                    `X: ${CoordinateUtils.formatCoordinate(device.locationData.longitude)}<br>Y: ${CoordinateUtils.formatCoordinate(device.locationData.latitude)}` : 
                                    'X: --<br>Y: --'}
                            </div>
                            
                            <!-- 安装坐标数据 -->
                            <div class="coordinates-display">
                                ${device.installCoordinates && device.installCoordinates.latitude && device.installCoordinates.longitude ? 
                                    `X: ${CoordinateUtils.formatCoordinate(device.installCoordinates.longitude)}<br>Y: ${CoordinateUtils.formatCoordinate(device.installCoordinates.latitude)}` : 
                                    'X: --<br>Y: --'}
                            </div>
                        </div>
                        
                        <!-- 新增：图片展示区域 - 移除删除按钮 -->
                        ${device.images && device.images.length > 0 ? `
                            <div class="device-images-container">
                                ${device.images.map(image => `
                                    <div class="device-image-item">
                                        <img src="${image.data}" class="device-image" data-image-id="${image.id}" alt="设备图片">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="space-y-1 conditions-container">
                            ${device.conditions.map(function(condition, condIndex) {
                                const display = StatusManager.getConditionDisplay(condition);
                                
                                return `
                                <div class="condition-item p-1.5 ${display.className} border ${display.borderColor}" 
                                    data-index="${condIndex}">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="status-indicator ${display.statusClass}"></div>
                                            <span class="text-xs ${display.textColor} ${display.status === 'abnormal' ? 'font-medium' : ''}">${condition.name}</span>
                                        </div>
                                        <div class="flex items-center">
                                            ${display.status === 'abnormal' ? `<span class="text-xs bg-red-100 text-red-800 px-1 py-0.5 rounded-full mr-1">异常</span>` : ''}
                                            ${display.timeDisplay ? `<span class="text-xs text-gray-500">${display.timeDisplay}</span>` : ''}
                                        </div>
                                    </div>
                                    ${display.status === 'abnormal' ? `<p class="text-xs text-red-600 mt-0.5 line-clamp-1"><i class="fa-solid fa-comment mr-0.5"></i>${condition.remark}</p>` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // 打开添加设备模态框
        function openAddDeviceModal() {
            console.log('打开添加设备模态框');

            // 重置表单
            addDeviceForm.reset();
            conditionsContainer.innerHTML = '';
            addConditionField();
            
            // 重置坐标输入
            deviceInstallLatitudeInput.value = '';
            deviceInstallLongitudeInput.value = '';

            // 显示模态框
            addDeviceModal.classList.remove('hidden');
            setTimeout(function() {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            // 聚焦到设备名称输入框
            document.getElementById('device-name').focus();
        }

        // 关闭添加设备模态框
        function closeAddDeviceModal() {
            console.log('关闭添加设备模态框');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                addDeviceModal.classList.add('hidden');
            }, 300);
        }

        // 添加条件字段
        function addConditionField() {
            var conditionsCount = conditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加新的巡检项目字段，当前数量:', conditionsCount + 1);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            conditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }
        
        // 添加预设条件
        function addPresetCondition(condition) {
            var conditionsCount = conditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加预设巡检项目:', condition);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text" value="${condition}"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            conditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }
        
        // 渲染预设条件按钮
        function renderPresetConditionButtons() {
            if (!presetConditionsButtons || !editPresetConditionsButtons) return;
            
            presetConditionsButtons.innerHTML = '';
            editPresetConditionsButtons.innerHTML = '';
            
            presetConditions.forEach(function(condition) {
                const presetBtn = document.createElement('button');
                presetBtn.type = 'button';
                presetBtn.className = 'preset-btn touch-button';
                presetBtn.setAttribute('data-condition', condition);
                presetBtn.textContent = condition;
                
                const editPresetBtn = presetBtn.cloneNode(true);
                
                presetConditionsButtons.appendChild(presetBtn);
                editPresetConditionsButtons.appendChild(editPresetBtn);
            });
        }

        // 打开异常备注模态框
        function openRemarkModal(conditionName) {
            console.log('打开异常备注模态框');

            conditionNameInput.value = conditionName;
            remarkContentInput.value = '';

            remarkModal.classList.remove('hidden');
            setTimeout(function() {
                remarkModalContent.classList.remove('scale-95', 'opacity-0');
                remarkModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭异常备注模态框
        function closeRemarkModalFunc() {
            console.log('关闭异常备注模态框');

            remarkModalContent.classList.remove('scale-100', 'opacity-100');
            remarkModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                remarkModal.classList.add('hidden');
            }, 300);
        }

        // 处理异常备注提交
        function handleRemarkSubmit() {
            console.log('提交异常备注');

            var remark = remarkContentInput.value;
            if (remark) {
                devices[currentDeviceId].conditions[currentConditionIndex].remark = remark;
                DataManager.saveDevices();
                EventManager.refreshUI();
                closeRemarkModalFunc();
                UXManager.showOperationFeedback('异常备注已保存', 'success');
            } else {
                showError('请输入异常描述', 'remark-content-error');
            }
        }

        // 刷新所有当日设备 - 修复记录清空问题，不影响往日记录
        function refreshAllDevices() {
            console.log('刷新所有当日设备的巡检状态');
            
            const today = getCurrentDate();
            let refreshCount = 0;

            devices.forEach((device, deviceIndex) => {
                device.conditions.forEach((condition, conditionIndex) => {
                    // 只刷新当天的记录，不影响历史记录
                    if (condition.inspectionTime && condition.inspectionTime.startsWith(today)) {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'pending', '');
                        refreshCount++;
                    }
                });
            });

            EventManager.refreshUI();
            console.log(`已刷新 ${refreshCount} 个巡检项目`);
            UXManager.showOperationFeedback(`已刷新 ${refreshCount} 个巡检项目`, 'success');
        }
        
        // 确认所有设备的所有巡检项目 - 修复：只确认当天的记录
        function confirmAllDevices() {
            console.log('确认所有设备的巡检状态');
            
            const today = getCurrentDate();
            let confirmCount = 0;

            devices.forEach((device, deviceIndex) => {
                device.conditions.forEach((condition, conditionIndex) => {
                    // 只确认当天的记录，且只将待巡检状态改为正常
                    const isTodayInspection = condition.inspectionTime && condition.inspectionTime.startsWith(today);
                    if (condition.status === 'pending') {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'normal', '');
                        confirmCount++;
                    }
                });
            });

            EventManager.refreshUI();
            console.log(`已确认 ${confirmCount} 个巡检项目`);
            UXManager.showOperationFeedback(`已确认 ${confirmCount} 个巡检项目`, 'success');
        }

        // 打开编辑设备模态框
        function openEditDeviceModal(index) {
            console.log('打开编辑设备模态框，设备索引:', index);

            var device = devices[index];
            editDeviceIndexInput.value = index;
            editDeviceNameInput.value = device.name;
            editDeviceCategoryInput.value = device.category;
            editDeviceLocationInput.value = device.location;
            editDeviceModelInput.value = device.model;
            editDeviceManufacturerInput.value = device.manufacturer;
            editDeviceSerialNumberInput.value = device.serialNumber;
            editDeviceRangeInput.value = device.range;
            editInspectionCycleInput.value = device.inspectionCycle;
            editLastInspectionDateInput.value = device.lastInspectionDate;
            
            // 设置安装坐标
            editDeviceInstallLatitudeInput.value = device.installCoordinates?.latitude || '';
            editDeviceInstallLongitudeInput.value = device.installCoordinates?.longitude || '';

            // 清空条件容器
            editConditionsContainer.innerHTML = '';

            // 添加条件字段
            device.conditions.forEach(function(condition) {
                editAddConditionField(condition.name);
            });

            // 显示模态框
            editDeviceModal.classList.remove('hidden');
            setTimeout(function() {
                editModalContent.classList.remove('scale-95', 'opacity-0');
                editModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            // 聚焦到设备名称输入框
            editDeviceNameInput.focus();
        }
        
        // 编辑模态框添加预设条件
        function editAddPresetCondition(condition) {
            var conditionsCount = editConditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('编辑模态框添加预设巡检项目:', condition);

            editAddConditionField(condition);
        }

        // 关闭编辑设备模态框
        function closeEditDeviceModal() {
            console.log('关闭编辑设备模态框');

            editModalContent.classList.remove('scale-100', 'opacity-100');
            editModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                editDeviceModal.classList.add('hidden');
            }, 300);
        }

        // 编辑模态框添加条件字段
        function editAddConditionField(value = '') {
            var conditionsCount = editConditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('编辑模态框添加新的巡检项目字段，当前数量:', conditionsCount + 1);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text" value="${value}"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            editConditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }

        // 处理删除设备
        function handleDeleteDevice() {
            var index = parseInt(editDeviceIndexInput.value);
            
            UXManager.showConfirm('确定要删除这个设备吗？此操作不可撤销。', '删除设备').then(confirmed => {
                if (confirmed) {
                    console.log('删除设备，索引:', index);
                    
                    devices.splice(index, 1);
                    DataManager.saveDevices();
                    
                    // 重置展开的卡片索引
                    expandedCardIndex = -1;
                    
                    EventManager.refreshUI();
                    closeEditDeviceModal();
                    UXManager.showOperationFeedback('设备已删除', 'success');
                }
            });
        }

        // 处理编辑设备
        function handleEditDevice() {
            console.log('处理编辑设备');

            var index = parseInt(editDeviceIndexInput.value);
            var deviceName = editDeviceNameInput.value.trim();
            var deviceCategory = editDeviceCategoryInput.value;
            var deviceLocation = editDeviceLocationInput.value.trim();
            var deviceModel = editDeviceModelInput.value.trim();
            var deviceManufacturer = editDeviceManufacturerInput.value.trim();
            var deviceSerialNumber = editDeviceSerialNumberInput.value.trim();
            var deviceRange = editDeviceRangeInput.value.trim();
            var inspectionCycle = parseInt(editInspectionCycleInput.value) || 12;
            var lastInspectionDate = editLastInspectionDateInput.value;
            
            // 获取安装坐标
            var installLatitude = editDeviceInstallLatitudeInput.value.trim();
            var installLongitude = editDeviceInstallLongitudeInput.value.trim();

            // 获取条件
            var conditions = [];
            var conditionInputs = editConditionsContainer.querySelectorAll('input[type="text"]');
            conditionInputs.forEach(function(input) {
                var conditionName = input.value.trim();
                if (conditionName) {
                    conditions.push(conditionName);
                }
            });

            // 验证输入
            if (!deviceName) {
                showError('请输入设备名称', 'edit-device-name-error');
                return;
            }

            if (!deviceLocation) {
                showError('请输入安装地点', 'edit-device-location-error');
                return;
            }

            if (conditions.length === 0) {
                showError('请至少添加一个巡检项目', 'edit-conditions-error');
                return;
            }

            // 更新设备
            var device = devices[index];
            device.name = deviceName;
            device.category = deviceCategory;
            device.location = deviceLocation;
            device.model = deviceModel;
            device.manufacturer = deviceManufacturer;
            device.serialNumber = deviceSerialNumber;
            device.range = deviceRange;
            device.inspectionCycle = inspectionCycle;
            device.lastInspectionDate = lastInspectionDate;
            device.updatedAt = new Date().toISOString();
            
            // 更新安装坐标
            device.installCoordinates = {
                latitude: installLatitude,
                longitude: installLongitude
            };

            // 更新条件（保留现有条件的状态）
            var oldConditions = device.conditions;
            device.conditions = conditions.map(function(conditionName, i) {
                // 尝试匹配现有条件
                var oldCondition = oldConditions[i];
                if (oldCondition && oldCondition.name === conditionName) {
                    return oldCondition;
                } else {
                    // 创建新条件
                    return {
                        id: DataManager.generateConditionId(),
                        name: conditionName,
                        status: 'pending',
                        remark: '',
                        inspectionTime: '',
                        history: []
                    };
                }
            });

            // 保存并刷新
            DataManager.saveDevices();
            EventManager.refreshUI();
            closeEditDeviceModal();
            
            console.log('设备编辑成功:', deviceName);
            UXManager.showOperationFeedback('设备已更新', 'success');
        }

        // 处理添加设备
        function handleAddDevice() {
            console.log('处理添加设备');

            var deviceName = document.getElementById('device-name').value.trim();
            var deviceCategory = document.getElementById('device-category').value;
            var deviceLocation = document.getElementById('device-location').value.trim();
            var deviceModel = document.getElementById('device-model').value.trim();
            var deviceManufacturer = document.getElementById('device-manufacturer').value.trim();
            var deviceSerialNumber = document.getElementById('device-serial-number').value.trim();
            var deviceRange = document.getElementById('device-range').value.trim();
            var inspectionCycle = parseInt(document.getElementById('inspection-cycle').value) || 12;
            var lastInspectionDate = document.getElementById('last-inspection-date').value;
            
            // 获取安装坐标
            var installLatitude = deviceInstallLatitudeInput.value.trim();
            var installLongitude = deviceInstallLongitudeInput.value.trim();

            // 获取条件
            var conditions = [];
            var conditionInputs = conditionsContainer.querySelectorAll('input[type="text"]');
            conditionInputs.forEach(function(input) {
                var conditionName = input.value.trim();
                if (conditionName) {
                    conditions.push(conditionName);
                }
            });

            // 验证输入
            if (!deviceName) {
                showError('请输入设备名称', 'device-name-error');
                return;
            }

            if (!deviceLocation) {
                showError('请输入安装地点', 'device-location-error');
                return;
            }

            if (conditions.length === 0) {
                showError('请至少添加一个巡检项目', 'conditions-error');
                return;
            }

            // 创建新设备
            var newDevice = {
                id: DataManager.generateDeviceId(),
                name: deviceName,
                category: deviceCategory,
                location: deviceLocation,
                installCoordinates: {
                    latitude: installLatitude,
                    longitude: installLongitude
                },
                model: deviceModel,
                manufacturer: deviceManufacturer,
                serialNumber: deviceSerialNumber,
                range: deviceRange,
                lastInspectionDate: lastInspectionDate,
                inspectionCycle: inspectionCycle,
                conditions: conditions.map(function(conditionName) {
                    return {
                        id: DataManager.generateConditionId(),
                        name: conditionName,
                        status: 'pending',
                        remark: '',
                        inspectionTime: '',
                        history: []
                    };
                }),
                images: [],
                locationData: null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            devices.push(newDevice);
            DataManager.saveDevices();
            EventManager.refreshUI();
            closeAddDeviceModal();
            
            console.log('设备添加成功:', deviceName);
            UXManager.showOperationFeedback('设备已添加', 'success');
        }

        // 渲染巡检记录 - 修复：进度计算和设备显示
        const renderInspectionRecords = PerformanceManager.debounce(function() {
            console.log('开始渲染巡检记录');
            
            if (!inspectionRecordsContainer) return;
            
            // 获取所有巡检记录
            var allRecords = getAllInspectionRecords();
            
            if (allRecords.length === 0) {
                inspectionRecordsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">暂无巡检记录</div>';
                console.log('巡检记录为空');
                return;
            }

            inspectionRecordsContainer.innerHTML = '';

            allRecords.forEach(function(record) {
                var dateSection = document.createElement('div');
                dateSection.className = 'mb-6';
                
                // 修改：计算该日期的进度 - 只有当设备的所有巡检项目都完成时才计入已完成设备
                const totalDevices = devices.length;
                let inspectedDevices = 0;
                
                // 遍历所有设备，检查该日期是否所有巡检项目都已完成
                devices.forEach(device => {
                    const deviceRecord = record.devices[device.id];
                    if (deviceRecord) {
                        // 检查该设备在该日期是否所有巡检项目都已完成
                        const allConditionsCompleted = device.conditions.every(condition => {
                            // 查找该条件在该日期的记录
                            const conditionRecord = deviceRecord.conditions.find(c => c.id === condition.id);
                            // 如果有记录且状态不是待巡检，则认为已完成
                            return conditionRecord && conditionRecord.status !== 'pending';
                        });
                        
                        if (allConditionsCompleted) {
                            inspectedDevices++;
                        }
                    }
                });
                
                const progressPercentage = totalDevices > 0 ? Math.round(inspectedDevices / totalDevices * 100) : 0;
                
                dateSection.innerHTML = `
                    <div class="record-date" data-date="${record.date}">
                        <span>${formatDisplayDate(record.date)}</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="record-progress-container">
                        <div class="record-progress-bar">
                            <div class="record-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="record-progress-text">${inspectedDevices}/${totalDevices} (${progressPercentage}%)</div>
                    </div>
                    <div class="date-records ${expandedDates[record.date] ? '' : 'hidden'}" id="records-${record.date}">
                        <!-- 该日期的设备记录将由JS动态填充 -->
                    </div>
                `;
                
                inspectionRecordsContainer.appendChild(dateSection);

                // 添加日期点击事件
                var dateHeader = dateSection.querySelector('.record-date');
                dateHeader.addEventListener('click', function() {
                    toggleDateRecords(record.date);
                });

                // 渲染该日期的设备记录
                renderDateRecords(record.date, record.devices, dateSection.querySelector('.date-records'));
            });

            console.log('巡检记录渲染完成');
        }, 200);

        // 渲染日期记录 - 修复：设备名称、安装地点、时间在同一行显示，调整间距
        function renderDateRecords(date, dateDevices, container) {
            container.innerHTML = '';
            
            // 获取所有设备，包括未巡检的设备
            devices.forEach(function(device) {
                var deviceRecord = dateDevices[device.id];
                var deviceCard = document.createElement('div');
                deviceCard.className = 'record-device-box';
                
                // 获取该设备在该日期的所有条件记录
                var conditionRecords = [];
                if (deviceRecord) {
                    conditionRecords = deviceRecord.conditions;
                }
                
                // 统计该设备在该日期的巡检状态
                var normalCount = 0;
                var abnormalCount = 0;
                var pendingCount = 0;
                var lastInspectionTime = null;
                
                device.conditions.forEach(function(condition) {
                    var conditionRecord = conditionRecords.find(function(cr) { return cr.id === condition.id; });
                    var display = StatusManager.getConditionDisplay(condition, date);
                    
                    if (display.status === 'normal') normalCount++;
                    if (display.status === 'abnormal') abnormalCount++;
                    if (display.status === 'pending') pendingCount++;
                    
                    // 更新时间
                    if (display.historyRecord && display.historyRecord.inspectionTime) {
                        var recordTime = new Date(display.historyRecord.inspectionTime);
                        if (!lastInspectionTime || recordTime > lastInspectionTime) {
                            lastInspectionTime = recordTime;
                        }
                    }
                });
                
                // 格式化时间显示
                var timeDisplay = '';
                if (lastInspectionTime) {
                    var hours = String(lastInspectionTime.getHours()).padStart(2, '0');
                    var minutes = String(lastInspectionTime.getMinutes()).padStart(2, '0');
                    timeDisplay = `${hours}:${minutes}`;
                }
                
                // 修改：调整设备信息布局，将名称、位置、时间放在同一行
                deviceCard.innerHTML = `
                    <div class="record-device-header">
                        <div class="record-device-info">
                            <div class="record-device-name">${device.name}</div>
                            <div class="record-device-location">${device.location}</div>
                        </div>
                        ${timeDisplay ? `<div class="record-device-time">${timeDisplay}</div>` : ''}
                    </div>
                    <div class="record-conditions-row">
                        ${device.conditions.map(function(condition) {
                            var conditionRecord = conditionRecords.find(function(cr) { return cr.id === condition.id; });
                            var display = StatusManager.getConditionDisplay(condition, date);
                            
                            return `
                                <div class="condition-item p-1 ${display.className} border ${display.borderColor} rounded text-xs ${display.textColor}" style="font-size: 0.7rem;">
                                    <div class="flex items-center">
                                        <div class="status-indicator ${display.statusClass} mr-1"></div>
                                        <span>${condition.name}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(deviceCard);
            });
        }

        // 获取所有巡检记录
        function getAllInspectionRecords() {
            var recordsMap = {};
            
            // 遍历所有设备和条件的历史记录
            devices.forEach(function(device) {
                device.conditions.forEach(function(condition) {
                    // 处理当前状态
                    if (condition.inspectionTime) {
                        var inspectionDate = condition.inspectionTime.split(' ')[0];
                        if (!recordsMap[inspectionDate]) {
                            recordsMap[inspectionDate] = {
                                date: inspectionDate,
                                devices: {}
                            };
                        }
                        
                        if (!recordsMap[inspectionDate].devices[device.id]) {
                            recordsMap[inspectionDate].devices[device.id] = {
                                device: device,
                                conditions: []
                            };
                        }
                        
                        // 添加条件记录
                        recordsMap[inspectionDate].devices[device.id].conditions.push({
                            id: condition.id,
                            name: condition.name,
                            status: condition.status,
                            remark: condition.remark,
                            inspectionTime: condition.inspectionTime
                        });
                    }
                    
                    // 处理历史记录
                    if (condition.history && condition.history.length > 0) {
                        condition.history.forEach(function(historyRecord) {
                            if (!recordsMap[historyRecord.date]) {
                                recordsMap[historyRecord.date] = {
                                    date: historyRecord.date,
                                    devices: {}
                                };
                            }
                            
                            if (!recordsMap[historyRecord.date].devices[device.id]) {
                                recordsMap[historyRecord.date].devices[device.id] = {
                                    device: device,
                                    conditions: []
                                };
                            }
                            
                            // 添加历史条件记录
                            recordsMap[historyRecord.date].devices[device.id].conditions.push({
                                id: condition.id,
                                name: condition.name,
                                status: historyRecord.status,
                                remark: historyRecord.remark,
                                inspectionTime: historyRecord.inspectionTime
                            });
                        });
                    }
                });
            });
            
            // 转换为数组并按日期排序（最新的在前）
            var recordsArray = Object.values(recordsMap);
            recordsArray.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });
            
            return recordsArray;
        }

        // 切换日期记录的展开/收起
        function toggleDateRecords(date) {
            var recordsContainer = document.getElementById('records-' + date);
            var dateHeader = document.querySelector('.record-date[data-date="' + date + '"]');
            var icon = dateHeader.querySelector('i');
            
            if (recordsContainer.classList.contains('hidden')) {
                recordsContainer.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                expandedDates[date] = true;
            } else {
                recordsContainer.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
                expandedDates[date] = false;
            }
        }

        // 展开/收起所有记录
        function toggleAllRecords() {
            var allExpanded = Object.values(expandedDates).every(function(val) { return val; });
            var dateHeaders = document.querySelectorAll('.record-date');
            
            dateHeaders.forEach(function(header) {
                var date = header.getAttribute('data-date');
                var recordsContainer = document.getElementById('records-' + date);
                var icon = header.querySelector('i');
                
                if (allExpanded) {
                    // 收起所有
                    recordsContainer.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                    expandedDates[date] = false;
                } else {
                    // 展开所有
                    recordsContainer.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                    expandedDates[date] = true;
                }
            });
        }

        // 导出设备数据 - 修复：确保导出为TXT格式，每个设备一行，参数用逗号隔开，巡检项目用分号隔开
        function exportDevices() {
            console.log('开始导出设备数据');
            
            if (devices.length === 0) {
                alert('没有设备数据可以导出');
                return;
            }

            try {
                let exportData = '';
                
                devices.forEach(device => {
                    // 设备基本信息
                    const deviceInfo = [
                        device.name || '',
                        device.category || '',
                        device.location || '',
                        device.installCoordinates?.latitude || '',
                        device.installCoordinates?.longitude || '',
                        device.model || '',
                        device.manufacturer || '',
                        device.serialNumber || '',
                        device.range || '',
                        device.lastInspectionDate || '',
                        device.inspectionCycle || ''
                    ];
                    
                    // 巡检项目，用分号隔开
                    const conditions = device.conditions.map(condition => condition.name).join(';');
                    
                    // 合并设备信息和巡检项目
                    const deviceLine = [...deviceInfo, conditions].join(',');
                    
                    exportData += deviceLine + '\n';
                });
                
                // 创建Blob对象并下载
                const blob = new Blob([exportData], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `巡检设备数据_${getCurrentDateTimeForFileName()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('设备数据导出成功');
                UXManager.showOperationFeedback('设备数据已导出', 'success');
            } catch (error) {
                console.error('导出设备数据失败:', error);
                ErrorLogger.logError('导出设备数据失败', error);
                alert('导出失败，请查看控制台了解详情');
            }
        }

        // 处理文件导入 - 修复：确保导入TXT格式，正确处理每行数据，参数用逗号隔开，巡检项目用分号隔开
        function handleFileImport(event) {
            console.log('处理文件导入');
            
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.name.endsWith('.txt')) {
                alert('请选择TXT格式的文件');
                return;
            }
            
            UXManager.showConfirm('导入数据将覆盖现有设备数据，确定要继续吗？', '导入数据警告').then(confirmed => {
                if (!confirmed) {
                    // 重置文件输入
                    fileImportInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            alert('文件为空或格式不正确');
                            return;
                        }
                        
                        const importedDevices = [];
                        
                        lines.forEach((line, index) => {
                            try {
                                // 使用逗号分割参数
                                const parts = line.split(',');
                                
                                if (parts.length < 11) {
                                    console.warn(`第${index + 1}行数据格式不正确，跳过`);
                                    return;
                                }
                                
                                // 解析设备信息
                                const deviceInfo = {
                                    name: parts[0] || '未命名设备',
                                    category: parts[1] || '未分类',
                                    location: parts[2] || '未知位置',
                                    installCoordinates: {
                                        latitude: parts[3] || '',
                                        longitude: parts[4] || ''
                                    },
                                    model: parts[5] || '',
                                    manufacturer: parts[6] || '',
                                    serialNumber: parts[7] || '',
                                    range: parts[8] || '',
                                    lastInspectionDate: parts[9] || new Date().toISOString().split('T')[0],
                                    inspectionCycle: parseInt(parts[10]) || 12
                                };
                                
                                // 解析巡检项目（第12个部分，用分号分割）
                                let conditions = [];
                                if (parts.length > 11) {
                                    conditions = parts[11].split(';').filter(condition => condition.trim());
                                }
                                
                                // 如果没有任何巡检项目，使用默认项目
                                if (conditions.length === 0) {
                                    conditions = ['外观', '检定标签', '显示情况'];
                                }
                                
                                // 创建设备对象
                                const device = {
                                    id: DataManager.generateDeviceId(),
                                    ...deviceInfo,
                                    conditions: conditions.map(conditionName => ({
                                        id: DataManager.generateConditionId(),
                                        name: conditionName,
                                        status: 'pending',
                                        remark: '',
                                        inspectionTime: '',
                                        history: []
                                    })),
                                    images: [],
                                    locationData: null,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                importedDevices.push(device);
                                
                            } catch (error) {
                                console.error(`解析第${index + 1}行数据失败:`, error);
                                ErrorLogger.logError(`解析导入数据第${index + 1}行失败`, error);
                            }
                        });
                        
                        if (importedDevices.length === 0) {
                            alert('没有成功导入任何设备数据');
                            return;
                        }
                        
                        // 替换现有设备数据
                        devices = importedDevices;
                        DataManager.saveDevices();
                        
                        // 重置文件输入
                        fileImportInput.value = '';
                        
                        // 刷新UI
                        EventManager.refreshUI();
                        
                        console.log(`成功导入 ${importedDevices.length} 个设备`);
                        UXManager.showOperationFeedback(`成功导入 ${importedDevices.length} 个设备`, 'success');
                        
                    } catch (error) {
                        console.error('处理导入文件失败:', error);
                        ErrorLogger.logError('处理导入文件失败', error);
                        alert('导入失败，请检查文件格式');
                    }
                };
                
                reader.onerror = function() {
                    console.error('读取文件失败');
                    alert('读取文件失败，请重试');
                };
                
                reader.readAsText(file);
            });
        }

        // 删除所有设备
        function deleteAllDevices() {
            UXManager.showConfirm('确定要删除所有设备吗？此操作不可撤销！', '删除所有设备').then(confirmed => {
                if (confirmed) {
                    console.log('删除所有设备');
                    
                    devices = [];
                    DataManager.saveDevices();
                    
                    // 重置展开的卡片索引
                    expandedCardIndex = -1;
                    
                    EventManager.refreshUI();
                    UXManager.showOperationFeedback('所有设备已删除', 'success');
                }
            });
        }

        // 重置软件
        function resetApp() {
            UXManager.showConfirm('确定要重置软件吗？这将删除所有设备和设置，此操作不可撤销！', '重置软件').then(confirmed => {
                if (confirmed) {
                    console.log('重置软件');
                    
                    // 清除所有本地存储数据
                    localStorage.removeItem('inspection_devices');
                    localStorage.removeItem('inspection_devices_backup');
                    localStorage.removeItem('preset_conditions');
                    localStorage.removeItem('lastResetDate');
                    localStorage.removeItem('error_logs');
                    localStorage.removeItem('location_deviation_range');
                    
                    // 重置所有变量
                    devices = [];
                    presetConditions = ['外观', '检定标签', '显示情况', '接地', '上限标识'];
                    expandedDates = {};
                    expandedCardIndex = -1;
                    searchTerm = '';
                    locationDeviationRange = 15;
                    
                    // 保存默认预设项目
                    DataManager.savePresetConditions();
                    DataManager.saveLocationDeviationRange();
                    
                    // 刷新UI
                    EventManager.refreshUI();
                    
                    // 切换到设备列表页面
                    switchPage('device-list-page');
                    
                    console.log('软件重置完成');
                    UXManager.showOperationFeedback('软件已重置', 'success');
                }
            });
        }

        // 打开预设项目管理模态框
        function openPresetConditionsModal() {
            console.log('打开预设项目管理模态框');
            
            renderPresetConditionsList();
            
            presetConditionsModal.classList.remove('hidden');
            setTimeout(function() {
                presetModalContent.classList.remove('scale-95', 'opacity-0');
                presetModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭预设项目管理模态框
        function closePresetConditionsModal() {
            console.log('关闭预设项目管理模态框');

            presetModalContent.classList.remove('scale-100', 'opacity-100');
            presetModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                presetConditionsModal.classList.add('hidden');
            }, 300);
        }

        // 渲染预设项目列表
        function renderPresetConditionsList() {
            presetConditionsList.innerHTML = '';
            
            presetConditions.forEach((condition, index) => {
                const item = document.createElement('div');
                item.className = 'preset-condition-item';
                item.innerHTML = `
                    <div class="preset-condition-text">${condition}</div>
                    <div class="preset-condition-actions">
                        <button class="edit-preset-condition text-blue-500 hover:text-blue-700 fixed-size-btn touch-button" data-index="${index}">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="delete-preset-condition text-red-500 hover:text-red-700 fixed-size-btn touch-button" data-index="${index}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                presetConditionsList.appendChild(item);
            });
            
            // 添加事件监听
            presetConditionsList.querySelectorAll('.edit-preset-condition').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    editPresetCondition(index);
                });
            });
            
            presetConditionsList.querySelectorAll('.delete-preset-condition').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    deletePresetCondition(index);
                });
            });
        }

        // 添加预设项目
        function addPresetConditionItem() {
            if (presetConditions.length >= 10) {
                alert('最多只能添加10个预设项目');
                return;
            }
            
            const newCondition = prompt('请输入新的预设项目名称:');
            if (newCondition && newCondition.trim()) {
                presetConditions.push(newCondition.trim());
                renderPresetConditionsList();
                renderPresetConditionButtons();
            }
        }

        // 编辑预设项目
        function editPresetCondition(index) {
            const currentValue = presetConditions[index];
            const newValue = prompt('编辑预设项目名称:', currentValue);
            
            if (newValue && newValue.trim()) {
                presetConditions[index] = newValue.trim();
                renderPresetConditionsList();
                renderPresetConditionButtons();
            }
        }

        // 删除预设项目
        function deletePresetCondition(index) {
            UXManager.showConfirm('确定要删除这个预设项目吗？', '删除预设项目').then(confirmed => {
                if (confirmed) {
                    presetConditions.splice(index, 1);
                    renderPresetConditionsList();
                    renderPresetConditionButtons();
                }
            });
        }

        // 保存预设项目
        function savePresetConditions() {
            try {
                DataManager.savePresetConditions();
                closePresetConditionsModal();
                UXManager.showOperationFeedback('预设项目已保存', 'success');
            } catch (error) {
                console.error('保存预设项目失败:', error);
                ErrorLogger.logError('保存预设项目失败', error);
                alert('保存失败，请重试');
            }
        }

        // ========== 二维码扫描功能 ==========
        function openQRScanModal() {
            console.log('打开二维码扫描模态框');
            
            qrScanModal.classList.remove('hidden');
            setTimeout(function() {
                qrScanModalContent.classList.remove('scale-95', 'opacity-0');
                qrScanModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            startQRScanning();
        }

        function closeQRScanModal() {
            console.log('关闭二维码扫描模态框');

            stopQRScanning();
            
            qrScanModalContent.classList.remove('scale-100', 'opacity-100');
            qrScanModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                qrScanModal.classList.add('hidden');
                qrResult.classList.add('hidden');
            }, 300);
        }

        function startQRScanning() {
            if (qrScanning) return;
            
            qrScanning = true;
            
            // 获取摄像头访问权限
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: currentFacingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            }).then(function(stream) {
                qrStream = stream;
                qrVideo.srcObject = stream;
                qrVideo.play();
                
                // 开始扫描
                scanQRCode();
            }).catch(function(error) {
                console.error('无法访问摄像头:', error);
                ErrorLogger.logError('无法访问摄像头', error);
                alert('无法访问摄像头，请确保已授予摄像头权限');
                qrScanning = false;
            });
        }

        function stopQRScanning() {
            qrScanning = false;
            
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
            
            if (qrVideo.srcObject) {
                qrVideo.srcObject = null;
            }
        }

        function scanQRCode() {
            if (!qrScanning) return;
            
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                qrCanvas.width = qrVideo.videoWidth;
                qrCanvas.height = qrVideo.videoHeight;
                
                const ctx = qrCanvas.getContext('2d');
                ctx.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
                
                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    // 找到二维码
                    handleQRResult(code.data);
                    return;
                }
            }
            
            // 继续扫描
            requestAnimationFrame(scanQRCode);
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            
            // 重新启动扫描
            stopQRScanning();
            setTimeout(startQRScanning, 100);
        }

        function handleQRImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    qrCanvas.width = img.width;
                    qrCanvas.height = img.height;
                    
                    const ctx = qrCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        handleQRResult(code.data);
                    } else {
                        alert('未在图片中检测到二维码');
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // 重置文件输入
            qrImageInput.value = '';
        }

        function handleQRResult(data) {
            console.log('二维码扫描结果:', data);
            
            qrResultText.textContent = data;
            qrResult.classList.remove('hidden');
            
            // 停止扫描
            stopQRScanning();
            
            // 自动填充搜索框
            searchInput.value = data;
            searchTerm = data.toLowerCase();
            renderDevices();
            
            // 3秒后关闭模态框
            setTimeout(closeQRScanModal, 3000);
        }

        // ========== 图片管理功能 ==========
        function openImageManagementModal(deviceIndex) {
            console.log('打开图片管理模态框，设备索引:', deviceIndex);
            
            currentImageDeviceIndex = deviceIndex;
            renderDeviceImages(deviceIndex);
            
            imageManagementModal.classList.remove('hidden');
            setTimeout(function() {
                imageManagementModalContent.classList.remove('scale-95', 'opacity-0');
                imageManagementModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeImageManagementModalFunc() {
            console.log('关闭图片管理模态框');

            imageManagementModalContent.classList.remove('scale-100', 'opacity-100');
            imageManagementModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                imageManagementModal.classList.add('hidden');
                currentImageDeviceIndex = -1;
            }, 300);
        }

        function renderDeviceImages(deviceIndex) {
            deviceImagesList.innerHTML = '';
            
            const device = devices[deviceIndex];
            if (!device.images || device.images.length === 0) {
                deviceImagesList.innerHTML = '<div class="col-span-3 text-center py-4 text-gray-500">暂无图片</div>';
                return;
            }
            
            device.images.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'device-image-item';
                imageItem.innerHTML = `
                    <img src="${image.data}" class="device-image" data-image-id="${image.id}" alt="设备图片">
                    <button class="delete-image-btn touch-button">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                deviceImagesList.appendChild(imageItem);
                
                // 添加删除事件
                const deleteBtn = imageItem.querySelector('.delete-image-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteDeviceImage(deviceIndex, image.id);
                });
                
                // 添加预览事件
                const img = imageItem.querySelector('.device-image');
                img.addEventListener('click', function() {
                    openImagePreview(deviceIndex, image.id);
                });
            });
        }

        function handleImageFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    addDeviceImageFromFile(e.target.result);
                };
                reader.readAsDataURL(file);
            });
            
            // 重置文件输入
            imageFileInput.value = '';
        }

        async function addDeviceImageFromFile(imageData) {
            if (currentImageDeviceIndex === -1) return;
            
            try {
                await DataManager.addDeviceImage(currentImageDeviceIndex, imageData);
                renderDeviceImages(currentImageDeviceIndex);
                EventManager.refreshUI();
                UXManager.showOperationFeedback('图片已添加', 'success');
            } catch (error) {
                console.error('添加图片失败:', error);
                ErrorLogger.logError('添加图片失败', error);
                alert('添加图片失败，请重试');
            }
        }

        function deleteDeviceImage(deviceIndex, imageId) {
            UXManager.showConfirm('确定要删除这张图片吗？', '删除图片').then(confirmed => {
                if (confirmed) {
                    const success = DataManager.removeDeviceImage(deviceIndex, imageId);
                    if (success) {
                        renderDeviceImages(deviceIndex);
                        EventManager.refreshUI();
                        UXManager.showOperationFeedback('图片已删除', 'success');
                    }
                }
            });
        }

        function openImagePreview(deviceIndex, imageId) {
            const device = devices[deviceIndex];
            const image = device.images.find(img => img.id === imageId);
            
            if (!image) return;
            
            previewImage.src = image.data;
            imagePreviewModal.classList.remove('hidden');
        }

        function closeImagePreviewModal() {
            imagePreviewModal.classList.add('hidden');
            previewImage.src = '';
        }

        function takePhoto() {
            closeImageManagementModalFunc();
            
            setTimeout(() => {
                cameraModal.classList.remove('hidden');
                
                // 访问摄像头
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                }).then(function(stream) {
                    currentCameraStream = stream;
                    cameraPreview.srcObject = stream;
                }).catch(function(error) {
                    console.error('无法访问摄像头:', error);
                    ErrorLogger.logError('无法访问摄像头', error);
                    alert('无法访问摄像头，请确保已授予摄像头权限');
                    closeCameraModal();
                });
            }, 300);
        }

        function closeCameraModal() {
            cameraModal.classList.add('hidden');
            
            if (currentCameraStream) {
                currentCameraStream.getTracks().forEach(track => track.stop());
                currentCameraStream = null;
            }
            
            if (cameraPreview.srcObject) {
                cameraPreview.srcObject = null;
            }
            
            // 重新打开图片管理模态框
            if (currentImageDeviceIndex !== -1) {
                setTimeout(() => {
                    openImageManagementModal(currentImageDeviceIndex);
                }, 300);
            }
        }

        function capturePhoto() {
            if (!currentCameraStream) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            
            closeCameraModal();
            
            // 添加图片到设备
            setTimeout(() => {
                if (currentImageDeviceIndex !== -1) {
                    addDeviceImageFromFile(imageData);
                }
            }, 300);
        }

        // ========== 坐标定位功能 ==========
        function handleGetCurrentLocation() {
            getCurrentLocation(-1); // -1 表示添加设备模态框
        }

        function handleEditGetCurrentLocation() {
            const deviceIndex = parseInt(editDeviceIndexInput.value);
            if (!isNaN(deviceIndex)) {
                getCurrentLocation(deviceIndex);
            }
        }

        function getCurrentLocation(deviceIndex) {
            if (!navigator.geolocation) {
                alert('您的浏览器不支持地理位置功能');
                return;
            }
            
            UXManager.setLoadingState(true, '获取当前位置中...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    console.log('获取到当前位置:', latitude, longitude);
                    
                    if (deviceIndex === -1) {
                        // 添加设备模态框
                        deviceInstallLatitudeInput.value = CoordinateUtils.formatCoordinate(latitude);
                        deviceInstallLongitudeInput.value = CoordinateUtils.formatCoordinate(longitude);
                    } else {
                        // 编辑设备模态框
                        editDeviceInstallLatitudeInput.value = CoordinateUtils.formatCoordinate(latitude);
                        editDeviceInstallLongitudeInput.value = CoordinateUtils.formatCoordinate(longitude);
                        
                        // 更新设备定位数据
                        DataManager.updateDeviceLocation(deviceIndex, {
                            latitude: latitude,
                            longitude: longitude,
                            timestamp: new Date().toISOString()
                        });
                        
                        // 刷新UI以显示新的坐标
                        EventManager.refreshUI();
                    }
                    
                    UXManager.setLoadingState(false);
                    UXManager.showOperationFeedback('位置获取成功', 'success');
                },
                function(error) {
                    console.error('获取位置失败:', error);
                    ErrorLogger.logError('获取位置失败', error);
                    
                    let errorMessage = '获取位置失败';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置访问被拒绝，请在浏览器设置中允许位置访问';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置信息不可用';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '获取位置超时';
                            break;
                    }
                    
                    UXManager.setLoadingState(false);
                    alert(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // ========== 错误日志功能 ==========
        function openErrorLogModal() {
            console.log('打开错误日志模态框');
            
            renderErrorLogs();
            
            errorLogModal.classList.remove('hidden');
            setTimeout(function() {
                errorLogModalContent.classList.remove('scale-95', 'opacity-0');
                errorLogModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeErrorLogModalFunc() {
            console.log('关闭错误日志模态框');

            errorLogModalContent.classList.remove('scale-100', 'opacity-100');
            errorLogModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                errorLogModal.classList.add('hidden');
            }, 300);
        }

        function renderErrorLogs() {
            const logs = ErrorLogger.getErrorLogs();
            
            if (logs.length === 0) {
                errorLogList.innerHTML = '<div class="text-center py-4 text-gray-500">暂无错误记录</div>';
                return;
            }
            
            errorLogList.innerHTML = logs.map(log => `
                <div class="error-log-item">
                    <div class="error-log-time">${new Date(log.timestamp).toLocaleString()}</div>
                    <div class="error-log-message">${log.message}</div>
                    ${log.error ? `<div class="text-red-500 text-xs mt-1">${log.error}</div>` : ''}
                    ${log.stack ? `<details class="mt-1"><summary class="text-xs cursor-pointer">查看详情</summary><pre class="text-xs mt-1 overflow-auto">${log.stack}</pre></details>` : ''}
                </div>
            `).join('');
        }

        function clearErrorLog() {
            UXManager.showConfirm('确定要清空所有错误日志吗？', '清空错误日志').then(confirmed => {
                if (confirmed) {
                    ErrorLogger.clearErrorLogs();
                    renderErrorLogs();
                    UXManager.showOperationFeedback('错误日志已清空', 'success');
                }
            });
        }

        // ========== 定位偏离范围设置功能 ==========
        function saveLocationDeviationRange() {
            const newRange = parseInt(locationDeviationRangeInput.value);
            
            if (isNaN(newRange) || newRange < 1 || newRange > 1000) {
                alert('请输入1-1000之间的有效数值');
                return;
            }
            
            locationDeviationRange = newRange;
            
            try {
                DataManager.saveLocationDeviationRange();
                UXManager.showOperationFeedback(`定位偏离范围已设置为${newRange}米`, 'success');
                // 刷新设备列表以更新坐标匹配状态
                EventManager.refreshUI();
            } catch (error) {
                console.error('保存定位偏离范围失败:', error);
                ErrorLogger.logError('保存定位偏离范围失败', error);
                alert('保存失败，请重试');
            }
        }

        // ========== 工具函数 ==========

        // 获取当前日期
        function getCurrentDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        // 获取当前日期时间
        function getCurrentDateTime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var hours = String(now.getHours()).padStart(2, '0');
            var minutes = String(now.getMinutes()).padStart(2, '0');
            var seconds = String(now.getSeconds()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        // 获取用于文件名的当前日期时间
        function getCurrentDateTimeForFileName() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var hours = String(now.getHours()).padStart(2, '0');
            var minutes = String(now.getMinutes()).padStart(2, '0');
            return year + month + day + '_' + hours + minutes;
        }

        // 格式化显示日期
        function formatDisplayDate(dateStr) {
            var date = new Date(dateStr);
            var today = new Date();
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return '今天 (' + dateStr + ')';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return '昨天 (' + dateStr + ')';
            } else {
                return dateStr;
            }
        }

        // 显示错误信息
        function showError(message, errorElementId) {
            var errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            } else {
                alert(message);
            }
        }

        // 显示成功信息
        function showSuccess(message) {
            UXManager.showOperationFeedback(message, 'success');
        }

        // 显示加载指示器
        function showLoading(message = '加载中...') {
            const messageElement = loadingIndicator.querySelector('span');
            messageElement.textContent = message;
            loadingIndicator.classList.remove('hidden');
        }

        // 隐藏加载指示器
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }
    </script>
</body>

</html>