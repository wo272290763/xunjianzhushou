<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巡检助手 - 专业设备巡检管理工具</title>
    
    <!-- 标准OG标签 - 适配Facebook、LinkedIn等 -->
    <meta property="og:title" content="巡检助手 - 专业设备巡检管理工具" />
    <meta property="og:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作" />
    <meta property="og:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg?v=2" />
    <meta property="og:url" content="https://wo272290763.github.io/xunjianzhushou/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="巡检助手" />
    <meta property="og:locale" content="zh_CN" />

    <!-- 图片尺寸声明（适配微信） -->
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- 腾讯系专用标签（QQ/微信） -->
    <meta itemprop="name" content="巡检助手 - 专业设备巡检管理工具">
    <meta itemprop="description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta itemprop="image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg?v=2">

    <!-- 微信专用补充标签 -->
    <meta property="wechat:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta property="wechat:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta property="wechat:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg?v=2">

    <!-- 微博专用标签 -->
    <meta property="weibo:webpage" content="article">
    <meta name="weibo:card" content="summary_large_image">
    <meta property="weibo:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta property="weibo:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告">
    <meta property="weibo:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">

    <!-- 百度/头条系标签 -->
    <meta name="baidu:title" content="巡检助手 - 专业设备巡检管理工具">
    <meta name="baidu:description" content="高效管理设备巡检任务，实时记录设备状态，自动生成巡检报告，支持移动端操作">
    <meta name="baidu:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="巡检助手 - 设备巡检管理工具">
    <meta name="twitter:description" content="便捷管理设备巡检任务，记录设备状态，生成巡检报告">
    <meta name="twitter:image" content="https://wo272290763.github.io/xunjianzhushou/images/og-image.jpg">
    <meta name="twitter:site" content="@yourtwitterhandle">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用可靠的Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        normal: '#10B981',
                        abnormal: '#EF4444',
                        pending: '#9CA3AF',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                        button: '#4F46E5'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .device-card-shadow {
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .condition-item {
                @apply transition-all duration-300 ease-in-out rounded-lg cursor-pointer;
            }

            .btn-hover-effect {
                @apply transition-all duration-200 transform hover:scale-105 active:scale-95;
            }

            .text-balance {
                text-wrap: balance;
            }

            .hidden {
                display: none;
            }
            
            .preset-btn {
                @apply px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors;
            }
            
            .record-date {
                @apply text-lg font-bold text-gray-700 pb-2 mb-3 border-b border-gray-200 flex items-center justify-between cursor-pointer;
            }
            
            .record-date i {
                @apply transition-transform duration-300;
            }
            
            .icon-btn {
                @apply p-2 rounded-lg bg-white/80 hover:bg-white text-dark transition-colors flex items-center justify-center;
                min-width: 40px;
                min-height: 40px;
            }
            
            .edit-modal-container {
                @apply max-h-[60vh] overflow-y-auto;
            }
            
            /* 添加滚动条样式 */
            .modal-scroll-container {
                @apply max-h-[70vh] overflow-y-auto pr-2;
            }
            
            /* 自定义滚动条 */
            .modal-scroll-container::-webkit-scrollbar {
                width: 6px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 10px;
            }
            
            .modal-scroll-container::-webkit-scrollbar-thumb:hover {
                background: #a1a1a1;
            }
            
            /* 底部导航栏样式 */
            .bottom-nav {
                @apply fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200;
                height: 60px;
                z-index: 40;
            }
            
            .nav-btn {
                @apply flex flex-col items-center justify-center h-full text-xs;
            }
            
            .nav-btn.active {
                @apply text-primary;
            }
            
            .nav-btn i {
                @apply text-xl mb-1;
            }
            
            /* 修复所有按钮尺寸问题 */
            .fixed-size-btn {
                min-width: 40px;
                min-height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            /* 新的迷你卡片进度条样式 */
            .mini-progress-overlay {
                @apply absolute inset-0 z-0 rounded-lg;
                background: linear-gradient(90deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.25) var(--progress), transparent var(--progress), transparent 100%);
                transition: background 0.5s ease;
            }
            
            .mini-card-content {
                @apply relative z-10;
            }

            /* 深色模式适配 */
            @media (prefers-color-scheme: dark) {
                .mini-progress-overlay {
                    background: linear-gradient(90deg, rgba(59, 130, 246, 0.4) 0%, rgba(59, 130, 246, 0.4) var(--progress), transparent var(--progress), transparent 100%);
                }
            }
            
            .profile-card-btn {
                @apply w-full py-3 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2;
            }
            
            /* 日期进度条样式 */
            .date-progress-bar {
                @apply w-full bg-gray-200 rounded-full h-1.5 mb-3;
            }
            
            .date-progress-fill {
                @apply bg-primary h-1.5 rounded-full;
            }
            
            /* 搜索栏样式 */
            .search-container {
                @apply bg-white rounded-lg shadow-sm p-3 mb-4 transition-all duration-300;
            }
            
            .search-input {
                @apply w-full px-4 py-2 pl-10 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all;
            }
            
            .search-icon {
                @apply absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400;
            }
            
            .no-results {
                @apply text-center py-8 text-gray-500;
            }
            
            /* 确保所有图标可见 */
            .fa {
                display: inline-block !important;
                font-style: normal !important;
                font-variant: normal !important;
                text-rendering: auto !important;
                -webkit-font-smoothing: antialiased !important;
            }
            
            /* 设备信息网格布局 */
            .device-info-grid {
                @apply grid grid-cols-2 gap-x-2 gap-y-1 text-xs;
            }
            
            .device-info-label {
                @apply text-gray-500;
            }
            
            .device-info-value {
                @apply text-gray-800;
            }

            /* 为展开的卡片添加边框 */
            .expanded-card {
                border: 2px solid rgba(59, 130, 246, 0.5);
            }

            /* 深色模式下调整边框颜色 */
            @media (prefers-color-scheme: dark) {
                .expanded-card {
                    border: 2px solid rgba(96, 165, 250, 0.7);
                }
            }
            
            /* 新增：加载指示器 */
            .loading-spinner {
                @apply inline-block w-4 h-4 border-2 border-solid border-current border-r-transparent rounded-full animate-spin;
            }
            
            /* 新增：长按反馈样式 */
            .condition-item.long-press-active {
                @apply bg-blue-100 border-blue-300;
            }
            
            /* 新增：兼容性样式 */
            .backdrop-blur-support {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            /* 新增：触摸友好的按钮 */
            .touch-button {
                @apply min-h-[44px] min-w-[44px] flex items-center justify-center;
            }
            
            /* 新增：错误提示样式 */
            .error-message {
                @apply text-red-500 text-sm mt-1;
            }
            
            /* 新增：成功提示样式 */
            .success-message {
                @apply text-green-500 text-sm mt-1;
            }
            
            /* 新增：状态指示器 */
            .status-indicator {
                @apply w-2.5 h-2.5 rounded-full mr-1;
            }
            
            .status-pending {
                @apply bg-pending;
            }
            
            .status-normal {
                @apply bg-normal;
            }
            
            .status-abnormal {
                @apply bg-abnormal;
            }

            /* 新增：操作反馈样式 */
            .operation-feedback {
                @apply fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans pb-16">
    <!-- 加载指示器 -->
    <div id="loading-indicator" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-gray-700">加载中...</span>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-4">
        <!-- 顶部标题栏 -->
        <header class="mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-dark flex items-center">
                        <i class="fa-solid fa-clipboard-check text-primary mr-2"></i>
                        巡检助手
                    </h1>
                </div>
                <div class="flex space-x-2" id="top-right-buttons">
                    <button id="add-device-btn" class="icon-btn fixed-size-btn touch-button" title="添加设备">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button id="confirm-all-btn" class="icon-btn fixed-size-btn touch-button" title="确认所有">
                        <i class="fa-solid fa-check"></i>
                    </button>
                    <button id="refresh-all-btn" class="icon-btn fixed-size-btn touch-button" title="刷新所有">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main>
            <!-- 设备列表页面 -->
            <div id="device-list-page">
                <!-- 搜索栏 -->
                <div class="search-container">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="搜索计量器具名称、出厂编号或安装地点...">
                    </div>
                </div>
                
                <!-- 空状态提示 -->
                <div id="empty-state" class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <i class="fa-solid fa-clipboard-list text-3xl text-gray-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">暂无巡检设备</h2>
                    <p class="text-gray-500 mb-6">点击上方"+"按钮开始创建巡检任务</p>
                    <button id="empty-add-btn"
                        class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-lg font-medium btn-hover-effect touch-button">
                        <i class="fa-solid fa-plus mr-1"></i>添加第一个设备
                    </button>
                </div>

                <!-- 设备列表容器 -->
                <div id="devices-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- 设备卡片由JS动态生成 -->
                </div>
            </div>

            <!-- 巡检记录页面 -->
            <div id="inspection-records-page" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">巡检记录</h2>
                    <button id="toggle-all-records" class="text-sm text-primary hover:text-primary/80 touch-button">
                        <i class="fa-solid fa-angle-double-down mr-1"></i>展开/收起所有
                    </button>
                </div>
                <div id="inspection-records">
                    <!-- 巡检记录由JS动态生成 -->
                </div>
            </div>

            <!-- 个人中心页面 -->
            <div id="profile-page" class="hidden">
                <div class="text-center py-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <i class="fa-solid fa-user text-3xl text-gray-400"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">个人中心</h2>
                </div>
                <div class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="bg-blue-100 rounded-full p-3">
                            <i class="fa-solid fa-user-circle text-3xl text-blue-600"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-semibold text-lg">管理员</h3>
                            <p class="text-gray-500">admin@example.com</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fa-solid fa-gear text-gray-500 mr-3"></i>
                                <span>系统设置</span>
                            </div>
                            <i class="fa-solid fa-angle-right text-gray-400"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fa-solid fa-bell text-gray-500 mr-3"></i>
                                <span>通知设置</span>
                            </div>
                            <i class="fa-solid fa-angle-right text-gray-400"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fa-solid fa-shield text-gray-500 mr-3"></i>
                                <span>隐私与安全</span>
                            </div>
                            <i class="fa-solid fa-angle-right text-gray-400"></i>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fa-solid fa-circle-question text-gray-500 mr-3"></i>
                                <span>帮助与支持</span>
                            </div>
                            <i class="fa-solid fa-angle-right text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- 新增的导入导出按钮 -->
                    <div class="space-y-4">
                        <button id="profile-export-btn" class="profile-card-btn bg-blue-500 text-white touch-button">
                            <i class="fa-solid fa-download"></i>
                            导出数据
                        </button>
                        <button id="profile-import-btn" class="profile-card-btn bg-blue-500 text-white touch-button">
                            <i class="fa-solid fa-upload"></i>
                            导入数据
                        </button>
                        <!-- 新增：删除所有设备按钮 -->
                        <button id="profile-delete-all-btn" class="profile-card-btn bg-red-500 text-white touch-button">
                            <i class="fa-solid fa-trash"></i>
                            删除所有设备
                        </button>
                    </div>
                    
                    <button class="mt-6 w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors touch-button">
                        退出登录
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="max-w-6xl mx-auto h-full flex justify-around">
            <button id="nav-device-list" class="nav-btn active touch-button" data-page="device-list-page">
                <i class="fa-solid fa-list"></i>
                <span>设备列表</span>
            </button>
            <button id="nav-records" class="nav-btn touch-button" data-page="inspection-records-page">
                <i class="fa-solid fa-history"></i>
                <span>巡检记录</span>
            </button>
            <button id="nav-profile" class="nav-btn touch-button" data-page="profile-page">
                <i class="fa-solid fa-user"></i>
                <span>个人中心</span>
            </button>
        </div>
    </div>

    <!-- 添加设备模态框 -->
    <div id="add-device-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">添加巡检设备</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <form id="add-device-form" onsubmit="return false;">
                        <div class="mb-4">
                            <label for="device-name" class="block text-sm font-medium text-gray-700 mb-1">计量器具名称 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="device-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入计量器具名称" required>
                            <div id="device-name-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="device-category" class="block text-sm font-medium text-gray-700 mb-1">类别 <span
                                    class="text-red-500">*</span></label>
                            <select id="device-category"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                required>
                                <option value="">请选择类别</option>
                                <option value="A类">A类</option>
                                <option value="B类">B类</option>
                                <option value="C类">C类</option>
                            </select>
                            <div id="device-category-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="device-location" class="block text-sm font-medium text-gray-700 mb-1">安装地点 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="device-location"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入安装地点" required>
                            <div id="device-location-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="device-model" class="block text-sm font-medium text-gray-700 mb-1">规格型号</label>
                            <input type="text" id="device-model"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入规格型号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="device-manufacturer" class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="device-manufacturer"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入生产厂家（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="device-serial-number" class="block text-sm font-medium text-gray-700 mb-1">出厂编号</label>
                            <input type="text" id="device-serial-number"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入出厂编号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="inspection-cycle" class="block text-sm font-medium text-gray-700 mb-1">检定周期（月） <span
                                    class="text-red-500">*</span></label>
                            <input type="number" id="inspection-cycle" min="1" max="60"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入检定周期（月）" required>
                            <div id="inspection-cycle-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="device-range" class="block text-sm font-medium text-gray-700 mb-1">测量范围</label>
                            <input type="text" id="device-range"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入测量范围（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="last-inspection-date" class="block text-sm font-medium text-gray-700 mb-1">上次检定日期 <span
                                    class="text-red-500">*</span></label>
                            <input type="date" id="last-inspection-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                required>
                            <div id="last-inspection-date-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">巡检项目 <span
                                    class="text-red-500">*</span></label>
                            <div id="conditions-container">
                                <div class="condition-item mb-3 flex items-center">
                                    <input type="text"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                        required>
                                    <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                                        <i class="fa-solid fa-minus-circle"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 预设项目快速添加 -->
                            <div class="mt-2 mb-3">
                                <p class="text-xs text-gray-500 mb-2">点击添加预设项目：</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="preset-btn touch-button" data-condition="外观">外观</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="检定标签">检定标签</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="显示情况">显示情况</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="接地">接地</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="上限标识">上限标识</button>
                                </div>
                            </div>
                            
                            <button type="button" id="add-condition-btn"
                                class="mt-2 text-primary hover:text-primary/80 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-plus-circle mr-1"></i> 添加自定义项目
                            </button>
                            <p class="text-xs text-gray-500 mt-2">可添加1-5个巡检项目</p>
                            <div id="conditions-error" class="error-message hidden"></div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="cancel-add-device"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                            <button type="button" id="submit-add-device"
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 异常备注模态框 -->
    <div id="remark-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="remark-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">异常备注</h3>
                    <button id="close-remark-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <form id="remark-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="condition-name" class="block text-sm font-medium text-gray-700 mb-1">巡检项目</label>
                        <input type="text" id="condition-name"
                            class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg" readonly>
                    </div>
                    <div class="mb-6">
                        <label for="remark-content" class="block text-sm font-medium text-gray-700 mb-1">异常描述 <span
                                class="text-red-500">*</span></label>
                        <textarea id="remark-content" rows="4"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                            placeholder="请描述异常情况" required></textarea>
                        <div id="remark-content-error" class="error-message hidden"></div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancel-remark"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                        <button type="button" id="submit-remark"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑设备模态框 -->
    <div id="edit-device-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0"
            id="edit-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">编辑巡检设备</h3>
                    <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 fixed-size-btn touch-button">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="modal-scroll-container">
                    <form id="edit-device-form" onsubmit="return false;">
                        <input type="hidden" id="edit-device-index">
                        <div class="mb-4">
                            <label for="edit-device-name" class="block text-sm font-medium text-gray-700 mb-1">计量器具名称 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="edit-device-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入计量器具名称" required>
                            <div id="edit-device-name-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-category" class="block text-sm font-medium text-gray-700 mb-1">类别 <span
                                    class="text-red-500">*</span></label>
                            <select id="edit-device-category"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                required>
                                <option value="">请选择类别</option>
                                <option value="A类">A类</option>
                                <option value="B类">B类</option>
                                <option value="C类">C类</option>
                            </select>
                            <div id="edit-device-category-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-location" class="block text-sm font-medium text-gray-700 mb-1">安装地点 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="edit-device-location"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入安装地点" required>
                            <div id="edit-device-location-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-model" class="block text-sm font-medium text-gray-700 mb-1">规格型号</label>
                            <input type="text" id="edit-device-model"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入规格型号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-manufacturer" class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                            <input type="text" id="edit-device-manufacturer"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入生产厂家（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-serial-number" class="block text-sm font-medium text-gray-700 mb-1">出厂编号</label>
                            <input type="text" id="edit-device-serial-number"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入出厂编号（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-inspection-cycle" class="block text-sm font-medium text-gray-700 mb-1">检定周期（月） <span
                                    class="text-red-500">*</span></label>
                            <input type="number" id="edit-inspection-cycle" min="1" max="60"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入检定周期（月）" required>
                            <div id="edit-inspection-cycle-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-device-range" class="block text-sm font-medium text-gray-700 mb-1">测量范围</label>
                            <input type="text" id="edit-device-range"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                placeholder="请输入测量范围（选填）">
                        </div>
                        <div class="mb-4">
                            <label for="edit-last-inspection-date" class="block text-sm font-medium text-gray-700 mb-1">上次检定日期 <span
                                    class="text-red-500">*</span></label>
                            <input type="date" id="edit-last-inspection-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                                required>
                            <div id="edit-last-inspection-date-error" class="error-message hidden"></div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">巡检项目 <span
                                    class="text-red-500">*</span></label>
                            <div id="edit-conditions-container"></div>
                            
                            <!-- 预设项目快速添加 -->
                            <div class="mt-2 mb-3">
                                <p class="text-xs text-gray-500 mb-2">点击添加预设项目：</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="preset-btn touch-button" data-condition="外观">外观</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="检定标签">检定标签</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="显示情况">显示情况</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="接地">接地</button>
                                    <button type="button" class="preset-btn touch-button" data-condition="上限标识">上限标识</button>
                                </div>
                            </div>
                            
                            <button type="button" id="edit-add-condition-btn"
                                class="mt-2 text-primary hover:text-primary/80 text-sm flex items-center touch-button">
                                <i class="fa-solid fa-plus-circle mr-1"></i> 添加自定义项目
                            </button>
                            <p class="text-xs text-gray-500 mt-2">可添加1-5个巡检项目</p>
                            <div id="edit-conditions-error" class="error-message hidden"></div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="delete-device-btn"
                                class="px-4 py-2 border border-red-500 text-red-500 rounded-lg mr-3 hover:bg-red-50 btn-hover-effect touch-button">删除设备</button>
                            <button type="button" id="cancel-edit-device"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 mr-3 hover:bg-gray-50 btn-hover-effect touch-button">取消</button>
                            <button type="button" id="submit-edit-device"
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover-effect touch-button">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 文件导入输入 -->
    <input type="file" id="file-import" accept=".txt" class="hidden">

    <script>
        // 存储所有设备数据
        let devices = [];
        let currentDeviceId = null;
        let currentConditionIndex = null;
        let expandedDates = {}; // 存储展开状态的日期
        let expandedCardIndex = -1; // 当前展开的卡片索引，-1表示没有展开
        let searchTerm = ''; // 搜索关键词
        let searchTimeout = null; // 搜索防抖定时器
        let renderTimeout = null; // 渲染防抖定时器

        // DOM元素
        let devicesContainer, emptyState, addDeviceBtn, emptyAddBtn, addDeviceModal, modalContent;
        let closeModal, addDeviceForm, conditionsContainer, addConditionBtn, cancelAddDevice;
        let remarkModal, remarkModalContent, closeRemarkModal, remarkForm, conditionNameInput;
        let remarkContentInput, cancelRemark;
        let submitAddDeviceBtn, submitRemarkBtn;
        let refreshAllBtn, editDeviceModal, editModalContent, closeEditModal, editDeviceForm;
        let editDeviceIndexInput, editDeviceNameInput, editDeviceCategoryInput, editDeviceLocationInput;
        let editDeviceModelInput, editDeviceManufacturerInput, editDeviceSerialNumberInput;
        let editDeviceRangeInput, editInspectionCycleInput, editLastInspectionDateInput;
        let editConditionsContainer, editAddConditionBtn, deleteDeviceBtn, cancelEditDevice;
        let submitEditDeviceBtn;
        let inspectionRecordsContainer, toggleAllRecordsBtn;
        let fileImportInput;
        let navDeviceListBtn, navRecordsBtn, navProfileBtn;
        let deviceListPage, inspectionRecordsPage, profilePage;
        let profileExportBtn, profileImportBtn, profileDeleteAllBtn;
        let topRightButtons; // 新增：顶部右侧按钮容器
        let searchInput; // 新增：搜索输入框
        let confirmAllBtn; // 新增：确认所有按钮
        let loadingIndicator; // 新增：加载指示器

        // ========== 日期工具 ==========
        const DateUtils = {
            // 安全的日期计算
            addMonthsToDate(dateStr, months) {
                const date = new Date(dateStr);
                const originalDate = date.getDate();
                
                date.setMonth(date.getMonth() + months);
                
                // 处理月份溢出（如1月31日+1个月）
                if (date.getDate() !== originalDate) {
                    // 如果日期变了，说明是无效日期，设置为上月最后一天
                    date.setDate(0);
                }
                
                return this.formatDate(date);
            },

            // 安全的日期格式化
            formatDate(date) {
                if (!(date instanceof Date) || isNaN(date)) {
                    console.warn('无效的日期对象:', date);
                    return '0000-00-00';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            // 验证日期字符串
            isValidDate(dateStr) {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                return date instanceof Date && !isNaN(date) && dateStr.match(/^\d{4}-\d{2}-\d{2}$/);
            },

            // 获取下一个检定日期
            getNextInspectionDate(lastInspectionDate, inspectionCycle) {
                if (!this.isValidDate(lastInspectionDate)) {
                    console.warn('无效的上次检定日期:', lastInspectionDate);
                    return '日期无效';
                }
                
                try {
                    return this.addMonthsToDate(lastInspectionDate, inspectionCycle);
                } catch (error) {
                    console.error('计算下次检定日期失败:', error);
                    return '计算失败';
                }
            },

            // 检查是否在指定天数内
            isWithinDays(dateStr, days) {
                if (!this.isValidDate(dateStr)) return false;
                
                const targetDate = new Date(dateStr);
                const now = new Date();
                const diffTime = targetDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= days && diffDays >= 0;
            }
        };

        // ========== 状态管理器 ==========
        const StatusManager = {
            // 统一获取设备状态
            getDeviceStatus(device) {
                const today = getCurrentDate();
                let normalCount = 0;
                let abnormalCount = 0;
                let lastInspectionTime = null;

                device.conditions.forEach(condition => {
                    const isToday = condition.inspectionTime && condition.inspectionTime.startsWith(today);
                    
                    if (isToday) {
                        if (condition.status === 'normal') normalCount++;
                        if (condition.status === 'abnormal') abnormalCount++;
                    }

                    // 更新最后巡检时间
                    if (condition.inspectionTime) {
                        const conditionTime = new Date(condition.inspectionTime);
                        if (!lastInspectionTime || conditionTime > lastInspectionTime) {
                            lastInspectionTime = conditionTime;
                        }
                    }
                });

                const totalCount = device.conditions.length;
                const pendingCount = totalCount - normalCount - abnormalCount;
                const progress = totalCount > 0 ? Math.round((normalCount + abnormalCount) / totalCount * 100) : 0;

                return {
                    normal: normalCount,
                    abnormal: abnormalCount,
                    pending: pendingCount,
                    total: totalCount,
                    progress: progress,
                    lastInspectionTime: lastInspectionTime,
                    isFullyCompleted: (normalCount + abnormalCount) === totalCount
                };
            },

            // 统一获取条件显示状态
            getConditionDisplay(condition) {
                const today = getCurrentDate();
                const isToday = condition.inspectionTime && condition.inspectionTime.startsWith(today);
                const displayStatus = isToday ? condition.status : 'pending';
                const timeDisplay = isToday ? (condition.inspectionTime.split(' ')[1]?.substr(0, 5) || '') : '';

                const statusConfig = {
                    normal: {
                        statusClass: 'status-normal',
                        className: 'bg-green-50',
                        borderColor: 'border-green-100',
                        textColor: 'text-green-800'
                    },
                    abnormal: {
                        statusClass: 'status-abnormal',
                        className: 'bg-red-50',
                        borderColor: 'border-red-100',
                        textColor: 'text-red-800'
                    },
                    pending: {
                        statusClass: 'status-pending',
                        className: 'bg-gray-50',
                        borderColor: 'border-gray-100',
                        textColor: 'text-gray-800'
                    }
                };

                const config = statusConfig[displayStatus];

                return {
                    status: displayStatus,
                    ...config,
                    timeDisplay: timeDisplay,
                    isToday: isToday
                };
            },

            // 统一获取最后巡检信息
            getLastInspectionDisplay(device) {
                const today = getCurrentDate();
                const status = this.getDeviceStatus(device);
                
                if (!status.lastInspectionTime) {
                    return {
                        date: '暂无',
                        time: '巡检',
                        colorClass: 'text-red-600'
                    };
                }

                const lastTime = status.lastInspectionTime;
                const isToday = lastTime.toDateString() === new Date().toDateString();
                const month = String(lastTime.getMonth() + 1).padStart(2, '0');
                const day = String(lastTime.getDate()).padStart(2, '0');
                const hours = String(lastTime.getHours()).padStart(2, '0');
                const minutes = String(lastTime.getMinutes()).padStart(2, '0');

                let colorClass = 'text-blue-600';
                if (isToday) colorClass = 'text-green-600';
                else if (lastTime.toDateString() === new Date(Date.now() - 86400000).toDateString()) {
                    colorClass = 'text-orange-600';
                }

                return {
                    date: isToday ? '今日' : `${month}.${day}`,
                    time: `${hours}:${minutes}`,
                    colorClass: colorClass
                };
            }
        };

        // ========== 数据管理器 ==========
        const DataManager = {
            // 改进的加载函数
            loadDevices() {
                try {
                    const savedDevices = localStorage.getItem('inspection_devices');
                    if (savedDevices) {
                        const parsedDevices = JSON.parse(savedDevices);
                        // 数据迁移和兼容性处理
                        devices = this.migrateDeviceData(parsedDevices);
                        console.log(`从本地存储加载了 ${devices.length} 个设备`);
                    } else {
                        console.log('本地存储中没有设备数据');
                        devices = [];
                        // 不自动添加示例数据，让用户选择
                    }
                } catch (error) {
                    console.error('加载设备数据失败:', error);
                    // 尝试恢复数据
                    devices = this.tryRecoverData();
                    showError('加载设备数据失败，已尝试恢复最近备份');
                }
            },

            // 数据迁移：确保新版本兼容旧数据
            migrateDeviceData(parsedDevices) {
                return parsedDevices.map(device => {
                    // 确保所有必要字段都存在
                    return {
                        id: device.id || this.generateDeviceId(device),
                        name: device.name || '未命名设备',
                        category: device.category || '未分类',
                        location: device.location || '未知位置',
                        model: device.model || '',
                        manufacturer: device.manufacturer || '',
                        serialNumber: device.serialNumber || '',
                        range: device.range || '',
                        lastInspectionDate: device.lastInspectionDate || new Date().toISOString().split('T')[0],
                        inspectionCycle: device.inspectionCycle || 12,
                        conditions: (device.conditions || []).map(condition => ({
                            id: condition.id || this.generateConditionId(condition),
                            name: condition.name || '未命名项目',
                            status: condition.status || 'pending',
                            remark: condition.remark || '',
                            inspectionTime: condition.inspectionTime || '',
                            history: condition.history || []
                        })),
                        createdAt: device.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                });
            },

            // 生成设备ID
            generateDeviceId(device) {
                return `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            },

            // 生成条件ID
            generateConditionId(condition) {
                return `condition_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            },

            // 数据恢复尝试
            tryRecoverData() {
                try {
                    // 尝试从备份恢复
                    const backup = localStorage.getItem('inspection_devices_backup');
                    if (backup) {
                        return JSON.parse(backup);
                    }
                } catch (e) {
                    console.error('恢复备份失败:', e);
                }
                return [];
            },

            // 创建数据备份
            createBackup() {
                try {
                    localStorage.setItem('inspection_devices_backup', JSON.stringify(devices));
                    console.log('数据备份已创建');
                } catch (error) {
                    console.error('创建备份失败:', error);
                }
            },

            // 统一更新条件状态
            updateCondition(deviceIndex, conditionIndex, status, remark = '') {
                const condition = devices[deviceIndex].conditions[conditionIndex];
                const oldStatus = condition.status;
                
                condition.status = status;
                condition.remark = remark;
                
                // 只有在状态变化时更新时间戳
                if (status !== 'pending' && oldStatus !== status) {
                    condition.inspectionTime = getCurrentDateTime();
                    
                    // 保存到历史记录
                    this.saveToHistory(condition);
                } else if (status === 'pending') {
                    condition.inspectionTime = '';
                }

                console.log(`更新条件状态: 设备=${deviceIndex}, 条件=${conditionIndex}, 状态=${status}`);
                
                // 自动保存
                this.saveDevices();
                return true;
            },

            // 保存到历史记录
            saveToHistory(condition) {
                const today = getCurrentDate();
                if (!condition.history) condition.history = [];
                
                // 检查是否已有今天的历史记录
                const existingIndex = condition.history.findIndex(h => h.date === today);
                const historyRecord = {
                    date: today,
                    status: condition.status,
                    remark: condition.remark,
                    inspectionTime: condition.inspectionTime
                };

                if (existingIndex !== -1) {
                    condition.history[existingIndex] = historyRecord;
                } else {
                    condition.history.push(historyRecord);
                }
            },

            // 统一保存设备数据
            saveDevices() {
                try {
                    localStorage.setItem('inspection_devices', JSON.stringify(devices));
                    console.log(`已保存 ${devices.length} 个设备到本地存储`);
                } catch (error) {
                    console.error('保存设备数据失败:', error);
                    if (error.name === 'QuotaExceededError') {
                        this.cleanupOldData();
                    }
                    throw error;
                }
            },

            // 清理旧数据
            cleanupOldData() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                devices.forEach(device => {
                    device.conditions.forEach(condition => {
                        if (condition.history) {
                            condition.history = condition.history.filter(record => 
                                new Date(record.date) >= thirtyDaysAgo
                            );
                        }
                    });
                });
                
                this.saveDevices();
                console.log('已清理30天前的历史数据');
            }
        };

        // ========== 事件管理器 ==========
        const EventManager = {
            init() {
                this.setupDeviceEvents();
                this.setupModalEvents();
                this.setupNavigationEvents();
                this.setupGlobalEvents();
            },

            // 设置全局事件
            setupGlobalEvents() {
                // 页面可见性变化时保存数据
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        DataManager.createBackup();
                    }
                });

                // 页面卸载前保存数据
                window.addEventListener('beforeunload', () => {
                    DataManager.createBackup();
                });

                // 错误监控
                window.addEventListener('error', (e) => {
                    console.error('全局错误:', e.error);
                    this.handleGlobalError(e.error);
                });

                // Promise rejection 监控
                window.addEventListener('unhandledrejection', (e) => {
                    console.error('未处理的Promise拒绝:', e.reason);
                    this.handleGlobalError(e.reason);
                });
            },

            // 全局错误处理
            handleGlobalError(error) {
                // 可以在这里上报错误或显示友好提示
                console.error('应用程序错误:', error);
                
                // 自动保存数据备份
                DataManager.createBackup();
                
                // 显示友好错误提示（可选）
                if (!this.errorShown) {
                    this.errorShown = true;
                    setTimeout(() => {
                        showError('应用程序遇到问题，数据已自动备份');
                        this.errorShown = false;
                    }, 1000);
                }
            },

            // 设备相关事件委托
            setupDeviceEvents() {
                // 设备容器事件委托
                devicesContainer.addEventListener('click', (e) => {
                    this.handleDeviceContainerClick(e);
                });

                // 设备容器长按事件
                devicesContainer.addEventListener('touchstart', (e) => {
                    this.handleLongPressStart(e);
                }, { passive: false });

                devicesContainer.addEventListener('mousedown', (e) => {
                    this.handleLongPressStart(e);
                });

                // 结束长按
                ['touchend', 'mouseup', 'mouseleave'].forEach(eventType => {
                    devicesContainer.addEventListener(eventType, (e) => {
                        this.handleLongPressEnd(e);
                    });
                });
            },

            // 处理设备容器点击
            handleDeviceContainerClick(e) {
                const target = e.target;
                
                // 条件项点击
                const conditionItem = target.closest('.condition-item');
                if (conditionItem) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(conditionItem);
                    const conditionIndex = parseInt(conditionItem.dataset.index);
                    if (!isNaN(deviceIndex) && !isNaN(conditionIndex)) {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'normal');
                        this.refreshUI();
                    }
                    return;
                }

                // 刷新按钮
                const refreshBtn = target.closest('.refresh-device');
                if (refreshBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(refreshBtn);
                    if (!isNaN(deviceIndex)) {
                        this.refreshSingleDevice(deviceIndex);
                    }
                    return;
                }

                // 编辑按钮
                const editBtn = target.closest('.edit-device');
                if (editBtn) {
                    e.stopPropagation();
                    const deviceIndex = this.getDeviceIndex(editBtn);
                    if (!isNaN(deviceIndex)) {
                        openEditDeviceModal(deviceIndex);
                    }
                    return;
                }

                // 卡片点击（展开/折叠）
                const deviceCard = target.closest('.device-card-shadow');
                if (deviceCard && !conditionItem && !refreshBtn && !editBtn) {
                    const deviceIndex = this.getDeviceIndex(deviceCard);
                    this.toggleDeviceCard(deviceCard, deviceIndex);
                }
            },

            // 改进的长按处理
            longPressTimers: new Map(),
            longPressThreshold: 500,

            handleLongPressStart(e) {
                const conditionItem = e.target.closest('.condition-item');
                if (!conditionItem) return;

                e.preventDefault();
                e.stopPropagation();

                // 添加触觉反馈（如果支持）
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }

                const deviceIndex = this.getDeviceIndex(conditionItem);
                const conditionIndex = parseInt(conditionItem.dataset.index);
                
                if (isNaN(deviceIndex) || isNaN(conditionIndex)) return;

                conditionItem.classList.add('long-press-active');

                const timerId = setTimeout(() => {
                    this.executeLongPress(deviceIndex, conditionIndex, conditionItem);
                }, this.longPressThreshold);

                this.longPressTimers.set(conditionItem, timerId);
            },

            executeLongPress(deviceIndex, conditionIndex, conditionItem) {
                DataManager.updateCondition(deviceIndex, conditionIndex, 'abnormal');
                currentDeviceId = deviceIndex;
                currentConditionIndex = conditionIndex;
                
                this.refreshUI();
                openRemarkModal(devices[deviceIndex].conditions[conditionIndex].name);
                conditionItem.classList.remove('long-press-active');
                
                // 清理计时器
                this.longPressTimers.delete(conditionItem);
            },

            handleLongPressEnd(e) {
                const conditionItem = e.target.closest('.condition-item');
                if (!conditionItem) return;

                this.cancelLongPress(conditionItem);
            },

            cancelLongPress(conditionItem) {
                const timerId = this.longPressTimers.get(conditionItem);
                if (timerId) {
                    clearTimeout(timerId);
                    this.longPressTimers.delete(conditionItem);
                }
                conditionItem.classList.remove('long-press-active');
            },

            // 清理所有计时器
            cleanupAllTimers() {
                this.longPressTimers.forEach((timerId, conditionItem) => {
                    clearTimeout(timerId);
                    conditionItem.classList.remove('long-press-active');
                });
                this.longPressTimers.clear();
            },

            // 辅助方法
            getDeviceIndex(element) {
                const card = element.closest('.device-card-shadow');
                if (!card) return -1;
                
                // 使用 data-device-index 属性
                const index = parseInt(card.dataset.deviceIndex);
                return isNaN(index) ? -1 : index;
            },

            toggleDeviceCard(card, index) {
                if (index !== expandedCardIndex) {
                    // 收起所有卡片
                    const allCards = devicesContainer.querySelectorAll('.device-card-shadow');
                    allCards.forEach((c, i) => {
                        if (i !== index) this.setCardExpanded(c, false);
                    });
                    
                    // 展开当前卡片
                    this.setCardExpanded(card, true);
                    expandedCardIndex = index;
                }
            },

            setCardExpanded(card, isExpanded) {
                const progressOverlay = card.querySelector('.mini-progress-overlay');
                const miniInspectionInfo = card.querySelector('.mini-inspection-info');
                const expandedContent = card.querySelector('.expanded-content');
                
                if (isExpanded) {
                    progressOverlay.classList.add('hidden');
                    miniInspectionInfo.classList.add('hidden');
                    expandedContent.classList.remove('hidden');
                    card.classList.add('expanded-card');
                } else {
                    progressOverlay.classList.remove('hidden');
                    miniInspectionInfo.classList.remove('hidden');
                    expandedContent.classList.add('hidden');
                    card.classList.remove('expanded-card');
                }
            },

            refreshSingleDevice(index) {
                const today = getCurrentDate();
                devices[index].conditions.forEach((condition, condIndex) => {
                    if (condition.inspectionTime && condition.inspectionTime.startsWith(today)) {
                        DataManager.updateCondition(index, condIndex, 'pending', '');
                    }
                });
                this.refreshUI();
                showSuccess('设备巡检状态已刷新');
            },

            refreshUI() {
                renderDevices();
                renderInspectionRecords();
            },

            setupModalEvents() {
                // 模态框预设按钮事件 - 使用一次性绑定
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('preset-btn')) {
                        const condition = e.target.getAttribute('data-condition');
                        const isEditModal = e.target.closest('#edit-device-modal');
                        
                        if (isEditModal) {
                            editAddPresetCondition(condition);
                        } else {
                            addPresetCondition(condition);
                        }
                    }
                });
            },

            setupNavigationEvents() {
                // 导航按钮事件
                navDeviceListBtn.addEventListener('click', () => switchPage('device-list-page'));
                navRecordsBtn.addEventListener('click', () => switchPage('inspection-records-page'));
                navProfileBtn.addEventListener('click', () => switchPage('profile-page'));
                
                // 搜索事件 - 添加防抖
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchTerm = e.target.value.toLowerCase();
                        renderDevices();
                    }, 300);
                });
            }
        };

        // ========== 性能优化管理器 ==========
        const PerformanceManager = {
            // 防抖函数
            debounce(func, wait, immediate = false) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        timeout = null;
                        if (!immediate) func(...args);
                    };
                    const callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func(...args);
                };
            },

            // 节流函数
            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },

            // 内存监控
            monitorMemory() {
                if (performance.memory) {
                    const memory = performance.memory;
                    const used = Math.round(memory.usedJSHeapSize / 1048576);
                    const limit = Math.round(memory.jsHeapSizeLimit / 1048576);
                    
                    if (used > limit * 0.8) {
                        console.warn('内存使用过高，建议清理数据');
                        this.cleanupMemory();
                    }
                }
            },

            // 内存清理
            cleanupMemory() {
                // 清理过期的计时器
                EventManager.cleanupAllTimers();
                
                // 强制垃圾回收（如果支持）
                if (global.gc) {
                    global.gc();
                }
            }
        };

        // ========== 用户体验管理器 ==========
        const UXManager = {
            // 显示操作反馈
            showOperationFeedback(message, type = 'success') {
                // 移除现有的反馈
                const existingFeedback = document.querySelector('.operation-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                const feedback = document.createElement('div');
                feedback.className = `operation-feedback ${
                    type === 'success' ? 'bg-green-500 text-white' : 
                    type === 'error' ? 'bg-red-500 text-white' : 
                    'bg-blue-500 text-white'
                }`;
                feedback.textContent = message;
                
                document.body.appendChild(feedback);
                
                // 自动隐藏
                setTimeout(() => {
                    feedback.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (feedback.parentNode) {
                            feedback.parentNode.removeChild(feedback);
                        }
                    }, 300);
                }, 3000);
            },

            // 确认对话框
            async showConfirm(message, title = '确认操作') {
                return new Promise((resolve) => {
                    // 创建模态框
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-md mx-4 p-6">
                            <h3 class="text-xl font-bold text-dark mb-4">${title}</h3>
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors cancel-btn">取消</button>
                                <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors confirm-btn">确认</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // 事件处理
                    modal.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(false);
                    });
                    
                    modal.querySelector('.confirm-btn').addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(true);
                    });
                    
                    // ESC键关闭
                    const handleKeydown = (e) => {
                        if (e.key === 'Escape') {
                            document.body.removeChild(modal);
                            document.removeEventListener('keydown', handleKeydown);
                            resolve(false);
                        }
                    };
                    document.addEventListener('keydown', handleKeydown);
                });
            },

            // 加载状态管理
            setLoadingState(isLoading, message = '加载中...') {
                if (isLoading) {
                    showLoading(message);
                } else {
                    hideLoading();
                }
            },

            // 离线状态检测
            initOfflineDetection() {
                window.addEventListener('online', () => {
                    this.showOperationFeedback('网络连接已恢复', 'success');
                });

                window.addEventListener('offline', () => {
                    this.showOperationFeedback('网络连接已断开，请检查网络', 'error');
                });
            }
        };

        // ========== 错误边界管理器 ==========
        const ErrorBoundary = {
            // 包装可能出错的操作
            safeExecute(operation, fallback = null, errorMessage = '操作执行失败') {
                try {
                    return operation();
                } catch (error) {
                    console.error(`${errorMessage}:`, error);
                    UXManager.showOperationFeedback(errorMessage, 'error');
                    return fallback;
                }
            },

            // 重试机制
            async withRetry(operation, maxRetries = 3, delay = 1000) {
                let lastError;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await operation();
                    } catch (error) {
                        lastError = error;
                        console.warn(`操作失败，第${attempt}次重试:`, error);
                        
                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, delay * attempt));
                        }
                    }
                }
                
                throw lastError;
            },

            // 数据验证
            validateDeviceData(device) {
                const errors = [];
                
                if (!device.name || device.name.trim() === '') {
                    errors.push('设备名称不能为空');
                }
                
                if (!device.category) {
                    errors.push('设备类别不能为空');
                }
                
                if (!device.location) {
                    errors.push('安装地点不能为空');
                }
                
                if (!device.lastInspectionDate || !DateUtils.isValidDate(device.lastInspectionDate)) {
                    errors.push('上次检定日期无效');
                }
                
                if (!device.inspectionCycle || device.inspectionCycle < 1 || device.inspectionCycle > 60) {
                    errors.push('检定周期必须在1-60个月之间');
                }
                
                if (!device.conditions || device.conditions.length === 0) {
                    errors.push('至少需要一个巡检项目');
                }
                
                return errors;
            }
        };

        // ========== 初始化函数 ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，初始化应用');

            // 获取DOM元素
            devicesContainer = document.getElementById('devices-container');
            emptyState = document.getElementById('empty-state');
            addDeviceBtn = document.getElementById('add-device-btn');
            emptyAddBtn = document.getElementById('empty-add-btn');
            addDeviceModal = document.getElementById('add-device-modal');
            modalContent = document.getElementById('modal-content');
            closeModal = document.getElementById('close-modal');
            addDeviceForm = document.getElementById('add-device-form');
            conditionsContainer = document.getElementById('conditions-container');
            addConditionBtn = document.getElementById('add-condition-btn');
            cancelAddDevice = document.getElementById('cancel-add-device');
            remarkModal = document.getElementById('remark-modal');
            remarkModalContent = document.getElementById('remark-modal-content');
            closeRemarkModal = document.getElementById('close-remark-modal');
            remarkForm = document.getElementById('remark-form');
            conditionNameInput = document.getElementById('condition-name');
            remarkContentInput = document.getElementById('remark-content');
            cancelRemark = document.getElementById('cancel-remark');
            submitAddDeviceBtn = document.getElementById('submit-add-device');
            submitRemarkBtn = document.getElementById('submit-remark');
            refreshAllBtn = document.getElementById('refresh-all-btn');
            editDeviceModal = document.getElementById('edit-device-modal');
            editModalContent = document.getElementById('edit-modal-content');
            closeEditModal = document.getElementById('close-edit-modal');
            editDeviceForm = document.getElementById('edit-device-form');
            editDeviceIndexInput = document.getElementById('edit-device-index');
            editDeviceNameInput = document.getElementById('edit-device-name');
            editDeviceCategoryInput = document.getElementById('edit-device-category');
            editDeviceLocationInput = document.getElementById('edit-device-location');
            editDeviceModelInput = document.getElementById('edit-device-model');
            editDeviceManufacturerInput = document.getElementById('edit-device-manufacturer');
            editDeviceSerialNumberInput = document.getElementById('edit-device-serial-number');
            editDeviceRangeInput = document.getElementById('edit-device-range');
            editInspectionCycleInput = document.getElementById('edit-inspection-cycle');
            editLastInspectionDateInput = document.getElementById('edit-last-inspection-date');
            editConditionsContainer = document.getElementById('edit-conditions-container');
            editAddConditionBtn = document.getElementById('edit-add-condition-btn');
            deleteDeviceBtn = document.getElementById('delete-device-btn');
            cancelEditDevice = document.getElementById('cancel-edit-device');
            submitEditDeviceBtn = document.getElementById('submit-edit-device');
            inspectionRecordsContainer = document.getElementById('inspection-records');
            toggleAllRecordsBtn = document.getElementById('toggle-all-records');
            fileImportInput = document.getElementById('file-import');
            loadingIndicator = document.getElementById('loading-indicator');
            
            // 新增的导航元素
            navDeviceListBtn = document.getElementById('nav-device-list');
            navRecordsBtn = document.getElementById('nav-records');
            navProfileBtn = document.getElementById('nav-profile');
            deviceListPage = document.getElementById('device-list-page');
            inspectionRecordsPage = document.getElementById('inspection-records-page');
            profilePage = document.getElementById('profile-page');
            
            // 个人中心按钮
            profileExportBtn = document.getElementById('profile-export-btn');
            profileImportBtn = document.getElementById('profile-import-btn');
            profileDeleteAllBtn = document.getElementById('profile-delete-all-btn');
            
            // 顶部右侧按钮容器
            topRightButtons = document.getElementById('top-right-buttons');
            
            // 搜索输入框
            searchInput = document.getElementById('search-input');
            
            // 确认所有按钮
            confirmAllBtn = document.getElementById('confirm-all-btn');

            // 初始化管理器
            EventManager.init();
            UXManager.initOfflineDetection();

            // 从本地存储加载数据
            DataManager.loadDevices();
            
            // 检查是否需要每日重置
            checkAndResetDaily();
            
            renderDevices();
            renderInspectionRecords();

            // 事件监听
            addDeviceBtn.addEventListener('click', openAddDeviceModal);
            emptyAddBtn.addEventListener('click', openAddDeviceModal);
            closeModal.addEventListener('click', closeAddDeviceModal);
            cancelAddDevice.addEventListener('click', closeAddDeviceModal);
            submitAddDeviceBtn.addEventListener('click', handleAddDevice);
            addConditionBtn.addEventListener('click', addConditionField);

            closeRemarkModal.addEventListener('click', closeRemarkModalFunc);
            cancelRemark.addEventListener('click', closeRemarkModalFunc);
            submitRemarkBtn.addEventListener('click', handleRemarkSubmit);

            refreshAllBtn.addEventListener('click', function() {
                UXManager.showConfirm('确定要刷新所有设备的巡检状态吗？', '刷新所有设备').then(confirmed => {
                    if (confirmed) {
                        refreshAllDevices();
                    }
                });
            });
            
            // 确认所有按钮事件
            confirmAllBtn.addEventListener('click', function() {
                UXManager.showConfirm('确定要将当天所有设备的所有巡检项目状态全部更改为已巡检吗？', '确认所有设备').then(confirmed => {
                    if (confirmed) {
                        confirmAllDevices();
                    }
                });
            });

            closeEditModal.addEventListener('click', closeEditDeviceModal);
            cancelEditDevice.addEventListener('click', closeEditDeviceModal);
            deleteDeviceBtn.addEventListener('click', handleDeleteDevice);
            submitEditDeviceBtn.addEventListener('click', handleEditDevice);
            editAddConditionBtn.addEventListener('click', editAddConditionField);

            // 导入导出事件
            profileExportBtn.addEventListener('click', exportDevices);
            profileImportBtn.addEventListener('click', function() {
                fileImportInput.click();
            });
            
            // 删除所有设备事件
            profileDeleteAllBtn.addEventListener('click', deleteAllDevices);
            
            fileImportInput.addEventListener('change', handleFileImport);
            
            // 记录折叠事件
            toggleAllRecordsBtn.addEventListener('click', toggleAllRecords);

            console.log('应用初始化完成，所有事件监听器已绑定');
            
            // 申请文件权限
            requestFilePermission();
        });

        // ========== 核心功能函数 ==========

        // 切换页面
        function switchPage(pageId) {
            // 隐藏所有页面
            deviceListPage.classList.add('hidden');
            inspectionRecordsPage.classList.add('hidden');
            profilePage.classList.add('hidden');
            
            // 显示选中的页面
            document.getElementById(pageId).classList.remove('hidden');
            
            // 更新导航按钮状态
            navDeviceListBtn.classList.remove('active');
            navRecordsBtn.classList.remove('active');
            navProfileBtn.classList.remove('active');
            
            if (pageId === 'device-list-page') {
                navDeviceListBtn.classList.add('active');
                // 在设备列表页面显示顶部按钮
                topRightButtons.classList.remove('hidden');
            } else if (pageId === 'inspection-records-page') {
                navRecordsBtn.classList.add('active');
                // 在巡检记录页面隐藏顶部按钮
                topRightButtons.classList.add('hidden');
            } else if (pageId === 'profile-page') {
                navProfileBtn.classList.add('active');
                // 在个人中心页面隐藏顶部按钮
                topRightButtons.classList.add('hidden');
            }
        }

        // 检查并执行每日重置
        function checkAndResetDaily() {
            var today = getCurrentDate();
            var lastResetDate = localStorage.getItem('lastResetDate');
            
            // 如果是新的一天，重置所有设备状态
            if (lastResetDate !== today) {
                console.log('新的一天，重置所有设备状态');
                devices.forEach(function(device) {
                    device.conditions.forEach(function(condition) {
                        // 确保正确保存历史记录
                        if (!condition.history) {
                            condition.history = [];
                        }
                        
                        // 检查昨天是否有巡检记录需要保存
                        var yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        var yesterdayStr = yesterday.toISOString().split('T')[0];
                        
                        // 如果昨天有巡检记录且状态不是待巡检，保存到历史记录
                        if (condition.inspectionTime && condition.inspectionTime.startsWith(yesterdayStr) && condition.status !== 'pending') {
                            var historyRecord = {
                                date: yesterdayStr,
                                status: condition.status,
                                remark: condition.remark,
                                inspectionTime: condition.inspectionTime
                            };
                            
                            // 检查是否已经存在昨天的历史记录
                            var existingIndex = condition.history.findIndex(function(h) { return h.date === yesterdayStr; });
                            if (existingIndex !== -1) {
                                // 更新现有记录
                                condition.history[existingIndex] = historyRecord;
                            } else {
                                // 添加新记录
                                condition.history.push(historyRecord);
                            }
                        }
                        
                        // 重置当前状态为待巡检
                        condition.status = 'pending';
                        condition.remark = '';
                        condition.inspectionTime = '';
                    });
                });
                
                // 保存重置后的状态和新的重置日期
                DataManager.saveDevices();
                localStorage.setItem('lastResetDate', today);
                
                console.log('每日重置完成');
            }
        }

        // 渲染所有设备（支持搜索）- 添加防抖渲染
        const renderDevices = PerformanceManager.debounce(function() {
            console.log('开始渲染设备列表，共有 ' + devices.length + ' 个设备');
            
            // 过滤设备
            var filteredDevices = devices;
            if (searchTerm) {
                filteredDevices = devices.filter(function(device) { 
                    return device.name.toLowerCase().includes(searchTerm) || 
                        (device.serialNumber && device.serialNumber.toLowerCase().includes(searchTerm)) ||
                        (device.location && device.location.toLowerCase().includes(searchTerm));
                });
            }
            
            if (filteredDevices.length === 0) {
                if (searchTerm) {
                    devicesContainer.innerHTML = '<div class="no-results">未找到匹配的设备</div>';
                } else {
                    emptyState.classList.remove('hidden');
                    devicesContainer.classList.add('hidden');
                }
                console.log('设备列表为空，显示空状态');
                return;
            }

            emptyState.classList.add('hidden');
            devicesContainer.classList.remove('hidden');
            devicesContainer.innerHTML = '';

            filteredDevices.forEach(function(device, index) {
                // 获取原始设备索引（因为过滤后的索引可能不同）
                var originalIndex = devices.findIndex(function(d) { 
                    return d.id === device.id;
                });
                
                var deviceCard = createDeviceCard(device, originalIndex);
                devicesContainer.appendChild(deviceCard);
                
                // 默认折叠所有卡片，除了当前展开的卡片
                if (originalIndex !== expandedCardIndex) {
                    EventManager.setCardExpanded(deviceCard, false);
                } else {
                    // 确保展开的卡片也应用样式
                    EventManager.setCardExpanded(deviceCard, true);
                }
            });

            console.log('设备列表渲染完成');
        }, 50);

        // 创建设备卡片
        function createDeviceCard(device, index) {
            const status = StatusManager.getDeviceStatus(device);
            const lastInspection = StatusManager.getLastInspectionDisplay(device);
            const nextInspectionDate = DateUtils.getNextInspectionDate(device.lastInspectionDate, device.inspectionCycle);
            const isNearInspection = DateUtils.isWithinDays(nextInspectionDate, 10);

            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg overflow-hidden device-card-shadow hover:shadow-md transition-all duration-300 relative';
            card.dataset.deviceIndex = index;

            const inspectionInfo = `
                <span class="text-xs text-gray-600">上次检定: ${device.lastInspectionDate}</span><br>
                <span class="text-xs text-gray-600">周期: ${device.inspectionCycle} 月</span><br>
                <span class="text-xs ${isNearInspection ? 'text-red-500' : 'text-gray-600'}">下次检定: ${nextInspectionDate} ${isNearInspection ? '<i class="fa-solid fa-triangle-exclamation mr-1"></i>' : ''}</span>
            `;

            const miniInspectionInfo = isNearInspection ? `<span class="text-xs text-red-500">下次检定: ${nextInspectionDate} <i class="fa-solid fa-triangle-exclamation mr-1"></i></span>` : '';

            // 新的卡片结构
            card.innerHTML = `
                <!-- 蓝色进度遮罩层 - 只在折叠时显示 -->
                <div class="mini-progress-overlay" style="--progress: ${status.progress}%"></div>
                
                <div class="mini-card-content p-1">
                    <!-- 迷你卡片内容 - 始终显示 -->
                    <div class="flex justify-between items-start mb-0">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-bold text-dark truncate">${device.name}</h3>
                            <p class="text-gray-500 text-xs device-code">${device.location}</p>
                        </div>
                        <div class="flex items-center space-x-1 ml-2 flex-shrink-0">
                            <!-- 上次巡检时间 -->
                            <div class="text-right ${lastInspection.colorClass} whitespace-nowrap mr-1">
                                <div class="text-xs leading-none">${lastInspection.time}</div>
                                <div class="text-xs leading-none">${lastInspection.date}</div>
                            </div>
                            <button class="refresh-device text-dark bg-white/80 hover:bg-white rounded-full p-1 transition-colors fixed-size-btn touch-button" title="刷新设备状态">
                                <i class="fa-solid fa-rotate text-xs"></i>
                            </button>
                            <button class="edit-device text-dark bg-white/80 hover:bg-white rounded-full p-1 transition-colors fixed-size-btn touch-button" title="编辑设备信息">
                                <i class="fa-solid fa-pen text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 检定日期提醒 - 只在折叠时显示 -->
                    <div class="mini-inspection-info ${isNearInspection ? '' : 'hidden'}">
                        ${miniInspectionInfo}
                    </div>
                    
                    <!-- 展开卡片内容 - 只在展开时显示 -->
                    <div class="expanded-content hidden">
                        <!-- 设备基本信息网格 -->
                        <div class="device-info-grid mb-2">
                            <div class="device-info-label">类别:</div>
                            <div class="device-info-value">${device.category}</div>
                            
                            <div class="device-info-label">出厂编号:</div>
                            <div class="device-info-value">${device.serialNumber || '无'}</div>
                            
                            <div class="device-info-label">规格型号:</div>
                            <div class="device-info-value">${device.model || '无'}</div>
                            
                            <div class="device-info-label">生产厂家:</div>
                            <div class="device-info-value">${device.manufacturer || '无'}</div>
                            
                            <div class="device-info-label">测量范围:</div>
                            <div class="device-info-value">${device.range || '无'}</div>
                        </div>
                        
                        <div class="mb-2 progress-container">
                            <div class="flex justify-between text-xs mb-0.5 progress-text">
                                <span class="text-gray-600">巡检进度</span>
                                <span class="font-medium">${status.progress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="bg-primary h-1.5 rounded-full" style="width: ${status.progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between space-x-1 mb-2 status-container">
                            <div class="bg-green-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-normal"></div>
                                <span class="text-xs text-gray-700">${status.normal}</span>
                            </div>
                            <div class="bg-red-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-abnormal"></div>
                                <span class="text-xs text-gray-700">${status.abnormal}</span>
                            </div>
                            <div class="bg-gray-50 rounded-lg px-1.5 py-0.5 flex items-center flex-shrink-0">
                                <div class="status-indicator status-pending"></div>
                                <span class="text-xs text-gray-700">${status.pending}</span>
                            </div>
                        </div>

                        <div class="mb-2 inspection-info">
                            ${inspectionInfo}
                        </div>
                        
                        <div class="space-y-1 conditions-container">
                            ${device.conditions.map(function(condition, condIndex) {
                                const display = StatusManager.getConditionDisplay(condition);
                                
                                return `
                                <div class="condition-item p-1.5 ${display.className} border ${display.borderColor}" 
                                    data-index="${condIndex}">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <div class="status-indicator ${display.statusClass}"></div>
                                            <span class="text-xs ${display.textColor} ${display.status === 'abnormal' ? 'font-medium' : ''}">${condition.name}</span>
                                        </div>
                                        <div class="flex items-center">
                                            ${display.status === 'abnormal' ? `<span class="text-xs bg-red-100 text-red-800 px-1 py-0.5 rounded-full mr-1">异常</span>` : ''}
                                            ${display.timeDisplay ? `<span class="text-xs text-gray-500">${display.timeDisplay}</span>` : ''}
                                        </div>
                                    </div>
                                    ${display.status === 'abnormal' ? `<p class="text-xs text-red-600 mt-0.5 line-clamp-1"><i class="fa-solid fa-comment mr-0.5"></i>${condition.remark}</p>` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // 打开添加设备模态框
        function openAddDeviceModal() {
            console.log('打开添加设备模态框');

            // 重置表单
            addDeviceForm.reset();
            conditionsContainer.innerHTML = '';
            addConditionField();

            // 显示模态框
            addDeviceModal.classList.remove('hidden');
            setTimeout(function() {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            // 聚焦到设备名称输入框
            document.getElementById('device-name').focus();
        }

        // 关闭添加设备模态框
        function closeAddDeviceModal() {
            console.log('关闭添加设备模态框');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                addDeviceModal.classList.add('hidden');
            }, 300);
        }

        // 添加条件字段
        function addConditionField() {
            var conditionsCount = conditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加新的巡检项目字段，当前数量:', conditionsCount + 1);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            conditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }
        
        // 添加预设条件
        function addPresetCondition(condition) {
            var conditionsCount = conditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加预设巡检项目:', condition);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text" value="${condition}"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            conditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }

        // 打开异常备注模态框
        function openRemarkModal(conditionName) {
            console.log('打开异常备注模态框');

            conditionNameInput.value = conditionName;
            remarkContentInput.value = '';

            remarkModal.classList.remove('hidden');
            setTimeout(function() {
                remarkModalContent.classList.remove('scale-95', 'opacity-0');
                remarkModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭异常备注模态框
        function closeRemarkModalFunc() {
            console.log('关闭异常备注模态框');

            remarkModalContent.classList.remove('scale-100', 'opacity-100');
            remarkModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                remarkModal.classList.add('hidden');
            }, 300);
        }

        // 处理异常备注提交
        function handleRemarkSubmit() {
            console.log('提交异常备注');

            var remark = remarkContentInput.value;
            if (remark) {
                devices[currentDeviceId].conditions[currentConditionIndex].remark = remark;
                DataManager.saveDevices();
                EventManager.refreshUI();
                closeRemarkModalFunc();
                UXManager.showOperationFeedback('异常备注已保存', 'success');
            } else {
                showError('请输入异常描述', 'remark-content-error');
            }
        }

        // 刷新所有当日设备
        function refreshAllDevices() {
            console.log('刷新所有当日设备的巡检状态');
            
            const today = getCurrentDate();
            let refreshCount = 0;

            devices.forEach((device, deviceIndex) => {
                device.conditions.forEach((condition, conditionIndex) => {
                    if (condition.inspectionTime && condition.inspectionTime.startsWith(today)) {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'pending', '');
                        refreshCount++;
                    }
                });
            });

            EventManager.refreshUI();
            UXManager.showOperationFeedback(`已刷新 ${refreshCount} 个巡检项目的状态`, 'success');
        }
        
        // 确认所有设备
        function confirmAllDevices() {
            console.log('确认所有设备的所有巡检项目');
            
            const today = getCurrentDate();
            let confirmCount = 0;

            devices.forEach((device, deviceIndex) => {
                device.conditions.forEach((condition, conditionIndex) => {
                    if (!condition.inspectionTime || !condition.inspectionTime.startsWith(today)) {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'normal', '');
                        confirmCount++;
                    } else if (condition.inspectionTime.startsWith(today) && condition.status === 'abnormal') {
                        DataManager.updateCondition(deviceIndex, conditionIndex, 'normal', '');
                        confirmCount++;
                    }
                });
            });

            EventManager.refreshUI();
            UXManager.showOperationFeedback(`已确认 ${confirmCount} 个巡检项目的状态`, 'success');
        }

        // 打开编辑设备模态框
        function openEditDeviceModal(index) {
            console.log('打开编辑设备模态框');

            var device = devices[index];
            
            editDeviceIndexInput.value = index;
            editDeviceNameInput.value = device.name;
            editDeviceCategoryInput.value = device.category;
            editDeviceLocationInput.value = device.location;
            editDeviceModelInput.value = device.model || '';
            editDeviceManufacturerInput.value = device.manufacturer || '';
            editDeviceSerialNumberInput.value = device.serialNumber || '';
            editDeviceRangeInput.value = device.range || '';
            editInspectionCycleInput.value = device.inspectionCycle;
            editLastInspectionDateInput.value = device.lastInspectionDate;

            editConditionsContainer.innerHTML = '';
            device.conditions.forEach(function(condition) {
                var conditionItem = document.createElement('div');
                conditionItem.className = 'condition-item mb-3 flex items-center';
                conditionItem.innerHTML = `
                    <input type="text" value="${condition.name}"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                        required>
                    <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                        <i class="fa-solid fa-minus-circle"></i>
                    </button>
                `;
                editConditionsContainer.appendChild(conditionItem);

                var removeBtn = conditionItem.querySelector('.remove-condition');
                removeBtn.addEventListener('click', function() {
                    conditionItem.remove();
                });
            });

            editDeviceModal.classList.remove('hidden');
            setTimeout(function() {
                editModalContent.classList.remove('scale-95', 'opacity-0');
                editModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭编辑设备模态框
        function closeEditDeviceModal() {
            console.log('关闭编辑设备模态框');

            editModalContent.classList.remove('scale-100', 'opacity-100');
            editModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(function() {
                editDeviceModal.classList.add('hidden');
            }, 300);
        }

        // 处理添加设备
        function handleAddDevice() {
            console.log('处理添加设备');

            // 清除之前的错误信息
            clearErrors();

            var deviceName = document.getElementById('device-name').value;
            var deviceCategory = document.getElementById('device-category').value;
            var deviceLocation = document.getElementById('device-location').value;
            var deviceModel = document.getElementById('device-model').value;
            var deviceManufacturer = document.getElementById('device-manufacturer').value;
            var deviceSerialNumber = document.getElementById('device-serial-number').value;
            var deviceRange = document.getElementById('device-range').value;
            var inspectionCycle = parseInt(document.getElementById('inspection-cycle').value);
            var lastInspectionDate = document.getElementById('last-inspection-date').value;

            var conditionInputs = conditionsContainer.querySelectorAll('input[type="text"]');
            var conditions = [];
            conditionInputs.forEach(function(input) {
                if (input.value) {
                    conditions.push(input.value);
                }
            });

            // 验证表单
            var isValid = true;
            
            if (!deviceName) {
                showError('请输入计量器具名称', 'device-name-error');
                isValid = false;
            }
            
            if (!deviceCategory) {
                showError('请选择类别', 'device-category-error');
                isValid = false;
            }
            
            if (!deviceLocation) {
                showError('请输入安装地点', 'device-location-error');
                isValid = false;
            }
            
            if (!inspectionCycle || inspectionCycle < 1 || inspectionCycle > 60) {
                showError('请输入有效的检定周期（1-60个月）', 'inspection-cycle-error');
                isValid = false;
            }
            
            if (!lastInspectionDate) {
                showError('请选择上次检定日期', 'last-inspection-date-error');
                isValid = false;
            }
            
            if (conditions.length === 0) {
                showError('请至少添加一个巡检项目', 'conditions-error');
                isValid = false;
            }

            if (isValid) {
                var deviceData = {
                    id: DataManager.generateDeviceId(),
                    name: deviceName,
                    category: deviceCategory,
                    location: deviceLocation,
                    model: deviceModel,
                    manufacturer: deviceManufacturer,
                    serialNumber: deviceSerialNumber,
                    range: deviceRange,
                    lastInspectionDate: lastInspectionDate,
                    inspectionCycle: inspectionCycle,
                    conditions: conditions.map(function(condition) {
                        return {
                            id: DataManager.generateConditionId(),
                            name: condition,
                            status: 'pending',
                            remark: '',
                            inspectionTime: '',
                            history: []
                        };
                    }),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                devices.push(deviceData);
                DataManager.saveDevices();
                EventManager.refreshUI();
                closeAddDeviceModal();
                
                UXManager.showOperationFeedback('设备添加成功', 'success');
            }
        }

        // 处理编辑设备
        function handleEditDevice() {
            console.log('处理编辑设备');

            // 清除之前的错误信息
            clearErrors();

            var index = parseInt(editDeviceIndexInput.value);
            var deviceName = editDeviceNameInput.value;
            var deviceCategory = editDeviceCategoryInput.value;
            var deviceLocation = editDeviceLocationInput.value;
            var deviceModel = editDeviceModelInput.value;
            var deviceManufacturer = editDeviceManufacturerInput.value;
            var deviceSerialNumber = editDeviceSerialNumberInput.value;
            var deviceRange = editDeviceRangeInput.value;
            var inspectionCycle = parseInt(editInspectionCycleInput.value);
            var lastInspectionDate = editLastInspectionDateInput.value;

            var conditionInputs = editConditionsContainer.querySelectorAll('input[type="text"]');
            var conditions = [];
            conditionInputs.forEach(function(input) {
                if (input.value) {
                    conditions.push(input.value);
                }
            });

            // 验证表单
            var isValid = true;
            
            if (!deviceName) {
                showError('请输入计量器具名称', 'edit-device-name-error');
                isValid = false;
            }
            
            if (!deviceCategory) {
                showError('请选择类别', 'edit-device-category-error');
                isValid = false;
            }
            
            if (!deviceLocation) {
                showError('请输入安装地点', 'edit-device-location-error');
                isValid = false;
            }
            
            if (!inspectionCycle || inspectionCycle < 1 || inspectionCycle > 60) {
                showError('请输入有效的检定周期（1-60个月）', 'edit-inspection-cycle-error');
                isValid = false;
            }
            
            if (!lastInspectionDate) {
                showError('请选择上次检定日期', 'edit-last-inspection-date-error');
                isValid = false;
            }
            
            if (conditions.length === 0) {
                showError('请至少添加一个巡检项目', 'edit-conditions-error');
                isValid = false;
            }

            if (isValid) {
                var deviceData = {
                    id: devices[index].id,
                    name: deviceName,
                    category: deviceCategory,
                    location: deviceLocation,
                    model: deviceModel,
                    manufacturer: deviceManufacturer,
                    serialNumber: deviceSerialNumber,
                    range: deviceRange,
                    lastInspectionDate: lastInspectionDate,
                    inspectionCycle: inspectionCycle,
                    conditions: conditions.map(function(condition, i) {
                        // 保留原有的条件ID（如果存在）或生成新的
                        const existingCondition = devices[index].conditions[i];
                        return {
                            id: existingCondition ? existingCondition.id : DataManager.generateConditionId(),
                            name: condition,
                            status: existingCondition ? existingCondition.status : 'pending',
                            remark: existingCondition ? existingCondition.remark : '',
                            inspectionTime: existingCondition ? existingCondition.inspectionTime : '',
                            history: existingCondition ? existingCondition.history : []
                        };
                    }),
                    createdAt: devices[index].createdAt,
                    updatedAt: new Date().toISOString()
                };

                devices[index] = deviceData;
                DataManager.saveDevices();
                EventManager.refreshUI();
                closeEditDeviceModal();
                
                UXManager.showOperationFeedback('设备编辑成功', 'success');
            }
        }

        // 处理删除设备
        function handleDeleteDevice() {
            console.log('处理删除设备');

            var index = parseInt(editDeviceIndexInput.value);
            
            UXManager.showConfirm(`确定要删除设备 "${devices[index].name}" 吗？此操作无法撤销！`, '删除设备').then(confirmed => {
                if (confirmed) {
                    var deviceName = devices[index].name;
                    devices.splice(index, 1);
                    DataManager.saveDevices();
                    EventManager.refreshUI();
                    closeEditDeviceModal();
                    
                    UXManager.showOperationFeedback(`设备 "${deviceName}" 已删除`, 'success');
                }
            });
        }

        // 添加编辑条件字段
        function editAddConditionField() {
            var conditionsCount = editConditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加新的编辑巡检项目字段，当前数量:', conditionsCount + 1);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            editConditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }
        
        // 编辑模态框添加预设条件
        function editAddPresetCondition(condition) {
            var conditionsCount = editConditionsContainer.querySelectorAll('.condition-item').length;

            if (conditionsCount >= 5) {
                alert('最多只能添加5个巡检项目');
                return;
            }

            console.log('添加编辑预设巡检项目:', condition);

            var conditionItem = document.createElement('div');
            conditionItem.className = 'condition-item mb-3 flex items-center';
            conditionItem.innerHTML = `
                <input type="text" value="${condition}"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    required>
                <button type="button" class="remove-condition ml-2 text-gray-400 hover:text-red-500 fixed-size-btn touch-button">
                    <i class="fa-solid fa-minus-circle"></i>
                </button>
            `;
            editConditionsContainer.appendChild(conditionItem);

            var removeBtn = conditionItem.querySelector('.remove-condition');
            removeBtn.addEventListener('click', function() {
                conditionItem.remove();
            });
        }

        // 获取当前日期和时间
        function getCurrentDateTime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var hours = String(now.getHours()).padStart(2, '0');
            var minutes = String(now.getMinutes()).padStart(2, '0');
            var seconds = String(now.getSeconds()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        // 获取当前日期（仅日期部分）
        function getCurrentDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        // 获取下一个检定日期
        function getNextInspectionDate(lastInspectionDate, inspectionCycle) {
            return DateUtils.getNextInspectionDate(lastInspectionDate, inspectionCycle);
        }

        // 判断是否在10天内
        function isWithinTenDays(dateStr) {
            return DateUtils.isWithinDays(dateStr, 10);
        }

        // 统一的巡检记录渲染
        const renderInspectionRecords = PerformanceManager.debounce(function() {
            console.log('开始渲染巡检记录 - 使用统一状态管理');

            inspectionRecordsContainer.innerHTML = '';
            if (devices.length === 0) {
                inspectionRecordsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">暂无巡检记录</div>';
                return;
            }

            // 收集所有记录 - 使用统一的状态管理
            const allRecords = [];
            const processedRecords = new Set();
            const today = getCurrentDate();

            devices.forEach(device => {
                const deviceStatus = StatusManager.getDeviceStatus(device);
                
                // 收集历史记录
                device.conditions.forEach(condition => {
                    if (condition.history && condition.history.length > 0) {
                        condition.history.forEach(record => {
                            const recordKey = `${device.id}-${condition.id}-${record.date}-${record.inspectionTime}`;
                            if (!processedRecords.has(recordKey)) {
                                allRecords.push({
                                    device: device,
                                    condition: condition,
                                    date: record.date,
                                    status: record.status,
                                    remark: record.remark,
                                    inspectionTime: record.inspectionTime
                                });
                                processedRecords.add(recordKey);
                            }
                        });
                    }

                    // 收集当天记录
                    if (condition.inspectionTime && condition.inspectionTime.startsWith(today) && condition.status !== 'pending') {
                        const recordKey = `${device.id}-${condition.id}-${today}-${condition.inspectionTime}`;
                        if (!processedRecords.has(recordKey)) {
                            allRecords.push({
                                device: device,
                                condition: condition,
                                date: today,
                                status: condition.status,
                                remark: condition.remark,
                                inspectionTime: condition.inspectionTime
                            });
                            processedRecords.add(recordKey);
                        }
                    }
                });
            });

            // 按日期分组
            const recordsByDate = {};
            allRecords.forEach(record => {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            });

            // 按日期排序
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                inspectionRecordsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">暂无巡检记录</div>';
                return;
            }

            // 渲染每个日期的记录
            sortedDates.forEach(date => {
                // 初始化展开状态
                if (expandedDates[date] === undefined) {
                    const today = getCurrentDate();
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    expandedDates[date] = (date === today || date === yesterdayStr);
                }

                const dateDiv = document.createElement('div');
                dateDiv.className = 'mb-6';
                
                // 日期标题
                const dateHeader = document.createElement('div');
                dateHeader.className = 'record-date';
                dateHeader.innerHTML = `
                    <span>${formatDisplayDate(date)}</span>
                    <i class="fa-solid ${expandedDates[date] ? 'fa-angle-down' : 'fa-angle-right'}"></i>
                `;
                
                dateHeader.addEventListener('click', () => {
                    expandedDates[date] = !expandedDates[date];
                    renderInspectionRecords();
                });
                
                dateDiv.appendChild(dateHeader);
                
                // 记录容器
                const recordsDiv = document.createElement('div');
                recordsDiv.className = `space-y-3 ${expandedDates[date] ? '' : 'hidden'}`;
                
                // 使用统一状态管理计算进度
                const dateRecords = recordsByDate[date] || [];
                const dateDevices = new Set(dateRecords.map(record => record.device.id));
                
                let completedDevices = 0;
                dateDevices.forEach(deviceId => {
                    const device = devices.find(d => d.id === deviceId);
                    if (device) {
                        const status = StatusManager.getDeviceStatus(device);
                        // 检查该设备在指定日期的完成情况
                        const deviceDateRecords = dateRecords.filter(record => 
                            record.device.id === deviceId
                        );
                        const completedConditions = new Set(deviceDateRecords.map(record => record.condition.id));
                        
                        if (completedConditions.size === device.conditions.length) {
                            completedDevices++;
                        }
                    }
                });
                
                const totalDevices = devices.length;
                const progressPercent = totalDevices > 0 ? Math.round((completedDevices / totalDevices) * 100) : 0;
                
                // 进度条
                const progressBarHtml = `
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">当日巡检进度</span>
                            <span class="font-medium">${progressPercent}% (${completedDevices}/${totalDevices})</span>
                        </div>
                        <div class="date-progress-bar">
                            <div class="date-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `;
                
                recordsDiv.innerHTML = progressBarHtml;
                
                // 按设备分组渲染
                const recordsByDevice = {};
                dateRecords.forEach(record => {
                    const deviceId = record.device.id;
                    if (!recordsByDevice[deviceId]) {
                        recordsByDevice[deviceId] = {
                            device: record.device,
                            conditions: {},
                            latestTime: ''
                        };
                    }
                    
                    recordsByDevice[deviceId].conditions[record.condition.id] = {
                        status: record.status,
                        remark: record.remark,
                        inspectionTime: record.inspectionTime
                    };
                    
                    if (record.inspectionTime) {
                        const time = record.inspectionTime.split(' ')[1] ? record.inspectionTime.split(' ')[1].substr(0, 5) : '';
                        if (time > recordsByDevice[deviceId].latestTime) {
                            recordsByDevice[deviceId].latestTime = time;
                        }
                    }
                });
                
                // 渲染每个设备的记录
                Object.values(recordsByDevice).forEach(record => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.className = 'bg-white rounded-lg p-3 shadow-sm';
                    
                    const deviceHeader = document.createElement('div');
                    deviceHeader.className = 'flex justify-between items-center mb-2';
                    deviceHeader.innerHTML = `
                        <span class="font-medium">${record.device.name} <span class="text-gray-500 text-sm">${record.device.location || ''}</span></span>
                        ${record.latestTime ? `<span class="text-gray-500 text-xs">${record.latestTime}</span>` : ''}
                    `;
                    deviceDiv.appendChild(deviceHeader);
                    
                    const conditionsDiv = document.createElement('div');
                    conditionsDiv.className = 'flex flex-wrap gap-1.5';
                    
                    // 使用统一的状态显示
                    record.device.conditions.forEach(deviceCondition => {
                        const conditionRecord = record.conditions[deviceCondition.id];
                        const status = conditionRecord ? conditionRecord.status : 'pending';
                        const display = StatusManager.getConditionDisplay({
                            ...deviceCondition,
                            status: status,
                            inspectionTime: conditionRecord ? conditionRecord.inspectionTime : ''
                        });
                        
                        const conditionItem = document.createElement('div');
                        conditionItem.className = `flex items-center px-2 py-1 rounded-full text-xs ${display.className} ${display.textColor}`;
                        conditionItem.innerHTML = `
                            <div class="status-indicator ${display.statusClass}"></div>
                            ${deviceCondition.name}
                        `;
                        
                        if (status === 'abnormal' && conditionRecord && conditionRecord.remark) {
                            conditionItem.title = '异常描述: ' + conditionRecord.remark;
                        }
                        
                        conditionsDiv.appendChild(conditionItem);
                    });
                    
                    deviceDiv.appendChild(conditionsDiv);
                    recordsDiv.appendChild(deviceDiv);
                });
                
                dateDiv.appendChild(recordsDiv);
                inspectionRecordsContainer.appendChild(dateDiv);
            });

            console.log('巡检记录渲染完成 - 使用统一状态管理');
        }, 50);
        
        // 格式化显示日期
        function formatDisplayDate(dateStr) {
            var today = getCurrentDate();
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            var yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (dateStr === today) {
                return '今天';
            } else if (dateStr === yesterdayStr) {
                return '昨天';
            } else {
                var date = new Date(dateStr);
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                return date.getFullYear() + '-' + month + '-' + day;
            }
        }
        
        // 切换所有记录折叠状态
        function toggleAllRecords() {
            var allExpanded = Object.values(expandedDates).every(function(val) { return val; });
            
            Object.keys(expandedDates).forEach(function(date) {
                expandedDates[date] = !allExpanded;
            });
            
            renderInspectionRecords();
        }
        
        // 导出设备数据
        function exportDevices() {
            if (devices.length === 0) {
                UXManager.showOperationFeedback('没有设备数据可导出', 'error');
                return;
            }
            
            var exportText = '计量器具名称,类别,安装地点,规格型号,生产厂家,出厂编号,检定周期(月),测量范围,上次检定日期,巡检项目\n';
            
            devices.forEach(function(device) {
                var conditions = device.conditions.map(function(c) { return c.name; }).join(';');
                exportText += device.name + ',' + device.category + ',' + device.location + ',' + (device.model || '') + ',' + (device.manufacturer || '') + ',' + (device.serialNumber || '') + ',' + device.inspectionCycle + ',' + (device.range || '') + ',' + device.lastInspectionDate + ',' + conditions + '\n';
            });
            
            var blob = new Blob([exportText], {type: 'text/plain;charset=utf-8'});
            var url = URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = '巡检助手数据_' + new Date().toISOString().split('T')[0] + '.txt';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(function() {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            console.log('设备数据导出成功');
            UXManager.showOperationFeedback('数据导出成功', 'success');
        }
        
        // 处理文件导入
        function handleFileImport(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            showLoading('正在导入数据...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var content = e.target.result;
                    var lines = content.split('\n').filter(function(line) { return line.trim() !== ''; });
                    
                    // 移除标题行
                    if (lines[0].includes('计量器具名称')) {
                        lines.shift();
                    }
                    
                    var newDevices = [];
                    
                    lines.forEach(function(line) {
                        var parts = line.split(',');
                        if (parts.length < 10) return;
                        
                        var name = parts[0];
                        var category = parts[1];
                        var location = parts[2];
                        var model = parts[3];
                        var manufacturer = parts[4];
                        var serialNumber = parts[5];
                        var inspectionCycle = parts[6];
                        var range = parts[7];
                        var lastInspectionDate = parts[8];
                        var conditionStr = parts[9];
                        
                        var conditions = conditionStr.split(';').map(function(name) {
                            return {
                                id: DataManager.generateConditionId(),
                                name: name.trim(),
                                status: 'pending',
                                remark: '',
                                inspectionTime: '',
                                history: []
                            };
                        });
                        
                        newDevices.push({
                            id: DataManager.generateDeviceId(),
                            name: name.trim(),
                            category: category.trim(),
                            location: location.trim(),
                            model: model.trim(),
                            manufacturer: manufacturer.trim(),
                            serialNumber: serialNumber.trim(),
                            range: range.trim(),
                            lastInspectionDate: lastInspectionDate.trim(),
                            inspectionCycle: parseInt(inspectionCycle.trim()),
                            conditions: conditions,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    });
                    
                    if (newDevices.length > 0) {
                        devices = newDevices;
                        DataManager.saveDevices();
                        EventManager.refreshUI();
                        hideLoading();
                        UXManager.showOperationFeedback('成功导入 ' + newDevices.length + ' 个设备数据', 'success');
                    } else {
                        hideLoading();
                        UXManager.showOperationFeedback('导入失败：未找到有效设备数据', 'error');
                    }
                } catch (error) {
                    console.error('导入数据失败:', error);
                    hideLoading();
                    UXManager.showOperationFeedback('导入失败：文件格式不正确', 'error');
                }
            };
            
            reader.onerror = function() {
                hideLoading();
                UXManager.showOperationFeedback('文件读取失败，请重试', 'error');
            };
            
            reader.readAsText(file);
            event.target.value = ''; // 重置input
        }

        // 删除所有设备
        function deleteAllDevices() {
            if (devices.length === 0) {
                UXManager.showOperationFeedback('当前没有设备数据可删除', 'error');
                return;
            }
            
            UXManager.showConfirm(`警告：您即将删除所有设备数据（共 ${devices.length} 个设备）！\n\n此操作不可恢复，请确认是否继续？`, '删除所有设备').then(confirmed => {
                if (confirmed) {
                    // 执行删除
                    devices = [];
                    DataManager.saveDevices();
                    EventManager.refreshUI();

                    // 重置展开状态
                    expandedCardIndex = -1;
                    expandedDates = {};

                    UXManager.showOperationFeedback('所有设备数据已成功删除！', 'success');
                    console.log('所有设备数据已删除');
                }
            });
        }

        // 为Android移植准备的文件访问权限申请
        function requestFilePermission() {
            // 在Android环境中，这里会调用原生API申请文件权限
            console.log('申请文件访问权限...');
            
            // 检查是否在Android WebView中
            if (window.AndroidInterface && typeof window.AndroidInterface.requestFilePermission === 'function') {
                window.AndroidInterface.requestFilePermission();
            } else {
                console.log('非Android环境，跳过文件权限申请');
            }
        }

        // 显示加载指示器
        function showLoading(message) {
            if (loadingIndicator) {
                var messageEl = loadingIndicator.querySelector('span');
                if (message && messageEl) {
                    messageEl.textContent = message;
                }
                loadingIndicator.classList.remove('hidden');
            }
        }

        // 隐藏加载指示器
        function hideLoading() {
            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }
        }

        // 显示错误信息
        function showError(message, elementId) {
            if (elementId) {
                var errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            } else {
                UXManager.showOperationFeedback(message, 'error');
            }
        }

        // 显示成功信息
        function showSuccess(message) {
            UXManager.showOperationFeedback(message, 'success');
        }

        // 清除所有错误信息
        function clearErrors() {
            var errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(function(el) {
                el.textContent = '';
                el.classList.add('hidden');
            });
        }
    </script>
</body>
</html>